!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@angular/core"),require("@angular/common"),require("geodesy"),require("util"),require("rxjs/operators"),require("rxjs"),require("primitive-primitives"),require("json-string-mapper"),require("angular2parse"),require("lodash.get"),require("heatmap.js/build/heatmap.js")):"function"==typeof define&&define.amd?define("angular-cesium",["exports","@angular/core","@angular/common","geodesy","util","rxjs/operators","rxjs","primitive-primitives","json-string-mapper","angular2parse","lodash.get","heatmap.js/build/heatmap.js"],e):e((t=t||self)["angular-cesium"]={},t.ng.core,t.ng.common,t.geodesy,t.util,t.rxjs.operators,t.rxjs,t.primitivePrimitives,t.jsonStringMapper,t.angular2parse,t._get,t.h337)}(this,function(t,e,i,n,o,r,s,a,p,c,l,u){"use strict";var d=function(t,e){return(d=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)};function h(t,e){function i(){this.constructor=t}d(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var y=function(){return(y=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var o in e=arguments[i])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function f(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,o,r=i.call(t),s=[];try{for(;(void 0===e||e-- >0)&&!(n=r.next()).done;)s.push(n.value)}catch(t){o={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(o)throw o.error}}return s}function m(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(f(arguments[e]));return t}var g=function(){function t(){this.cesium=Cesium}return t.prototype.createViewer=function(t,e){return e?new this.cesium.Viewer(t,y({contextOptions:{webgl:{preserveDrawingBuffer:!0}}},e)):new this.cesium.Viewer(t,{contextOptions:{webgl:{preserveDrawingBuffer:!0}}})},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var v=function(){function t(){this.nextViewerOptionsIndex=0,this.nextViewerModifierIndex=0}return Object.defineProperty(t.prototype,"viewerOptions",{get:function(){return this._viewerOptions},set:function(t){this._viewerOptions=t},enumerable:!0,configurable:!0}),t.prototype.getNextViewerOptions=function(){return this._viewerOptions instanceof Array?this._viewerOptions[this.nextViewerOptionsIndex++]:this._viewerOptions},Object.defineProperty(t.prototype,"viewerModifier",{get:function(){return this._viewerModifier},set:function(t){this._viewerModifier=t},enumerable:!0,configurable:!0}),t.prototype.getNextViewerModifier=function(){return this._viewerModifier instanceof Array?this._viewerModifier[this.nextViewerModifierIndex++]:this._viewerModifier},t.decorators=[{type:e.Injectable}],t}();var P=function(){function t(t,e,i){this.ngZone=t,this.viewerFactory=e,this.viewerConfiguration=i}return t.prototype.init=function(t,e){var i=this;this.map=e,this.ngZone.runOutsideAngular(function(){var e=i.viewerConfiguration?i.viewerConfiguration.getNextViewerOptions():void 0;i.cesiumViewer=i.viewerFactory.createViewer(t,e);var n=i.viewerConfiguration&&i.viewerConfiguration.getNextViewerModifier();"function"==typeof n&&n(i.cesiumViewer)})},t.prototype.getViewer=function(){return this.cesiumViewer},t.prototype.getScene=function(){return this.cesiumViewer.scene},t.prototype.getCanvas=function(){return this.cesiumViewer.canvas},t.prototype.getMap=function(){return this.map},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:e.NgZone},{type:g},{type:v,decorators:[{type:e.Optional}]}]},t}();var b=Cesium.AssociativeArray,E=Cesium.Color,C=Cesium.ColorGeometryInstanceAttribute,_=Cesium.defined,S=Cesium.DistanceDisplayCondition,I=Cesium.DistanceDisplayConditionGeometryInstanceAttribute,T=Cesium.ShowGeometryInstanceAttribute,D=Cesium.Primitive,M=Cesium.ShadowMode,A=Cesium.BoundingSphereState,w=Cesium.ColorMaterialProperty,L=Cesium.MaterialProperty,O=Cesium.Property,R=new E,x=new S,N=new S;function j(t,e,i,n,o,r,s){var a;this.translucent=e,this.appearanceType=i,this.depthFailAppearanceType=n,this.depthFailMaterialProperty=o,this.depthFailMaterial=void 0,this.closed=r,this.shadows=s,this.primitives=t,this.createPrimitive=!1,this.waitingOnCreate=!1,this.primitive=void 0,this.oldPrimitive=void 0,this.geometry=new b,this.updaters=new b,this.updatersWithAttributes=new b,this.attributes=new b,this.subscriptions=new b,this.showsUpdated=new b,this.itemsToRemove=[],this.invalidated=!1,_(o)&&(a=o.definitionChanged.addEventListener(j.prototype.onMaterialChanged,this)),this.removeMaterialSubscription=a}j.prototype.onMaterialChanged=function(){this.invalidated=!0},j.prototype.isMaterial=function(t){var e=this.depthFailMaterialProperty,i=t.depthFailMaterialProperty;return i===e||!!_(e)&&e.equals(i)},j.prototype.add=function(t,e){var i=t.id;if(this.createPrimitive=!0,this.geometry.set(i,e),this.updaters.set(i,t),t.hasConstantFill&&t.fillMaterialProperty.isConstant&&O.isConstant(t.distanceDisplayConditionProperty)){var n=this;this.subscriptions.set(i,t.entity.definitionChanged.addEventListener(function(e,i,o,r){"isShowing"===i&&n.showsUpdated.set(t.id,t)}))}else this.updatersWithAttributes.set(i,t)},j.prototype.remove=function(t){var e=t.id;if(this.createPrimitive=this.geometry.remove(e)||this.createPrimitive,this.updaters.remove(e)){this.updatersWithAttributes.remove(e);var i=this.subscriptions.get(e);_(i)&&(i(),this.subscriptions.remove(e))}},j.prototype.update=function(t){var e,i,n=!0,o=0,r=this.primitive,s=this.primitives;if(this.createPrimitive){var a=this.geometry.values,p=a.length;if(p>0){for(_(r)&&(_(this.oldPrimitive)?s.remove(r):this.oldPrimitive=r),i=0;i<p;i++){var c=a[i],l=c.attributes;e=this.attributes.get(c.id.id),_(e)&&(_(l.show)&&(l.show.value=e.show),_(l.color)&&(l.color.value=e.color),_(l.depthFailColor)&&(l.depthFailColor.value=e.depthFailColor))}var u;_(this.depthFailAppearanceType)&&(_(this.depthFailMaterialProperty)&&(this.depthFailMaterial=L.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial)),u=new this.depthFailAppearanceType({material:this.depthFailMaterial,translucent:this.translucent,closed:this.closed})),r=new D({show:!1,asynchronous:!0,geometryInstances:a,appearance:new this.appearanceType({flat:this.shadows===M.DISABLED||this.shadows===M.CAST_ONLY,translucent:this.translucent,closed:this.closed}),depthFailAppearance:u,shadows:this.shadows}),s.add(r),n=!1}else{_(r)&&(s.remove(r),r=void 0);var d=this.oldPrimitive;_(d)&&(s.remove(d),this.oldPrimitive=void 0)}this.attributes.removeAll(),this.primitive=r,this.createPrimitive=!1,this.waitingOnCreate=!0}else if(_(r)&&r.ready){r.show=!0,_(this.oldPrimitive)&&(s.remove(this.oldPrimitive),this.oldPrimitive=void 0),!_(this.depthFailAppearanceType)||this.depthFailMaterialProperty instanceof w||(this.depthFailMaterial=L.getValue(t,this.depthFailMaterialProperty,this.depthFailMaterial),this.primitive.depthFailAppearance.material=this.depthFailMaterial);var h=this.updatersWithAttributes.values,y=h.length,f=this.waitingOnCreate;for(i=0;i<y;i++){var m=h[i],g=this.geometry.get(m.id);if(e=this.attributes.get(g.id.id),_(e)||(e=r.getGeometryInstanceAttributes(g.id),this.attributes.set(g.id.id,e)),!m.fillMaterialProperty.isConstant||f){var v=m.fillMaterialProperty.color,P=O.getValueOrDefault(v,t,E.WHITE,R);E.equals(e._lastColor,P)||(e._lastColor=E.clone(P,e._lastColor),e.color=C.toValue(P,e.color),(this.translucent&&255===e.color[3]||!this.translucent&&255!==e.color[3])&&(this.itemsToRemove[o++]=m))}if(_(this.depthFailAppearanceType)&&m.depthFailMaterialProperty instanceof w&&(!m.depthFailMaterialProperty.isConstant||f)){var b=m.depthFailMaterialProperty.color,A=O.getValueOrDefault(b,t,E.WHITE,R);E.equals(e._lastDepthFailColor,A)||(e._lastDepthFailColor=E.clone(A,e._lastDepthFailColor),e.depthFailColor=C.toValue(A,e.depthFailColor))}var j=m.entity.isShowing&&(m.hasConstantFill||m.isFilled(t));j!==(1===e.show[0])&&(e.show=T.toValue(j,e.show));var F=m.distanceDisplayConditionProperty;if(!O.isConstant(F)){var k=O.getValueOrDefault(F,t,N,x);S.equals(k,e._lastDistanceDisplayCondition)||(e._lastDistanceDisplayCondition=S.clone(k,e._lastDistanceDisplayCondition),e.distanceDisplayCondition=I.toValue(k,e.distanceDisplayCondition))}}this.updateShows(r),this.waitingOnCreate=!1}else _(r)&&!r.ready&&(n=!1);return this.itemsToRemove.length=o,n},j.prototype.updateShows=function(t){for(var e=this.showsUpdated.values,i=e.length,n=0;n<i;n++){var o=e[n],r=this.geometry.get(o.id),s=this.attributes.get(r.id.id);_(s)||(s=t.getGeometryInstanceAttributes(r.id),this.attributes.set(r.id.id,s));var a=o.entity.isShowing;a!==(1===s.show[0])&&(s.show=T.toValue(a,s.show))}this.showsUpdated.removeAll()},j.prototype.contains=function(t){return this.updaters.contains(t.id)},j.prototype.getBoundingSphere=function(t,e){var i=this.primitive;if(!i.ready)return A.PENDING;var n=i.getGeometryInstanceAttributes(t.entity);return!_(n)||!_(n.boundingSphere)||_(n.show)&&0===n.show[0]?A.FAILED:(n.boundingSphere.clone(e),A.DONE)},j.prototype.removeAllPrimitives=function(){var t=this.primitives,e=this.primitive;_(e)&&(t.remove(e),this.primitive=void 0,this.geometry.removeAll(),this.updaters.removeAll());var i=this.oldPrimitive;_(i)&&(t.remove(i),this.oldPrimitive=void 0)},j.prototype.destroy=function(){var t=this.primitive,e=this.primitives;_(t)&&e.remove(t);var i=this.oldPrimitive;_(i)&&e.remove(i),_(this.removeMaterialSubscription)&&this.removeMaterialSubscription()};var F=!1;var k=new e.InjectionToken("ANGULAR_CESIUM_CONFIG"),H=function(){function t(t){this.config=t,!1!==(!t||t.fixEntitiesShadows)&&(F||(Cesium.StaticGeometryColorBatch.prototype.add=function(t,e){var i,n,o=e.createFillGeometryInstance(t);255===o.attributes.color.value[3]?(i=this._solidItems,n=!1):(i=this._translucentItems,n=!0);for(var r=i.length,s=0;s<r;s++){var a=i[s];if(a.isMaterial(e))return void a.add(e,o)}var p=new j(this._primitives,n,this._appearanceType,this._depthFailAppearanceType,e.depthFailMaterialProperty,this._closed,this._shadows);p.add(e,o),i.push(p)},F=!0))}return t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:void 0,decorators:[{type:e.Optional},{type:e.Inject,args:[k]}]}]},t}();var V={SCENE3D:0,COLUMBUS_VIEW:1,SCENE2D:2,PERFORMANCE_SCENE2D:3};V[V.SCENE3D]="SCENE3D",V[V.COLUMBUS_VIEW]="COLUMBUS_VIEW",V[V.SCENE2D]="SCENE2D",V[V.PERFORMANCE_SCENE2D]="PERFORMANCE_SCENE2D";var B=function(){function t(){this.isSceneModePerformance2D=!1}return t.prototype.init=function(t){this.viewer=t.getViewer(),this.scene=t.getScene(),this.screenSpaceCameraController=this.scene.screenSpaceCameraController,this.camera=this.scene.camera,this.lastRotate=this.screenSpaceCameraController.enableRotate,this.lastTilt=this.screenSpaceCameraController.enableTilt,this.lastLook=this.screenSpaceCameraController.enableLook},t.prototype._listenToSceneModeMorph=function(t){this.morphListenerCancelFn=this.scene.morphStart.addEventListener(t)},t.prototype._revertCameraProperties=function(){this.isSceneModePerformance2D=!1,this.enableTilt(this.lastTilt),this.enableRotate(this.lastRotate),this.enableLook(this.lastLook)},t.prototype.getCamera=function(){return this.camera},t.prototype.getScreenSpaceCameraController=function(){return this.screenSpaceCameraController},t.prototype.getMinimumZoom=function(){return this.screenSpaceCameraController.minimumZoomDistance},t.prototype.setMinimumZoom=function(t){this.screenSpaceCameraController.minimumZoomDistance=t},t.prototype.getMaximumZoom=function(){return this.screenSpaceCameraController.maximumZoomDistance},t.prototype.setMaximumZoom=function(t){this.screenSpaceCameraController.maximumZoomDistance=t},t.prototype.enableTilt=function(t){this.screenSpaceCameraController.enableTilt=t},t.prototype.enableRotate=function(t){this.screenSpaceCameraController.enableRotate=t},t.prototype.enableLook=function(t){this.screenSpaceCameraController.enableLook=t},t.prototype.enableTranslate=function(t){this.screenSpaceCameraController.enableTranslate=t},t.prototype.enableZoom=function(t){this.screenSpaceCameraController.enableZoom=t},t.prototype.enableInputs=function(t){this.screenSpaceCameraController.enableInputs=t},t.prototype.setSceneMode=function(e,i){var n=this;switch(e){case V.SCENE3D:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphTo3D(i);break;case V.COLUMBUS_VIEW:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphToColumbusView(i);break;case V.SCENE2D:this.isSceneModePerformance2D&&this._revertCameraProperties(),this.scene.morphTo2D(i);break;case V.PERFORMANCE_SCENE2D:this.isSceneModePerformance2D=!0,this.lastLook=this.screenSpaceCameraController.enableLook,this.lastTilt=this.screenSpaceCameraController.enableTilt,this.lastRotate=this.screenSpaceCameraController.enableRotate,this.screenSpaceCameraController.enableTilt=!1,this.screenSpaceCameraController.enableRotate=!1,this.screenSpaceCameraController.enableLook=!1,this.morphListenerCancelFn&&this.morphListenerCancelFn(),this.scene.morphToColumbusView(i);var o=this.scene.morphComplete.addEventListener(function(){n.camera.setView({destination:Cesium.Cartesian3.fromDegrees(0,0,Math.min(t.PERFORMANCE_2D_ALTITUDE,n.getMaximumZoom())),orientation:{pitch:Cesium.Math.toRadians(-90)}}),o(),n._listenToSceneModeMorph(n._revertCameraProperties.bind(n))})}},t.prototype.cameraFlyTo=function(t){return this.camera.flyTo(t)},t.prototype.flyTo=function(t,e){return this.viewer.flyTo(t,e)},t.prototype.zoomIn=function(t){return this.camera.zoomIn(t||this.camera.defaultZoomAmount)},t.prototype.zoomOut=function(t){return this.camera.zoomOut(t||this.camera.defaultZoomAmount)},t.prototype.zoomTo=function(t,e){return this.viewer.zoomTo(t,e)},t.prototype.setView=function(t){this.camera.setView(t)},t.prototype.setRotation=function(t){this.setView({orientation:{heading:t}})},t.prototype.lockRotation=function(t){this.scene.screenSpaceCameraController.enableRotate=!t},t.prototype.trackEntity=function(t,e){var i=this,n=e&&e.flyTo||!1;return this.viewer.trackedEntity=void 0,new Promise(function(o){if(n){var r=e&&e.flyToDuration||1,s=e&&e.altitude||1e4,a=t.position.getValue(Cesium.JulianDate.now()),p=Cesium.Cartographic.fromCartesian(a),c=s-p.height;p.height=s;var l=Cesium.Cartesian3.fromRadians(p.longitude,p.latitude,p.height);i.cameraFlyTo({duration:r,destination:l,complete:function(){i.viewer.trackedEntity=t,setTimeout(function(){c>0?i.camera.zoomOut(c):i.camera.zoomIn(c)},0),o()}})}else i.viewer.trackedEntity=t,o()})},t.prototype.untrackEntity=function(){this.trackEntity()},t.PERFORMANCE_2D_ALTITUDE=25e6,t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var G={MOUSE_MOVE:Cesium.ScreenSpaceEventType.MOUSE_MOVE,LEFT_CLICK:Cesium.ScreenSpaceEventType.LEFT_CLICK,LEFT_DOUBLE_CLICK:Cesium.ScreenSpaceEventType.LEFT_DOUBLE_CLICK,LEFT_DOWN:Cesium.ScreenSpaceEventType.LEFT_DOWN,LEFT_UP:Cesium.ScreenSpaceEventType.LEFT_UP,MIDDLE_CLICK:Cesium.ScreenSpaceEventType.MIDDLE_CLICK,MIDDLE_DOUBLE_CLICK:Cesium.ScreenSpaceEventType.MIDDLE_DOUBLE_CLICK,MIDDLE_DOWN:Cesium.ScreenSpaceEventType.MIDDLE_DOWN,MIDDLE_UP:Cesium.ScreenSpaceEventType.MIDDLE_UP,PINCH_START:Cesium.ScreenSpaceEventType.PINCH_START,PINCH_END:Cesium.ScreenSpaceEventType.PINCH_END,PINCH_MOVE:Cesium.ScreenSpaceEventType.PINCH_MOVE,RIGHT_CLICK:Cesium.ScreenSpaceEventType.RIGHT_CLICK,RIGHT_DOUBLE_CLICK:Cesium.ScreenSpaceEventType.RIGHT_DOUBLE_CLICK,RIGHT_DOWN:Cesium.ScreenSpaceEventType.RIGHT_DOWN,RIGHT_UP:Cesium.ScreenSpaceEventType.RIGHT_UP,WHEEL:Cesium.ScreenSpaceEventType.WHEEL,LONG_LEFT_PRESS:110,LONG_RIGHT_PRESS:111,LONG_MIDDLE_PRESS:112,LEFT_CLICK_DRAG:113,RIGHT_CLICK_DRAG:114,MIDDLE_CLICK_DRAG:115};G[G.LONG_LEFT_PRESS]="LONG_LEFT_PRESS",G[G.LONG_RIGHT_PRESS]="LONG_RIGHT_PRESS",G[G.LONG_MIDDLE_PRESS]="LONG_MIDDLE_PRESS",G[G.LEFT_CLICK_DRAG]="LEFT_CLICK_DRAG",G[G.RIGHT_CLICK_DRAG]="RIGHT_CLICK_DRAG",G[G.MIDDLE_CLICK_DRAG]="MIDDLE_CLICK_DRAG";var U={NO_PICK:0,PICK_FIRST:1,PICK_ONE:2,PICK_ALL:3};U[U.NO_PICK]="NO_PICK",U[U.PICK_FIRST]="PICK_FIRST",U[U.PICK_ONE]="PICK_ONE",U[U.PICK_ALL]="PICK_ALL";var z=function(){function t(){this._showContextMenu=!1,this._contextMenuChangeNotifier=new e.EventEmitter,this._onOpen=new e.EventEmitter,this._onClose=new e.EventEmitter,this._defaultContextMenuOptions={closeOnLeftCLick:!0,closeOnLeftClickPriority:10}}return Object.defineProperty(t.prototype,"contextMenuChangeNotifier",{get:function(){return this._contextMenuChangeNotifier},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"showContextMenu",{get:function(){return this._showContextMenu},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"content",{get:function(){return this._content},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onOpen",{get:function(){return this._onOpen},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"onClose",{get:function(){return this._onClose},enumerable:!0,configurable:!0}),t.prototype.init=function(t){this.mapEventsManager=t},t.prototype.open=function(t,e,i){var n=this;void 0===i&&(i={}),this.close(),this._content=t,this._position=e,this._options=Object.assign({},this._defaultContextMenuOptions,i),this._showContextMenu=!0,this.mapEventsManager&&this._options.closeOnLeftCLick&&(this.leftClickRegistration=this.mapEventsManager.register({event:G.LEFT_CLICK,pick:U.NO_PICK,priority:this._options.closeOnLeftClickPriority}),this.leftClickSubscription=this.leftClickRegistration.subscribe(function(){n.leftClickSubscription.unsubscribe(),n.close()})),this._contextMenuChangeNotifier.emit(),this._onOpen.emit()},t.prototype.close=function(){this._content=void 0,this._position=void 0,this._options=void 0,this._showContextMenu=!1,this.leftClickRegistration&&(this.leftClickRegistration.dispose(),this.leftClickRegistration=void 0),this.leftClickSubscription&&(this.leftClickSubscription.unsubscribe(),this.leftClickSubscription=void 0),this._contextMenuChangeNotifier.emit(),this._onClose.emit()},t.decorators=[{type:e.Injectable}],t}();var K=n.LatLonVectors;window.geodesy=n;var W=function(){function t(t){this.cesiumService=t}return t.cartesian3ToLatLon=function(t,e){var i=Cesium.Cartographic.fromCartesian(t,e);return{lon:Cesium.Math.toDegrees(i.longitude),lat:Cesium.Math.toDegrees(i.latitude),height:i.height}},t.prototype.screenToCartesian3=function(t,e){if(this.cesiumService){var i=y({},t);if(e){var n=this.cesiumService.getViewer().canvas.getBoundingClientRect();i.x+=n.left,i.y+=n.top}return this.cesiumService.getViewer().camera.pickEllipsoid(i)}throw new Error("ANGULAR2-CESIUM - Cesium service should be provided in order to do screen position calculations")},t.prototype.screenToCartographic=function(t,e){return this.cartesian3ToCartographic(this.screenToCartesian3(t),e)},t.prototype.cartesian3ToCartographic=function(t,e){return Cesium.Cartographic.fromCartesian(t,e)},t.prototype.degreesToCartographic=function(t,e,i){return Cesium.Cartographic.fromDegrees(t,e,i)},t.prototype.radiansToCartographic=function(t,e,i){return Cesium.Cartographic.fromRadians(t,e,i)},t.prototype.degreesToUTM=function(t,e){return new n.LatLonEllipsoidal(e,t).toUtm()},t.prototype.UTMToDegrees=function(t,e,i,o){return this.geodesyToCesiumObject(new n.Utm(t,e,i,o).toLatLonE())},t.prototype.geodesyToCesiumObject=function(t){return{longitude:t.lon,latitude:t.lat,height:t.height?t.height:0}},t.prototype.midPointToCartesian3=function(t,e){var i=function(t){return Cesium.Math.toDegrees(t)},n=new K(i(t.latitude),i(t.longitude)),o=new K(i(e.latitude),i(e.longitude)),r=n.midpointTo(o);return Cesium.Cartesian3.fromDegrees(r.lon,r.lat)},t.prototype.middlePointByScreen=function(t,e){var i=this.cesiumService.getScene(),n=Cesium.SceneTransforms.wgs84ToWindowCoordinates(i,t),o=Cesium.SceneTransforms.wgs84ToWindowCoordinates(i,e),r=new Cesium.Cartesian2((o.x+n.x)/2,(o.y+n.y)/2);return i.pickPosition(r)},t.prototype.bearingTo=function(t,e){var i=function(t){return Cesium.Math.toDegrees(t)},n=new K(i(t.latitude),i(t.longitude)),o=new K(i(e.latitude),i(e.longitude));return n.bearingTo(o)},t.prototype.bearingToCartesian=function(t,e){var i=Cesium.Cartographic.fromCartesian(t),n=Cesium.Cartographic.fromCartesian(e);return this.bearingTo(i,n)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:P,decorators:[{type:e.Optional}]}]},t}();var $=function(){function t(){}return t.prototype.setPropsAssigner=function(t){this._propsAssigner=t},t}();var Y=function(t){function e(e,i){var n=t.call(this)||this;return n.drawerType=e,n.cesiumService=i,n._show=!0,n}return h(e,t),e.prototype.init=function(){this._cesiumCollection=new this.drawerType,this._primitiveCollectionWrap=new Cesium.PrimitiveCollection,this._primitiveCollectionWrap.add(this._cesiumCollection),this.cesiumService.getScene().primitives.add(this._primitiveCollectionWrap)},e.prototype.add=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];return this._cesiumCollection.add(t)},e.prototype.update=function(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];this._propsAssigner?this._propsAssigner(t,e):Object.assign(t,e)},e.prototype.remove=function(t){this._cesiumCollection.remove(t)},e.prototype.removeAll=function(){this._cesiumCollection.removeAll()},e.prototype.setShow=function(t){this._show=t,this._primitiveCollectionWrap.show=t},e.prototype.getShow=function(){return this._show},e}($);var Z=function(){function t(t){this.cesiumService=t}return t.pointByLocationDistanceAndAzimuth=function(e,i,n,o){for(var r,s,a=i/Cesium.Ellipsoid.WGS84.maximumRadius,p=e instanceof Cesium.Cartesian3?Cesium.Cartographic.fromCartesian(e):e,c=e instanceof Cesium.Cartesian3?e:Cesium.Cartesian3.fromRadians(e.longitude,e.latitude,e.height),l=0,u=.1,d=-.1;0===l||l<16&&Math.max(s,i)/Math.min(s,i)>1.000001;){var h=d+(u-d)/2;r=t._pointByLocationDistanceAndAzimuth(p,a*(1+h),n),(s=this.distance(c,r))>i?u=d+(u-d)/2:d+=(u-d)/2,l++}return r},t._pointByLocationDistanceAndAzimuth=function(t,e,i){var n=t.latitude,o=t.longitude,r=Math.asin(Math.sin(n)*Math.cos(e)+Math.cos(n)*Math.sin(e)*Math.cos(i)),s=o+Math.atan2(Math.sin(i)*Math.sin(e)*Math.cos(n),Math.cos(e)-Math.sin(n)*Math.sin(r));return s=(s+3*Math.PI)%(2*Math.PI)-Math.PI,Cesium.Cartesian3.fromRadians(s,r)},t.distance=function(t,e){return Cesium.Cartesian3.distance(t,e)},t.getPositionsDelta=function(t,e){return{x:e.x-t.x,y:e.y-t.y,z:e.z-t.z}},t.addDeltaToPosition=function(t,e,i){if(void 0===i&&(i=!1),i){t.x+=e.x,t.y+=e.y,t.z+=e.z,(o=Cesium.Cartographic.fromCartesian(t)).height=0;var n=Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height);return t.x=n.x,t.y=n.y,t.z=n.z,t}var o;n=new Cesium.Cartesian3(t.x+e.x,t.y+e.y,t.z+e.z);return(o=Cesium.Cartographic.fromCartesian(n)).height=0,Cesium.Cartesian3.fromRadians(o.longitude,o.latitude,o.height)},t.middleCartesian3Point=function(t,e){return new Cesium.Cartesian3(e.x-t.x/2,e.y-t.y/2,e.z-t.z/2)},t.prototype.screenPositionToCartesian3=function(t){return this.cesiumService.getViewer().camera.pickEllipsoid(t)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:P}]},t}();var q=function(t){function i(e){return t.call(this,Cesium.PolylineCollection,e)||this}return h(i,t),i.prototype._calculateArcPositions=function(t){for(var e=t.quality||18,i=t.delta/e,n=[],o=0;o<e+1;++o){var r=Z.pointByLocationDistanceAndAzimuth(t.center,t.radius,t.angle+i*o,!0);n.push(r)}return n},i.prototype._calculateTriangle=function(t){return[t.center,Z.pointByLocationDistanceAndAzimuth(t.center,t.radius,t.angle,!0)]},i.prototype._calculateArc=function(t){var e=this._calculateArcPositions(t);return t.drawEdges?e.concat(this._calculateTriangle(t)):e},i.prototype.add=function(t){if(t.positions=this._calculateArc(t),t.color){var e=Cesium.Material.fromType("Color");e.uniforms.color=t.color,t.material=e}return this._cesiumCollection.add(t)},i.prototype.update=function(t,e){return e.constantColor||!e.color||t.material.uniforms.color.equals(e.color)||(t.material.uniforms.color=e.color),t.width=void 0!==e.width?e.width:t.width,t.show=void 0!==e.show?e.show:t.show,t.distanceDisplayCondition=void 0!==e.distanceDisplayCondition?e.distanceDisplayCondition:t.distanceDisplayCondition,t.positions=this._calculateArc(e),t},i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),X={ellipse:Cesium.EllipseGraphics,ellipsoid:Cesium.EllipsoidGraphics,polygon:Cesium.PolygonGraphics,polyline:Cesium.PolylineGraphics,polylineVolume:Cesium.PolylineVolumeGraphics,box:Cesium.BoxGraphics,corridor:Cesium.CorridorGraphics,cylinder:Cesium.CylinderGraphics,label:Cesium.LabelGraphics,billboard:Cesium.BillboardGraphics,model:Cesium.ModelGraphics,path:Cesium.PathGraphics,point:Cesium.PointGraphics,rectangle:Cesium.RectangleGraphics,wall:Cesium.WallGraphics},J=function(){function t(t,e,i){void 0===e&&(e=-1),void 0===i&&(i=-1),this.entityCollection=t,this._isSuspended=!1,this._isHardSuspend=!1,this._updateRate=i,this._collectionSize=e}return t.prototype.setShow=function(t){this.entityCollection.show=t},Object.defineProperty(t.prototype,"isSuspended",{get:function(){return this._isSuspended},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updateRate",{get:function(){return this._updateRate},set:function(t){this._updateRate=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"collectionSize",{get:function(){return this._collectionSize},set:function(t){this._collectionSize=t},enumerable:!0,configurable:!0}),t.prototype.collection=function(){return this.entityCollection},t.prototype.isFree=function(){return this._collectionSize<1||this.entityCollection.values.length<this._collectionSize},t.prototype.add=function(t){return this.suspend(),this.entityCollection.add(t)},t.prototype.remove=function(t){return this.suspend(),this.entityCollection.remove(t)},t.prototype.removeNoSuspend=function(t){this.entityCollection.remove(t)},t.prototype.removeAll=function(){this.suspend(),this.entityCollection.removeAll()},t.prototype.onEventSuspension=function(t,e){var i=this;return void 0===e&&(e=!1),this._onEventSuspensionCallback={callback:t,once:e},function(){i._onEventSuspensionCallback=void 0}},t.prototype.onEventResume=function(t,e){var i=this;return void 0===e&&(e=!1),this._onEventResumeCallback={callback:t,once:e},this._isSuspended||this.triggerEventResume(),function(){i._onEventResumeCallback=void 0}},t.prototype.triggerEventSuspension=function(){if(void 0!==this._onEventSuspensionCallback){var t=this._onEventSuspensionCallback.callback;this._onEventSuspensionCallback.once&&(this._onEventSuspensionCallback=void 0),t()}},t.prototype.triggerEventResume=function(){if(void 0!==this._onEventResumeCallback){var t=this._onEventResumeCallback.callback;this._onEventResumeCallback.once&&(this._onEventResumeCallback=void 0),t()}},t.prototype.suspend=function(){var t=this;this._updateRate<0||this._isHardSuspend||this._isSuspended||(this._isSuspended=!0,this.entityCollection.suspendEvents(),this.triggerEventSuspension(),this._suspensionTimeout=setTimeout(function(){t.entityCollection.resumeEvents(),t.triggerEventResume(),t._isSuspended=!1,t._suspensionTimeout=void 0},this._updateRate))},t.prototype.hardSuspend=function(){this.entityCollection.suspendEvents(),this._isHardSuspend=!0},t.prototype.hardResume=function(){this.entityCollection.resumeEvents(),this._isHardSuspend=!1},t}();var Q=function(t){function e(e,i,n){void 0===n&&(n={collectionMaxSize:-1,collectionSuspensionTime:-1,collectionsNumber:1});var o=t.call(this)||this;for(var r in o.cesiumService=e,o.graphicsType=i,o.defaultOptions=n,o.entityCollections=new Map,o.graphicsTypeName=X[o.graphicsType],X)X[r]===o.graphicsType&&(o.graphicsTypeName=r);return o}return h(e,t),e.prototype.getFreeEntitiesCollection=function(){var t=null;return this.entityCollections.forEach(function(e){e.isFree()&&(t=e)}),t},e.prototype.init=function(t){for(var e=t||this.defaultOptions,i=[],n=0;n<e.collectionsNumber;n++){var o=new Cesium.CustomDataSource(this.graphicsTypeName);i.push(o),this.cesiumService.getViewer().dataSources.add(o),this.entityCollections.set(o.entities,new J(o.entities,e.collectionMaxSize,e.collectionSuspensionTime))}return i},e.prototype.add=function(t){var e,i=this.getFreeEntitiesCollection();if(null===i)throw new Error("No more free entity collections");var n=((e={position:void 0!==t.position?t.position:void 0,description:void 0!==t.description?t.description:void 0,orientation:void 0!==t.orientation?t.orientation:void 0,viewFrom:void 0!==t.viewFrom?t.viewFrom:void 0})[this.graphicsTypeName]=t,e);return void 0!==t.name&&(n.name=t.name),void 0!==t.availability&&(n.availability=t.availability),i.add(n)},e.prototype.update=function(t,e){this.suspendEntityCollection(t),t.position instanceof Cesium.CallbackProperty&&t.position._isConstant&&(t.position=e.position),t.position=void 0!==e.position?e.position:void 0,t.name=void 0!==e.name?e.name:t.name,t.description=void 0!==e.description?e.description:t.description,t.orientation=void 0!==e.orientation?e.orientation:t.orientation,t.viewFrom=void 0!==e.viewFrom?e.viewFrom:t.viewFrom,t.availability=(e.availability,e.availability),this._propsAssigner?this._propsAssigner(t[this.graphicsTypeName],e):Object.assign(t[this.graphicsTypeName],e)},e.prototype.remove=function(t){this.entityCollections.get(t.entityCollection).remove(t)},e.prototype.removeAll=function(){this.entityCollections.forEach(function(t){t.removeAll()})},e.prototype.setShow=function(t){this.entityCollections.forEach(function(e){e.setShow(t)})},e.prototype.suspendEntityCollection=function(t){var e=t.entityCollection;if(!this.entityCollections.has(e))throw new Error("No EntityCollection for entity.entityCollection");this.entityCollections.get(e).suspend()},e}($);var tt=function(t){function i(e){return t.call(this,e,X.billboard)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),et=function(t){function i(e){var i=t.call(this)||this;return i.cesiumService=e,i}return h(i,t),i.prototype.init=function(t){var e=[];return this.czmlStream=new Cesium.CzmlDataSource("czml"),e.push(this.czmlStream),this.cesiumService.getViewer().dataSources.add(this.czmlStream),e},i.prototype.add=function(t){return this.czmlStream.process(t.czmlPacket),t},i.prototype.update=function(t,e){this.czmlStream.process(e.czmlPacket)},i.prototype.remove=function(t){this.czmlStream.entities.removeById(t.acEntity.id)},i.prototype.removeAll=function(){this.czmlStream.entities.removeAll()},i.prototype.setShow=function(t){this.czmlStream.entities.show=t},i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}($);var it,nt=function(t){function i(e){return t.call(this,e,X.ellipse,{collectionsNumber:10,collectionMaxSize:450,collectionSuspensionTime:100})||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),ot=function(t){function i(e){return t.call(this,e,X.label)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),rt=function(t){function i(e){return t.call(this,e,X.point)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),st=function(t){function i(e){return t.call(this,e,X.polygon)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),at=function(t){function i(e){return t.call(this,e,X.polyline)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),pt=function(t){function i(e){return t.call(this,Cesium.PolylineCollection,e)||this}return h(i,t),i.prototype.add=function(t){return this._cesiumCollection.add(this.withColorMaterial(t))},i.prototype.update=function(e,i){i.material instanceof Cesium.Color&&(e.material&&e.material.uniforms&&e.material.uniforms.color instanceof Cesium.Color?this.withColorMaterial(i):e.material.uniforms.color.equals(i.material)||(e.material.uniforms.color=i.material)),t.prototype.update.call(this,e,i)},i.prototype.withColorMaterial=function(t){if(t.material instanceof Cesium.Color){var e=Cesium.Material.fromType("Color");e.uniforms.color=t.material,t.material=e}return t},i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),ct={CAMERA_FORWARD:0,CAMERA_BACKWARD:1,CAMERA_RIGHT:2,CAMERA_LEFT:3,CAMERA_UP:4,CAMERA_DOWN:5,CAMERA_LOOK_RIGHT:6,CAMERA_LOOK_LEFT:7,CAMERA_LOOK_UP:8,CAMERA_LOOK_DOWN:9,CAMERA_TWIST_RIGHT:10,CAMERA_TWIST_LEFT:11,CAMERA_ROTATE_RIGHT:12,CAMERA_ROTATE_LEFT:13,CAMERA_ROTATE_UP:14,CAMERA_ROTATE_DOWN:15,CAMERA_ZOOM_IN:16,CAMERA_ZOOM_OUT:17};ct[ct.CAMERA_FORWARD]="CAMERA_FORWARD",ct[ct.CAMERA_BACKWARD]="CAMERA_BACKWARD",ct[ct.CAMERA_RIGHT]="CAMERA_RIGHT",ct[ct.CAMERA_LEFT]="CAMERA_LEFT",ct[ct.CAMERA_UP]="CAMERA_UP",ct[ct.CAMERA_DOWN]="CAMERA_DOWN",ct[ct.CAMERA_LOOK_RIGHT]="CAMERA_LOOK_RIGHT",ct[ct.CAMERA_LOOK_LEFT]="CAMERA_LOOK_LEFT",ct[ct.CAMERA_LOOK_UP]="CAMERA_LOOK_UP",ct[ct.CAMERA_LOOK_DOWN]="CAMERA_LOOK_DOWN",ct[ct.CAMERA_TWIST_RIGHT]="CAMERA_TWIST_RIGHT",ct[ct.CAMERA_TWIST_LEFT]="CAMERA_TWIST_LEFT",ct[ct.CAMERA_ROTATE_RIGHT]="CAMERA_ROTATE_RIGHT",ct[ct.CAMERA_ROTATE_LEFT]="CAMERA_ROTATE_LEFT",ct[ct.CAMERA_ROTATE_UP]="CAMERA_ROTATE_UP",ct[ct.CAMERA_ROTATE_DOWN]="CAMERA_ROTATE_DOWN",ct[ct.CAMERA_ZOOM_IN]="CAMERA_ZOOM_IN",ct[ct.CAMERA_ZOOM_OUT]="CAMERA_ZOOM_OUT";var lt=((it={})[ct.CAMERA_FORWARD]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveForward(n)},it[ct.CAMERA_BACKWARD]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveBackward(n)},it[ct.CAMERA_UP]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveUp(n)},it[ct.CAMERA_DOWN]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveDown(n)},it[ct.CAMERA_RIGHT]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveRight(n)},it[ct.CAMERA_LEFT]=function(t,e){var i=t.getViewer().camera,n=t.getScene().globe.ellipsoid.cartesianToCartographic(i.position).height/(e.moveRate||100);i.moveLeft(n)},it[ct.CAMERA_LOOK_RIGHT]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookRight(n.latitude*o)},it[ct.CAMERA_LOOK_LEFT]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookLeft(n.latitude*o)},it[ct.CAMERA_LOOK_UP]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookUp(n.longitude*(-1*o))},it[ct.CAMERA_LOOK_DOWN]=function(t,e){var i=t.getViewer().camera,n=i.positionCartographic,o=e.lookFactor||.01;i.lookDown(n.longitude*(-1*o))},it[ct.CAMERA_TWIST_RIGHT]=function(t,e){var i=t.getViewer().camera,n=e.amount||.01;i.twistRight(n)},it[ct.CAMERA_TWIST_LEFT]=function(t,e){var i=t.getViewer().camera,n=e.amount||.01;i.twistLeft(n)},it[ct.CAMERA_ROTATE_RIGHT]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateRight(n)},it[ct.CAMERA_ROTATE_LEFT]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateLeft(n)},it[ct.CAMERA_ROTATE_UP]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateUp(n)},it[ct.CAMERA_ROTATE_DOWN]=function(t,e){var i=t.getViewer().camera,n=e.angle||.01;i.rotateDown(n)},it[ct.CAMERA_ZOOM_IN]=function(t,e){var i=t.getViewer().camera,n=e.amount;i.zoomIn(n)},it[ct.CAMERA_ZOOM_OUT]=function(t,e){var i=t.getViewer().camera,n=e.amount;i.zoomOut(n)},it);var ut={IGNORED:0,NOT_PRESSED:1,PRESSED:2};ut[ut.IGNORED]="IGNORED",ut[ut.NOT_PRESSED]="NOT_PRESSED",ut[ut.PRESSED]="PRESSED";var dt=function(){function t(t,e,i){this.ngZone=t,this.cesiumService=e,this.document=i,this._currentDefinitions=null,this._activeDefinitions={},this._keyMappingFn=this.defaultKeyMappingFn}return t.prototype.init=function(){var t=this.cesiumService.getCanvas();t.addEventListener("click",function(){t.focus()}),this.handleKeydown=this.handleKeydown.bind(this),this.handleKeyup=this.handleKeyup.bind(this),this.handleTick=this.handleTick.bind(this)},t.prototype.setKeyboardControls=function(t,e,i){var n=this;if(void 0===i&&(i=!1),!t)return this.removeKeyboardControls();this._currentDefinitions||this.registerEvents(i),this._currentDefinitions=t,this._keyMappingFn=e||this.defaultKeyMappingFn,Object.keys(this._currentDefinitions).forEach(function(t){n._activeDefinitions[t]={state:ut.NOT_PRESSED,action:null,keyboardEvent:null}})},t.prototype.removeKeyboardControls=function(){this.unregisterEvents(),this._currentDefinitions=null},t.prototype.getAction=function(t){return this._currentDefinitions[t]||null},t.prototype.defaultKeyMappingFn=function(t){return String.fromCharCode(t.keyCode)},t.prototype.handleKeydown=function(t){var e=this._keyMappingFn(t),i=this.getAction(e);if(i&&this._activeDefinitions[e].state!==ut.IGNORED){var n=!0,o=this.getParams(i.params,t);i.validation&&(n=i.validation(this.cesiumService,o,t)),!0===n&&(this._activeDefinitions[e]={state:ut.PRESSED,action:i,keyboardEvent:t})}},t.prototype.handleKeyup=function(t){var e=this._keyMappingFn(t),i=this.getAction(e);i&&(this._activeDefinitions[e]={state:ut.NOT_PRESSED,action:null,keyboardEvent:t},i.done&&"function"==typeof i.done&&i.done(this.cesiumService,t))},t.prototype.handleTick=function(){var t=this;Object.keys(this._activeDefinitions).forEach(function(e){var i=t._activeDefinitions[e];null!==i&&null!==i.action&&i.state===ut.PRESSED&&t.executeAction(i.action,e,i.keyboardEvent)})},t.prototype.getParams=function(t,e){return t?"function"==typeof t?t(this.cesiumService,e):t:{}},t.prototype.executeAction=function(t,e,i){if(this._currentDefinitions){var n=this.getParams(t.params,i);if(o.isNumber(t.action)){var r=lt[t.action];r&&r(this.cesiumService,n,i)}else if("function"==typeof t.action){!1===t.action(this.cesiumService,n,i)&&(this._activeDefinitions[e]={state:ut.IGNORED,action:null,keyboardEvent:null})}}},t.prototype.registerEvents=function(t){var e=this,i=function(){e.document.addEventListener("keydown",e.handleKeydown),e.document.addEventListener("keyup",e.handleKeyup),e.cesiumService.getViewer().clock.onTick.addEventListener(e.handleTick)};t?this.ngZone.runOutsideAngular(i):i()},t.prototype.unregisterEvents=function(){this.document.removeEventListener("keydown",this.handleKeydown),this.document.removeEventListener("keyup",this.handleKeyup),this.cesiumService.getViewer().clock.onTick.removeEventListener(this.handleTick)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:e.NgZone},{type:P},{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]}]},t}();var ht=function(){function t(t,e){this.event=t,this.modifier=e}return t.prototype.init=function(t){var e=this;return this.observer=s.Observable.create(function(i){t.setInputAction(function(t){t.position&&(t.startPosition=t.position,t.endPosition=t.position),i.next(t)},e.event,e.modifier)}),this.observer},t}();var yt=function(t){function e(e,i,n){var o=t.call(this,e,i)||this;return o.event=e,o.modifier=i,o.eventFactory=n,o}return h(e,t),e.prototype.init=function(){var t,i;this.event===G.LONG_LEFT_PRESS?(t=G.LEFT_DOWN,i=G.LEFT_UP):this.event===G.LONG_RIGHT_PRESS?(t=G.RIGHT_DOWN,i=G.RIGHT_UP):this.event===G.LONG_MIDDLE_PRESS&&(t=G.MIDDLE_DOWN,i=G.MIDDLE_UP);var n=this.eventFactory.get(t,this.modifier),o=this.eventFactory.get(i,this.modifier);return r.publish()(n.pipe(r.mergeMap(function(t){return s.of(t).pipe(r.delay(e.LONG_PRESS_EVENTS_DURATION),r.takeUntil(o))})))},e.LONG_PRESS_EVENTS_DURATION=250,e}(ht);var ft=function(){function t(t){this.cesiumService=t,this.cesiumEventsObservables=new Map}return t.getEventFullName=function(t,e){return e?t+"_"+e:t.toString()},t.prototype.init=function(){this.eventsHandler=this.cesiumService.getViewer().screenSpaceEventHandler},t.prototype.get=function(e,i){var n=t.getEventFullName(e,i);if(this.cesiumEventsObservables.has(n))return this.cesiumEventsObservables.get(n);var o=this.createCesiumEventObservable(e,i);return this.cesiumEventsObservables.set(n,o),o},t.prototype.createCesiumEventObservable=function(e,i){var n;return(n=t.longPressEvents.has(e)?this.createSpecialCesiumEventObservable(e,i):r.publish()(new ht(e,i).init(this.eventsHandler))).connect(),n},t.prototype.createSpecialCesiumEventObservable=function(t,e){return new yt(t,e,this).init()},t.longPressEvents=new Set([G.LONG_LEFT_PRESS,G.LONG_RIGHT_PRESS,G.LONG_MIDDLE_PRESS]),t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:P}]},t}();var mt=function(){function t(){this._entitesToPlonter=[],this._plonterChangeNotifier=new e.EventEmitter,this._plonterObserver=new s.Subject}return Object.defineProperty(t.prototype,"plonterChangeNotifier",{get:function(){return this._plonterChangeNotifier},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plonterShown",{get:function(){return this._plonterShown},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"entitesToPlonter",{get:function(){return this._entitesToPlonter},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"plonterClickPosition",{get:function(){return this._eventResult.movement},enumerable:!0,configurable:!0}),t.prototype.plonterIt=function(t){return this._eventResult=t,this._entitesToPlonter=t.entities,this._plonterShown=!0,this._plonterChangeNotifier.emit(),this._plonterObserver},t.prototype.resolvePlonter=function(t){this._plonterShown=!1,this._eventResult.entities=[t],this._plonterChangeNotifier.emit(),this._plonterObserver.next(this._eventResult)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var gt=function(t){return t.reduce(function(t,e){return t.indexOf(e)<0&&t.push(e),t},[])},vt=function(){function t(){}return t.getDragEventTypes=function(t){var e,i;return t===G.LEFT_CLICK_DRAG?(e=G.LEFT_DOWN,i=G.LEFT_UP):t===G.RIGHT_CLICK_DRAG?(e=G.RIGHT_DOWN,i=G.RIGHT_UP):t===G.MIDDLE_CLICK_DRAG&&(e=G.MIDDLE_DOWN,i=G.MIDDLE_UP),{mouseDownEvent:e,mouseUpEvent:i}},t.dragEvents=new Set([G.LEFT_CLICK_DRAG,G.RIGHT_CLICK_DRAG,G.MIDDLE_CLICK_DRAG]),t}();var Pt=function(t,e,i,n){this.observable=t,this.stopper=e,this.priority=i,this.isPaused=n};var bt=function(){function t(t,e,i){this.cesiumService=t,this.eventBuilder=e,this.plonterService=i,this.eventRegistrations=new Map}return t.prototype.init=function(){this.eventBuilder.init(),this.scene=this.cesiumService.getScene()},t.prototype.register=function(t){var e=this;if(void 0===this.scene)throw new Error("CesiumService has not been initialized yet - MapEventsManagerService must be injected  under ac-map");if(t.pick=t.pick||U.NO_PICK,t.priority=t.priority||0,t.entityType&&t.pick===U.NO_PICK)throw new Error("MapEventsManagerService: can't register an event with entityType and PickOptions.NO_PICK - It doesn't make sense ");var i=ft.getEventFullName(t.event,t.modifier);this.eventRegistrations.has(i)||this.eventRegistrations.set(i,[]);var n=this.createEventRegistration(t.event,t.modifier,t.entityType,t.pick,t.priority,t.pickFilter),o=n.observable;return o.dispose=function(){return e.disposeObservable(n,i)},this.eventRegistrations.get(i).push(n),this.sortRegistrationsByPriority(i),o},t.prototype.disposeObservable=function(t,e){t.stopper.next(1);var i=this.eventRegistrations.get(e),n=i.indexOf(t);-1!==n&&i.splice(n,1),this.sortRegistrationsByPriority(e)},t.prototype.sortRegistrationsByPriority=function(t){var e=this.eventRegistrations.get(t);if(e.sort(function(t,e){return e.priority-t.priority}),0!==e.length){var i=e[0].priority;e.forEach(function(t){t.isPaused=t.priority<i})}},t.prototype.createEventRegistration=function(t,e,i,n,o,a){var p,c=this,l=this.eventBuilder.get(t,e),u=new s.Subject,d=new Pt(void 0,u,o,!1);return p=vt.dragEvents.has(t)?this.createDragEvent(t,e,i,n,o,a).pipe(r.takeUntil(u)):l.pipe(r.filter(function(){return!d.isPaused}),r.map(function(t){return c.triggerPick(t,n)}),r.filter(function(t){return null!==t.cesiumEntities||void 0===i}),r.map(function(t){return c.addEntities(t,i,n,a)}),r.filter(function(t){return null!==t.entities||void 0===i&&!a}),r.switchMap(function(t){return c.plonter(t,n)}),r.takeUntil(u)),d.observable=p,d},t.prototype.createDragEvent=function(t,e,i,n,o,a){var p=vt.getDragEventTypes(t),c=p.mouseDownEvent,l=p.mouseUpEvent,u=this.eventBuilder.get(l),d=this.eventBuilder.get(G.MOUSE_MOVE),h=this.createEventRegistration(c,e,i,n,o,a),y=new s.Subject,f=h.observable.pipe(r.mergeMap(function(t){var e=null,i=t.movement.startPosition.x,n=t.movement.startPosition.y;return d.pipe(r.map(function(o){return e={movement:{drop:!1,startPosition:{x:i,y:n},endPosition:o.endPosition},entities:t.entities,cesiumEntities:t.cesiumEntities}}),r.takeUntil(u),r.tap(void 0,void 0,function(){if(e){var t=Object.assign({},e);t.movement.drop=!0,y.next(t)}}))}));return s.merge(f,y)},t.prototype.triggerPick=function(t,e){var i=[];switch(e){case U.PICK_ONE:case U.PICK_ALL:i=0===(i=this.scene.drillPick(t.endPosition)).length?null:i;break;case U.PICK_FIRST:var n=this.scene.pick(t.endPosition);i=void 0===n?null:[n];break;case U.NO_PICK:}return i&&(i=i.map(function(t){return t.id&&t.id instanceof Cesium.Entity?t.id:t.primitive})),{movement:t,cesiumEntities:i}},t.prototype.addEntities=function(t,e,i,n){if(null===t.cesiumEntities)return t.entities=null,t;var o=[];return i!==U.NO_PICK&&(o=e?t.cesiumEntities.map(function(t){return t.acEntity}).filter(function(t){return t&&t instanceof e}):t.cesiumEntities.map(function(t){return t.acEntity}),o=gt(o),0===(o=n&&o?o.filter(n):o).length&&(o=null)),t.entities=o,t},t.prototype.plonter=function(t,e){return e===U.PICK_ONE&&null!==t.entities&&t.entities.length>1?this.plonterService.plonterIt(t):s.of(t)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:P},{type:ft},{type:mt}]},t}();var Et=function(){function t(t){this.cesiumService=t,this.layersDataSources=[]}return t.prototype.registerLayerDataSources=function(t,e){var i=this;t.forEach(function(t){t.zIndex=e,i.layersDataSources.push(t)})},t.prototype.drawAllLayers=function(){var t=this;this.layersDataSources.sort(function(t,e){return t.zIndex-e.zIndex}),this.layersDataSources.forEach(function(e){t.cesiumService.getViewer().dataSources.add(e)})},t.prototype.updateAndRefresh=function(t,e){var i=this;t&&t.length&&(t.forEach(function(t){var n=i.layersDataSources.indexOf(t);-1!==n&&(i.layersDataSources[n].zIndex=e)}),this.cesiumService.getViewer().dataSources.removeAll(),this.drawAllLayers())},t.prototype.removeDataSources=function(t){var e=this;t.forEach(function(t){var i=e.layersDataSources.indexOf(t);-1!==i&&(e.layersDataSources.splice(i,1),e.cesiumService.getViewer().dataSources.remove(t,!0))})},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:P}]},t}();var Ct=function(){function t(){this.defaultIdCounter=0,this._Maps=new Map,this.eventRemoveCallbacks=[]}return t.prototype.getMap=function(t){return t?this._Maps.get(t):this.firstMap},t.prototype._registerMap=function(t,e){this.firstMap||(this.firstMap=e);var i=t||this.generateDefaultId();if(this._Maps.has(i))throw new Error("Map with id: "+i+" already exist");return this._Maps.set(i,e),i},t.prototype._removeMapById=function(t){return this._Maps.delete(t)},t.prototype.generateDefaultId=function(){return this.defaultIdCounter++,"default-map-id-"+this.defaultIdCounter},t.prototype.sync2DMapsCameras=function(t){var e=this;this.unsyncMapsCameras();var i=t.map(function(t){var i=e.getMap(t.id);if(!i)throw new Error("Couldn't find map with id: "+t.id);return{map:i,options:{sensitivity:t.sensitivity,bindZoom:t.bindZoom}}});i.forEach(function(t){var n=t.map,o=t.options,r=n.getCameraService().getCamera(),s=r.positionCartographic;r.percentageChanged=o.sensitivity||.01;var a=r.changed.addEventListener(function(){i.forEach(function(t){var e=t.map,i=t.options;if(e!==n){var o=e.getCameraService().getCamera(),r=o.positionCartographic,a=Cesium.Ellipsoid.WGS84.cartographicToCartesian({longitude:s.longitude,latitude:s.latitude,height:i.bindZoom?s.height:r.height});e.getCesiumViewer().scene.mode!==Cesium.SceneMode.MORPHING&&o.setView({destination:a,orientation:{heading:o.heading,pitch:o.pitch}})}})});e.eventRemoveCallbacks.push(a)})},t.prototype.unsyncMapsCameras=function(){this.eventRemoveCallbacks.forEach(function(t){return t()}),this.eventRemoveCallbacks=[]},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var _t=function(){function t(t){this.cesiumService=t}return t.prototype.getMapScreenshotDataUrlBase64=function(){return this.cesiumService.getCanvas().toDataURL()},t.prototype.downloadMapScreenshot=function(t){void 0===t&&(t="map.png");var e=this.getMapScreenshotDataUrlBase64();this.downloadURI(e,t)},t.prototype.downloadURI=function(t,e){var i=document.createElement("a");i.download=e,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:P}]},t}();var St=function(){function t(t,e,i,n,o,r,s,a,p,c,l,u,d,h,y,f,m,g,v,P){this._cesiumService=t,this._cameraService=e,this._elemRef=i,this.document=n,this.mapsManagerService=o,this.billboardDrawerService=r,this.labelDrawerService=s,this.ellipseDrawerService=a,this.polylineDrawerService=p,this.polygonDrawerService=c,this.arcDrawerService=l,this.pointDrawerService=u,this.czmlDrawerService=d,this.mapEventsManager=h,this.keyboardControlService=y,this.mapLayersService=f,this.configurationService=m,this.screenshotService=g,this.contextMenuService=v,this.coordinateConverter=P,this.disableDefaultPlonter=!1,this.mapContainer=this.document.createElement("div"),this.mapContainer.style.width="100%",this.mapContainer.style.height="100%",this.mapContainer.className="map-container",this._cesiumService.init(this.mapContainer,this),this._cameraService.init(this._cesiumService),this.mapEventsManager.init(),this.billboardDrawerService.init(),this.labelDrawerService.init(),this.ellipseDrawerService.init(),this.polylineDrawerService.init(),this.polygonDrawerService.init(),this.arcDrawerService.init(),this.pointDrawerService.init(),this.czmlDrawerService.init(),this.keyboardControlService.init(),this.contextMenuService.init(this.mapEventsManager)}return t.prototype.ngOnInit=function(){this.mapId=this.mapsManagerService._registerMap(this.mapId,this),this.containerId||this._elemRef.nativeElement.appendChild(this.mapContainer)},t.prototype.ngOnChanges=function(t){if(t.sceneMode&&this._cameraService.setSceneMode(t.sceneMode.currentValue),t.flyTo&&this._cameraService.cameraFlyTo(t.flyTo.currentValue),t.containerId&&!t.containerId.firstChange){var e=this.document.getElementById(t.containerId.currentValue);if(!e)throw new Error("No element found with id: "+t.containerId.currentValue);e.appendChild(this.mapContainer)}},t.prototype.ngAfterViewInit=function(){var t=this;this.mapLayersService.drawAllLayers(),this.containerId&&setTimeout(function(){var e=t.document.getElementById(t.containerId);if(!e)throw new Error("No element found with id: "+t.containerId);e.appendChild(t.mapContainer)},0)},t.prototype.ngOnDestroy=function(){this.mapContainer.remove(),this.mapsManagerService._removeMapById(this.mapId)},t.prototype.getCesiumService=function(){return this._cesiumService},t.prototype.getCesiumViewer=function(){return this._cesiumService.getViewer()},t.prototype.getCameraService=function(){return this._cameraService},t.prototype.getId=function(){return this.mapId},t.prototype.getMapContainer=function(){return this.mapContainer},t.prototype.getMapEventsManager=function(){return this.mapEventsManager},t.prototype.getContextMenuService=function(){return this.contextMenuService},t.prototype.getScreenshotService=function(){return this.screenshotService},t.prototype.getKeyboardControlService=function(){return this.keyboardControlService},t.prototype.getCoordinateConverter=function(){return this.coordinateConverter},t.decorators=[{type:e.Component,args:[{selector:"ac-map",template:'\n    <ac-default-plonter *ngIf="!disableDefaultPlonter"></ac-default-plonter>\n    <ac-context-menu-wrapper></ac-context-menu-wrapper>\n    <ng-content></ng-content>\n  ',providers:[P,tt,ft,dt,bt,mt,ot,at,pt,nt,rt,q,et,st,Et,B,_t,z,W]}]}],t.ctorParameters=function(){return[{type:P},{type:B},{type:e.ElementRef},{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]},{type:Ct},{type:tt},{type:ot},{type:nt},{type:at},{type:st},{type:q},{type:rt},{type:et},{type:bt},{type:dt},{type:Et},{type:H},{type:_t},{type:z},{type:W}]},t.propDecorators={disableDefaultPlonter:[{type:e.Input}],mapId:[{type:e.Input}],flyTo:[{type:e.Input}],sceneMode:[{type:e.Input}],containerId:[{type:e.Input}]},t}();var It=function(){function t(){this._cache=!0,this.descriptions=[],this.layerUpdate=new e.EventEmitter}return Object.defineProperty(t.prototype,"cache",{get:function(){return this._cache},set:function(t){this._cache=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"zIndex",{get:function(){return this._zIndex},set:function(t){t!==this._zIndex&&this.layerUpdate.emit(),this._zIndex=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){t!==this._show&&this.layerUpdate.emit(),this._show=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"options",{get:function(){return this._options},set:function(t){this._options=t,this.layerUpdate.emit()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this._context},set:function(t){this._context=t,this.layerUpdate.emit()},enumerable:!0,configurable:!0}),t.prototype.setEntityName=function(t){this._entityName=t},t.prototype.getEntityName=function(){return this._entityName},t.prototype.registerDescription=function(t){this.descriptions.indexOf(t)<0&&this.descriptions.push(t)},t.prototype.unregisterDescription=function(t){var e=this.descriptions.indexOf(t);e>-1&&this.descriptions.splice(e,1)},t.prototype.getDescriptions=function(){return this.descriptions},t.prototype.layerUpdates=function(){return this.layerUpdate},t.decorators=[{type:e.Injectable}],t}();var Tt={ADD_UPDATE:0,DELETE:1};Tt[Tt.ADD_UPDATE]="ADD_UPDATE",Tt[Tt.DELETE]="DELETE";var Dt=function(){function t(){this._cache=new Map}return t.prototype.get=function(t,e){if(this._cache.has(t))return this._cache.get(t);var i=e();return this._cache.set(t,i),i},t.prototype.clear=function(){this._cache.clear()},t.decorators=[{type:e.Injectable}],t}();var Mt=function(){function t(){}return t.throwIfAnyNotPresent=function(e,i){i.forEach(function(i){return t.throwIfNotPresent(e,i)})},t.throwIfNotPresent=function(e,i){if(!t.present(e[i]))throw new Error("Error: "+i+" was not given.")},t.present=function(t){return null!=t},t}(),At=function(t){function i(e){return t.call(this,Cesium.PrimitiveCollection,e)||this}return h(i,t),i.prototype.add=function(e){return Mt.throwIfAnyNotPresent(e,["center","semiMajorAxis","semiMinorAxis"]),t.prototype.add.call(this,new a.EllipsePrimitive(e))},i.prototype.update=function(t,e){return t.updateLocationData(e),t},i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),wt=function(t){function i(e){return t.call(this,Cesium.PolylineCollection,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),Lt=function(t){function e(e,i){var n=t.call(this,Cesium.PrimitiveCollection,i)||this;return n.geometryType=e,n}return h(e,t),e.prototype.add=function(e,i,n){i.geometry=new this.geometryType(e),n.geometryInstances=new Cesium.GeometryInstance(i),n.asynchronous=!1;var o=new Cesium.Primitive(n);return t.prototype.add.call(this,o)},e.prototype.update=function(e,i,n,o){return n.geometry=new this.geometryType(i),o.geometryInstances=new Cesium.GeometryInstance(n),this._cesiumCollection.remove(e),t.prototype.add.call(this,new Cesium.Primitive(o))},e}(Y);var Ot=function(t){function i(e){return t.call(this,Cesium.CircleGeometry,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Lt),Rt=function(t){function i(e){return t.call(this,Cesium.PolylineGeometry,e)||this}return h(i,t),i.prototype.update=function(t,e,i,n){var o=i.attributes.color.value;return t.ready?t.getGeometryInstanceAttributes().color=o:Cesium.when(t.readyPromise).then(function(t){t.getGeometryInstanceAttributes().color.value=o}),t},i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Lt),xt=function(t){function i(e){return t.call(this,Cesium.PolygonGeometry,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Lt),Nt=function(t){function i(e){return t.call(this,Cesium.EllipseGeometry,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Lt),jt=function(t){function i(e){return t.call(this,e,X.model)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),Ft=function(t){function i(e){return t.call(this,e,X.box)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),kt=function(t){function i(e){return t.call(this,e,X.corridor)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),Ht=function(t){function i(e){return t.call(this,e,X.cylinder)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),Vt=function(t){function i(e){return t.call(this,e,X.ellipsoid)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),Bt=function(t){function i(e){return t.call(this,e,X.polylineVolume)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),Gt=function(t){function i(e){return t.call(this,e,X.wall)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),Ut=function(t){function i(e){return t.call(this,e,X.rectangle)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Q),zt=function(t){function i(e){return t.call(this,Cesium.LabelCollection,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),Kt=function(t){function i(e){return t.call(this,Cesium.BillboardCollection,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),Wt=function(t){function i(e){return t.call(this,Cesium.PointPrimitiveCollection,e)||this}return h(i,t),i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y),$t=function(t){function i(e){var i=t.call(this,Cesium.HtmlCollection,e)||this;return i._cesiumService=e,i}return h(i,t),i.prototype.add=function(e){return e.scene=this._cesiumService.getScene(),e.mapContainer=this._cesiumService.getMap().getMapContainer(),t.prototype.add.call(this,e)},i.decorators=[{type:e.Injectable}],i.ctorParameters=function(){return[{type:P}]},i}(Y);var Yt=function(){function t(t,e,i,n,o,r,a,p,c,l,u,d,h,y,f,m,g,v,P,b,E,C,_,S,I,T,D,M,A,w){this.layerService=t,this._computationCache=e,this.mapLayersService=i,this.show=!0,this.store=!1,this.zIndex=0,this.debug=!1,this.acForRgx=/^let\s+.+\s+of\s+.+$/,this.stopObservable=new s.Subject,this._updateStream=new s.Subject,this.entitiesStore=new Map,this.layerDrawerDataSources=[],this._drawerList=new Map([["billboard",n],["label",o],["ellipse",r],["polyline",a],["polygon",p],["arc",c],["point",l],["model",u],["box",d],["corridor",h],["cylinder",y],["ellipsoid",f],["polylineVolume",m],["rectangle",v],["wall",g],["polylinePrimitive",I],["labelPrimitive",T],["billboardPrimitive",D],["pointPrimitive",M],["html",A],["czml",w],["dynamicEllipse",P],["dynamicPolyline",b],["staticCircle",E],["staticPolyline",C],["staticPolygon",_],["staticEllipse",S]])}return t.prototype.init=function(){var t=this;this.initValidParams(),s.merge(this._updateStream,this.observable).pipe(r.takeUntil(this.stopObservable)).subscribe(function(e){t._computationCache.clear(),t.debug&&console.log("AcLayer received notification:",e);var i=e.entity;t.store&&(i=t.updateStore(e)),t.context[t.entityName]=i,t.layerService.getDescriptions().forEach(function(n){switch(e.actionType){case Tt.ADD_UPDATE:n.draw(t.context,e.id,i);break;case Tt.DELETE:n.remove(e.id);break;default:console.error("[ac-layer] unknown AcNotification.actionType for notification: "+e)}})})},t.prototype.updateStore=function(t){if(t.actionType!==Tt.DELETE){if(this.entitiesStore.has(t.id)){var e=this.entitiesStore.get(t.id);return Object.assign(e,t.entity),e}return this.entitiesStore.set(t.id,t.entity),t.entity}this.entitiesStore.delete(t.id)},t.prototype.initValidParams=function(){if(!this.context)throw new Error("ac-layer: must initialize [context] ");if(!this.acForRgx.test(this.acFor))throw new Error('ac-layer: Invalid [acFor] syntax. Expected: [acFor]="let item of observable" .Instead received: '+this.acFor);var t=this.acFor.split(" ");if(this.observable=this.context[t[3]],this.entityName=t[1],!this.isObservable(this.observable))throw new Error("ac-layer: must initailize [acFor] with rx observable, instead received: "+this.observable);this.layerService.context=this.context,this.layerService.setEntityName(this.entityName)},t.prototype.isObservable=function(t){return t&&"function"==typeof t.subscribe},t.prototype.ngAfterContentInit=function(){this.init()},t.prototype.ngOnInit=function(){var t=this;this.layerService.context=this.context,this.layerService.options=this.options,this.layerService.show=this.show,this.layerService.zIndex=this.zIndex,this._drawerList.forEach(function(e,i){var n,o=t.options?t.options[i]:void 0,r=e.init(o);r&&(n=t.layerDrawerDataSources).push.apply(n,m(r)),e.setShow(t.show)})},t.prototype.ngOnChanges=function(t){if(t.show&&!t.show.firstChange){var e=t.show.currentValue;this.layerService.show=e,this._drawerList.forEach(function(t){return t.setShow(e)})}if(t.zIndex&&!t.zIndex.firstChange){var i=t.zIndex.currentValue;this.layerService.zIndex=i,this.mapLayersService.updateAndRefresh(this.layerDrawerDataSources,i)}},t.prototype.ngOnDestroy=function(){this.mapLayersService.removeDataSources(this.layerDrawerDataSources),this.stopObservable.next(!0),this.removeAll()},t.prototype.getLayerService=function(){return this.layerService},t.prototype.getLayerDrawerDataSources=function(){return this.layerDrawerDataSources},t.prototype.getDrawerDataSourcesByName=function(t){return this.layerDrawerDataSources.filter(function(e){return e.name===t})},t.prototype.getStore=function(){return this.entitiesStore},t.prototype.removeAll=function(){this.layerService.getDescriptions().forEach(function(t){return t.removeAll()}),this.entitiesStore.clear()},t.prototype.remove=function(t){this._updateStream.next({id:t,actionType:Tt.DELETE}),this.entitiesStore.delete(t)},t.prototype.updateNotification=function(t){this._updateStream.next(t)},t.prototype.update=function(t,e){this._updateStream.next({entity:t,id:e,actionType:Tt.ADD_UPDATE})},t.prototype.refreshAll=function(t){var e=this;s.from(t).subscribe(function(t){return e._updateStream.next(t)})},t.decorators=[{type:e.Component,args:[{selector:"ac-layer",template:"<ng-content></ng-content>",providers:[It,Dt,tt,ot,nt,at,q,rt,st,jt,Ft,kt,Ht,Vt,Bt,Gt,Ut,pt,zt,Kt,Wt,$t,et,At,wt,Ot,Rt,xt,Nt],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:It},{type:Dt},{type:Et},{type:tt},{type:ot},{type:nt},{type:at},{type:st},{type:q},{type:rt},{type:jt},{type:Ft},{type:kt},{type:Ht},{type:Vt},{type:Bt},{type:Gt},{type:Ut},{type:At},{type:wt},{type:Ot},{type:Rt},{type:xt},{type:Nt},{type:pt},{type:zt},{type:Kt},{type:Wt},{type:$t},{type:et}]},t.propDecorators={show:[{type:e.Input}],acFor:[{type:e.Input}],context:[{type:e.Input}],store:[{type:e.Input}],options:[{type:e.Input}],zIndex:[{type:e.Input}],debug:[{type:e.Input}]},t}();var Zt=function(){function t(t,e){this._drawer=t,this.mapLayers=e}return t.prototype.ngOnInit=function(){this.selfPrimitiveIsDraw=!1;var t=this._drawer.init();t&&(this.dataSources=t),this.drawOnMap()},t.prototype.ngOnChanges=function(t){var e=t.props;e.currentValue!==e.previousValue&&this.updateOnMap()},t.prototype.drawOnMap=function(){return this.selfPrimitiveIsDraw=!0,this.selfPrimitive=this._drawer.add(this.props)},t.prototype.removeFromMap=function(){return this.selfPrimitiveIsDraw=!1,this._drawer.remove(this.selfPrimitive)},t.prototype.updateOnMap=function(){if(this.selfPrimitiveIsDraw)return this._drawer.update(this.selfPrimitive,this.props)},t.prototype.ngOnDestroy=function(){this.mapLayers.removeDataSources(this.dataSources),this.removeFromMap()},t.propDecorators={props:[{type:e.Input}]},t}();var qt=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-billboard",template:""}]}],i.ctorParameters=function(){return[{type:tt},{type:Et}]},i}(Zt);var Xt=function(){function t(t,i,n,o){this._drawer=t,this._layerService=i,this._computationCache=n,this._cesiumProperties=o,this.onDraw=new e.EventEmitter,this.onRemove=new e.EventEmitter,this._cesiumObjectsMap=new Map}return t.prototype._propsEvaluator=function(t){return this._propsEvaluateFn(this._computationCache,t)},t.prototype._getPropsAssigner=function(){var t=this;return function(e,i){return t._propsAssignerFn(e,i)}},t.prototype.getLayerService=function(){return this._layerService},t.prototype.setLayerService=function(t){this._layerService.unregisterDescription(this),this._layerService=t,this._layerService.registerDescription(this),this._propsEvaluateFn=this._cesiumProperties.createEvaluator(this.props,this._layerService.cache,!0),this._propsAssignerFn=this._cesiumProperties.createAssigner(this.props)},t.prototype.ngOnInit=function(){this.props||console.error("ac-desc components error: [props] input is mandatory"),this._layerService.registerDescription(this),this._propsEvaluateFn=this._cesiumProperties.createEvaluator(this.props,this._layerService.cache),this._propsAssignerFn=this._cesiumProperties.createAssigner(this.props)},t.prototype.getCesiumObjectsMap=function(){return this._cesiumObjectsMap},t.prototype.draw=function(t,e,i){var n=this._propsEvaluator(t);if(this._cesiumObjectsMap.has(e)){o=this._cesiumObjectsMap.get(e);this.onDraw.emit({acEntity:i,cesiumEntity:o,entityId:e}),o.acEntity=i,this._drawer.setPropsAssigner(this._getPropsAssigner()),this._drawer.update(o,n)}else{var o=this._drawer.add(n);this.onDraw.emit({acEntity:i,cesiumEntity:o,entityId:e}),o.acEntity=i,this._cesiumObjectsMap.set(e,o)}},t.prototype.remove=function(t){var e=this._cesiumObjectsMap.get(t);e&&(this.onRemove.emit({acEntity:e.acEntity,cesiumEntity:e,entityId:t}),this._drawer.remove(e),this._cesiumObjectsMap.delete(t))},t.prototype.removeAll=function(){this._cesiumObjectsMap.clear(),this._drawer.removeAll()},t.prototype.ngOnDestroy=function(){this._layerService.unregisterDescription(this),this.removeAll()},t.propDecorators={props:[{type:e.Input}],onDraw:[{type:e.Output}],onRemove:[{type:e.Output}]},t}();var Jt=function(){function t(){this._mapper=new p.JsonStringMapper}return t.prototype.map=function(t){return this._mapper.map(t)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var Qt=function(){function t(){}return t.create=function(t,e){void 0===t&&(t=[]),void 0===e&&(e=!0);var i="";t.forEach(function(t){i+=e?"if(!(obj1['"+t+"'] instanceof Cesium.CallbackProperty))obj1['"+t+"'] = obj2['"+t+"']; ":"if (!(obj1['"+t+"'] instanceof Cesium.CallbackProperty) && obj2['"+t+"'] !== undefined) { obj1['"+t+"'] = obj2['"+t+"']; } "}),i+="return obj1";var n=new Function("obj1","obj2",i);return function(t,e){return n(t,e)}},t}(),te=function(){function t(t,e){this._parser=t,this._jsonMapper=e,this._assignersCache=new Map,this._evaluatorsCache=new Map}return t.prototype._compile=function(t,e){var i=this;void 0===e&&(e=!0);var n={},o=new Map;this._jsonMapper.map(t).forEach(function(t,e){return o.set(e,{expression:t,get:i._parser.eval(t)})}),o.forEach(function(t,i){n[i||"undefined"]=e?"cache.get(`"+t.expression+"`, () => propsMap.get('"+i+"').get(context))":"propsMap.get('"+i+"').get(context)"});var r="return "+JSON.stringify(n).replace(/"/g,"")+";",s=new Function("propsMap","cache","context",r);return function(t,e){return s(o,t,e)}},t.prototype._build=function(t){var e=Array.from(this._jsonMapper.map(t).keys()),i=Qt.create(e);return function(t,e){return i(t,e)}},t.prototype.createEvaluator=function(t,e,i){if(void 0===e&&(e=!0),void 0===i&&(i=!1),!i&&this._evaluatorsCache.has(t))return this._evaluatorsCache.get(t);var n=this._compile(t,e);return this._evaluatorsCache.set(t,n),n},t.prototype.createAssigner=function(t){if(this._assignersCache.has(t))return this._assignersCache.get(t);var e=this._build(t);return this._assignersCache.set(t,e),e},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:c.Parse},{type:Jt}]},t}();var ee=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-billboard-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:tt},{type:It},{type:Dt},{type:te}]},i}(Xt),ie=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-ellipse-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:nt},{type:It},{type:Dt},{type:te}]},i}(Xt),ne=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-polyline-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:at},{type:It},{type:Dt},{type:te}]},i}(Xt),oe=function(){function t(){}return t.prototype.transform=function(t,e){return new Cesium.Cartesian2(t[0],t[1])},t.decorators=[{type:e.Pipe,args:[{name:"pixelOffset"}]}],t}(),re=function(){function t(){}return t.prototype.transform=function(t,e){return(360-Math.round(180*t/Math.PI))%360},t.decorators=[{type:e.Pipe,args:[{name:"radiansToDegrees"}]}],t}(),se=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-label-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:ot},{type:It},{type:Dt},{type:te}]},i}(Xt),ae=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule],providers:[]}]}],t}(),pe=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.prototype._propsEvaluator=function(e){var i=t.prototype._propsEvaluator.call(this,e);return i.semiMajorAxis=i.radius,i.semiMinorAxis=i.radius,delete i.radius,i},i.prototype._getPropsAssigner=function(){return function(t,e){return Object.assign(t,e)}},i.decorators=[{type:e.Component,args:[{selector:"ac-circle-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:nt},{type:It},{type:Dt},{type:te}]},i}(Xt),ce=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-arc-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:q},{type:It},{type:Dt},{type:te}]},i}(Xt),le=function(){function t(t){Object.assign(this,t)}return t.create=function(e){return e?Object.assign(new t,e):new t},t}(),ue=function(){};var de={ArcGisMapServer:Cesium.ArcGisMapServerImageryProvider,WebMapTileService:Cesium.WebMapTileServiceImageryProvider,MapTileService:Cesium.createTileMapServiceImageryProvider,WebMapService:Cesium.WebMapServiceImageryProvider,SingleTileImagery:Cesium.SingleTileImageryProvider,OpenStreetMap:Cesium.createOpenStreetMapImageryProvider,BingMaps:Cesium.BingMapsImageryProvider,GoogleEarthEnterpriseMaps:Cesium.GoogleEarthEnterpriseMapsProvider,MapBox:Cesium.MapboxImageryProvider,UrlTemplateImagery:Cesium.UrlTemplateImageryProvider,OFFLINE:null},he=function(){function t(t){this.cesiumService=t,this.options={},this.provider=de.OFFLINE,this.show=!0,this.alpha=1,this.brightness=1,this.contrast=1,this.imageryLayersCollection=this.cesiumService.getScene().imageryLayers}return t.prototype.createOfflineMapProvider=function(){return Cesium.createTileMapServiceImageryProvider({url:Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII")})},t.prototype.ngOnInit=function(){if(!Mt.present(this.options.url)&&this.provider!==de.OFFLINE)throw new Error("options must have a url");switch(this.provider){case de.WebMapService:case de.WebMapTileService:case de.ArcGisMapServer:case de.SingleTileImagery:case de.BingMaps:case de.GoogleEarthEnterpriseMaps:case de.MapBox:case de.UrlTemplateImagery:this.layerProvider=new this.provider(this.options);break;case de.MapTileService:case de.OpenStreetMap:this.layerProvider=this.provider(this.options);break;case de.OFFLINE:this.layerProvider=this.createOfflineMapProvider();break;default:console.log("ac-map-layer-provider: [provider] wasn't found. setting OFFLINE provider as default"),this.layerProvider=this.createOfflineMapProvider()}this.show&&(this.imageryLayer=this.imageryLayersCollection.addImageryProvider(this.layerProvider,this.index),this.imageryLayer.alpha=this.alpha,this.imageryLayer.contrast=this.contrast,this.imageryLayer.brightness=this.brightness)},t.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.imageryLayer?this.imageryLayersCollection.add(this.imageryLayer,this.index):(this.imageryLayer=this.imageryLayersCollection.addImageryProvider(this.layerProvider,this.index),this.imageryLayer.alpha=this.alpha,this.imageryLayer.contrast=this.contrast,this.imageryLayer.brightness=this.brightness):this.imageryLayer&&this.imageryLayersCollection.remove(this.imageryLayer,!1));t.alpha&&!t.alpha.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.alpha=this.alpha),t.contrast&&!t.contrast.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.contrast=this.contrast),t.brightness&&!t.brightness.isFirstChange()&&this.imageryLayer&&(this.imageryLayer.brightness=this.brightness)},t.prototype.ngOnDestroy=function(){this.imageryLayer&&this.imageryLayersCollection.remove(this.imageryLayer,!0)},t.decorators=[{type:e.Component,args:[{selector:"ac-map-layer-provider",template:""}]}],t.ctorParameters=function(){return[{type:P}]},t.propDecorators={options:[{type:e.Input}],provider:[{type:e.Input}],index:[{type:e.Input}],show:[{type:e.Input}],alpha:[{type:e.Input}],brightness:[{type:e.Input}],contrast:[{type:e.Input}]},t}();var ye=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-point-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:rt},{type:It},{type:Dt},{type:te}]},i}(Xt),fe=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-label",template:""}]}],i.ctorParameters=function(){return[{type:ot},{type:Et}]},i}(Zt),me=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-polyline",template:""}]}],i.ctorParameters=function(){return[{type:at},{type:Et}]},i}(Zt),ge=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-ellipse",template:""}]}],i.ctorParameters=function(){return[{type:nt},{type:Et}]},i}(Zt),ve=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-point",template:""}]}],i.ctorParameters=function(){return[{type:rt},{type:Et}]},i}(Zt),Pe=function(){function t(t,e,i){this.cesiumService=t,this.elementRef=e,this.renderer=i,this.isDraw=!1}return t.prototype.setScreenPosition=function(t){t&&(this.renderer.setStyle(this.elementRef.nativeElement,"top",t.y+"px"),this.renderer.setStyle(this.elementRef.nativeElement,"left",t.x+"px"))},t.prototype.ngOnInit=function(){this.cesiumService.getMap().getMapContainer().appendChild(this.elementRef.nativeElement),!1===this.props.show&&this.hideElement()},t.prototype.remove=function(){this.isDraw&&(this.isDraw=!1,this.cesiumService.getScene().preRender.removeEventListener(this.preRenderEventListener),this.hideElement())},t.prototype.hideElement=function(){this.renderer.setStyle(this.elementRef.nativeElement,"display","none")},t.prototype.add=function(){var t=this;this.isDraw||(this.isDraw=!0,this.preRenderEventListener=function(){var e=Cesium.SceneTransforms.wgs84ToWindowCoordinates(t.cesiumService.getScene(),t.props.position);t.setScreenPosition(e)},this.renderer.setStyle(this.elementRef.nativeElement,"display","block"),this.cesiumService.getScene().preRender.addEventListener(this.preRenderEventListener))},t.prototype.ngDoCheck=function(){void 0===this.props.show||this.props.show?this.add():this.remove()},t.prototype.ngOnDestroy=function(){this.remove()},t.decorators=[{type:e.Component,args:[{selector:"ac-html",template:"<ng-content></ng-content>",styles:[":host {\n                position: absolute;\n                z-index: 100;\n\t\t\t\t}"]}]}],t.ctorParameters=function(){return[{type:P},{type:e.ElementRef},{type:e.Renderer2}]},t.propDecorators={props:[{type:e.Input}]},t}();var be=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.prototype.updateEllipseProps=function(){this.props.semiMajorAxis=this.props.radius,this.props.semiMinorAxis=this.props.radius,this.props.rotation=0},i.prototype.drawOnMap=function(){this.updateEllipseProps(),t.prototype.drawOnMap.call(this)},i.prototype.updateOnMap=function(){this.updateEllipseProps(),t.prototype.updateOnMap.call(this)},i.decorators=[{type:e.Component,args:[{selector:"ac-circle",template:""}]}],i.ctorParameters=function(){return[{type:nt},{type:Et}]},i}(Zt),Ee=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.prototype.updateOnMap=function(){this.selfPrimitiveIsDraw&&(this.removeFromMap(),this.drawOnMap())},i.prototype.drawOnMap=function(){return this.selfPrimitiveIsDraw=!0,this.selfPrimitive=this._drawer.add(this.geometryProps,this.instanceProps,this.primitiveProps)},i.prototype.ngOnChanges=function(t){var e=t.geometryProps,i=t.instanceProps,n=t.primitiveProps;e.currentValue===e.previousValue&&i.currentValue===i.previousValue&&n.currentValue===n.previousValue||this.updateOnMap()},i.decorators=[{type:e.Component,args:[{selector:"ac-arc",template:""}]}],i.ctorParameters=function(){return[{type:q},{type:Et}]},i.propDecorators={geometryProps:[{type:e.Input}],instanceProps:[{type:e.Input}],primitiveProps:[{type:e.Input}]},i}(Zt);var Ce=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-polygon-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:st},{type:It},{type:Dt},{type:te}]},i}(Xt),_e=function(){function t(t,e,i){this.plonterService=t,this.cd=e,this.geoConverter=i}return t.prototype.ngOnInit=function(){var t=this;this.plonterService.plonterChangeNotifier.subscribe(function(){return t.cd.detectChanges()})},Object.defineProperty(t.prototype,"plonterPosition",{get:function(){if(this.plonterService.plonterShown){var t=this.plonterService.plonterClickPosition.endPosition;return this.geoConverter.screenToCartesian3(t)}},enumerable:!0,configurable:!0}),t.prototype.chooseEntity=function(t){this.plonterService.resolvePlonter(t)},t.decorators=[{type:e.Component,args:[{selector:"ac-default-plonter",template:'\n      <ac-html *ngIf="plonterService.plonterShown" [props]="{\n        position: plonterPosition\n      }">\n        <div class="plonter-context-menu">\n          <div *ngFor="let entity of plonterService.entitesToPlonter">\n            <div class="plonter-item" (click)="chooseEntity(entity)">{{ entity?.name || entity?.id }}\n            </div>\n          </div>\n        </div>\n      </ac-html>\n    ',changeDetection:e.ChangeDetectionStrategy.OnPush,providers:[W],styles:["\n        .plonter-context-menu {\n            background-color: rgba(250, 250, 250, 0.8);\n            box-shadow: 1px 1px 5px 0px rgba(0, 0, 0, 0.15);\n        }\n\n        .plonter-item {\n            cursor: pointer;\n            padding: 2px 15px;\n            text-align: start;\n        }\n\n        .plonter-item:hover {\n            background-color: rgba(0, 0, 0, 0.15);\n        }\n\n    "]}]}],t.ctorParameters=function(){return[{type:mt},{type:e.ChangeDetectorRef},{type:W}]},t}();var Se=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-polygon",template:""}]}],i.ctorParameters=function(){return[{type:st},{type:Et}]},i}(Zt),Ie=function(t){function i(e,i,n,o){var r=t.call(this,e,i,n,o)||this;return r._staticPrimitiveDrawer=e,r}return h(i,t),i.prototype.ngOnInit=function(){this._layerService.registerDescription(this),this._geometryPropsEvaluator=this._cesiumProperties.createEvaluator(this.geometryProps),this._instancePropsEvaluator=this._cesiumProperties.createEvaluator(this.instanceProps),this._primitivePropsEvaluator=this._cesiumProperties.createEvaluator(this.primitiveProps)},i.prototype.draw=function(t,e,i){var n=this._geometryPropsEvaluator(this._computationCache,t),o=this._instancePropsEvaluator(this._computationCache,t),r=this._primitivePropsEvaluator(this._computationCache,t);if(this._cesiumObjectsMap.has(e)){s=this._cesiumObjectsMap.get(e);this._staticPrimitiveDrawer.update(s,n,o,r)}else{var s;(s=this._staticPrimitiveDrawer.add(n,o,r)).acEntity=i,this._cesiumObjectsMap.set(e,s)}},i.propDecorators={geometryProps:[{type:e.Input}],instanceProps:[{type:e.Input}],primitiveProps:[{type:e.Input}]},i}(Xt);var Te=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-static-ellipse-desc",template:""}]}],i.ctorParameters=function(){return[{type:Nt},{type:It},{type:Dt},{type:te}]},i}(Ie),De=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-dynamic-ellipse-desc",template:""}]}],i.ctorParameters=function(){return[{type:At},{type:It},{type:Dt},{type:te}]},i}(Xt),Me=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-dynamic-polyline-desc",template:""}]}],i.ctorParameters=function(){return[{type:wt},{type:It},{type:Dt},{type:te}]},i}(Xt),Ae=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-static-polygon-desc",template:""}]}],i.ctorParameters=function(){return[{type:xt},{type:It},{type:Dt},{type:te}]},i}(Ie),we=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-static-circle",template:""}]}],i.ctorParameters=function(){return[{type:Ot},{type:It},{type:Dt},{type:te}]},i}(Ie),Le=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.prototype._propsEvaluator=function(e){var i=t.prototype._propsEvaluator.call(this,e);return i.semiMajorAxis=i.radius,i.semiMinorAxis=i.radius,i},i.decorators=[{type:e.Component,args:[{selector:"ac-dynamic-circle-desc",template:""}]}],i.ctorParameters=function(){return[{type:At},{type:It},{type:Dt},{type:te}]},i}(Xt),Oe=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-static-polyline-desc",template:""}]}],i.ctorParameters=function(){return[{type:Rt},{type:It},{type:Dt},{type:te}]},i}(Ie),Re=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-model-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:jt},{type:It},{type:Dt},{type:te}]},i}(Xt),xe=function(){function t(t){this.cesiumService=t,this.options={},this.show=!0,this.tilesetInstance=null}return t.prototype.ngOnInit=function(){if(!Mt.present(this.options.url))throw new Error("Options must have a url");this._3dtilesCollection=new Cesium.PrimitiveCollection,this.cesiumService.getScene().primitives.add(this._3dtilesCollection),this.show&&(this.tilesetInstance=this._3dtilesCollection.add(new Cesium.Cesium3DTileset(this.options),this.index),this.style&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style)))},t.prototype.ngOnChanges=function(t){t.show&&!t.show.isFirstChange()&&(t.show.currentValue?this.tilesetInstance?this._3dtilesCollection.add(this.tilesetInstance,this.index):(this.tilesetInstance=this._3dtilesCollection.add(new Cesium.Cesium3DTileset(this.options),this.index),this.style&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style))):this.tilesetInstance&&this._3dtilesCollection.remove(this.tilesetInstance,!1));if(t.style&&!t.style.isFirstChange()){t.style.currentValue;this.tilesetInstance&&(this.tilesetInstance.style=new Cesium.Cesium3DTileStyle(this.style))}},t.prototype.ngOnDestroy=function(){this.tilesetInstance&&this._3dtilesCollection.remove(this.tilesetInstance,!1)},t.decorators=[{type:e.Component,args:[{selector:"ac-3d-tile-layer",template:""}]}],t.ctorParameters=function(){return[{type:P}]},t.propDecorators={options:[{type:e.Input}],index:[{type:e.Input}],show:[{type:e.Input}],style:[{type:e.Input}]},t}();var Ne=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-box-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:Ft},{type:It},{type:Dt},{type:te}]},i}(Xt),je=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-cylinder-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:Ht},{type:It},{type:Dt},{type:te}]},i}(Xt),Fe=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-corridor-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:kt},{type:It},{type:Dt},{type:te}]},i}(Xt),ke=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-ellipsoid-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:Vt},{type:It},{type:Dt},{type:te}]},i}(Xt),He=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-polyline-volume-desc",template:""}]}],i.ctorParameters=function(){return[{type:Bt},{type:It},{type:Dt},{type:te}]},i}(Xt),Ve=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-wall-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:Gt},{type:It},{type:Dt},{type:te}]},i}(Xt),Be=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-rectangle-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:Ut},{type:It},{type:Dt},{type:te}]},i}(Xt),Ge=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-billboard-primitive-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:Kt},{type:It},{type:Dt},{type:te}]},i}(Xt),Ue=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-label-primitive-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:zt},{type:It},{type:Dt},{type:te}]},i}(Xt),ze=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-polyline-primitive-desc",template:"",providers:[{provide:Xt,useExisting:e.forwardRef(function(){return i})}]}]}],i.ctorParameters=function(){return[{type:pt},{type:It},{type:Dt},{type:te}]},i}(Xt),Ke=function(){function t(t,e){if(void 0===e&&(e=null),"object"!=typeof t)throw new Error("HtmlPrimitive ERROR: invalid html options!");this.scene=t.scene,this._mapContainer=t.mapContainer,this.show=t.show||!0,this.position=t.position,this.pixelOffset=t.pixelOffset,this.element=t.element,this.collection=e}return Object.defineProperty(t.prototype,"scene",{set:function(t){this._scene=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"show",{get:function(){return this._show},set:function(t){this._show=t,Cesium.defined(this.element)&&(this._element.style.display=t?"block":"none")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"position",{get:function(){return this._position},set:function(t){this._position=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"pixelOffset",{get:function(){return this._pixelOffset},set:function(t){this._pixelOffset=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"element",{get:function(){return this._element},set:function(t){this._element=t,Cesium.defined(t)&&(this._mapContainer.appendChild(t),this._element.style.position="absolute",this._element.style.zIndex=Number.MAX_VALUE.toString())},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"collection",{get:function(){return this._collection},set:function(t){this._collection=t},enumerable:!0,configurable:!0}),t.prototype.update=function(){if(Cesium.defined(this._show)&&Cesium.defined(this._element)){var t=Cesium.SceneTransforms.wgs84ToWindowCoordinates(this._scene,this._position);Cesium.defined(t)?Cesium.defined(this._pixelOffset)&&Cesium.defined(this._pixelOffset.x)&&Cesium.defined(this._pixelOffset.y)&&(t.y+=this._pixelOffset.y,t.x+=this._pixelOffset.x):t=new Cesium.Cartesian2(-1e3,-1e3),this._lastPosition&&this._lastPosition.equals(t)||(this._element.style.top=t.y+"px",this._element.style.left=t.x+"px",this._lastPosition=t)}},t.prototype.remove=function(){this._element&&this._element.remove()},t}();var We=function(){function t(){this._collection=[]}return Object.defineProperty(t.prototype,"length",{get:function(){return this._collection.length},enumerable:!0,configurable:!0}),t.prototype.get=function(t){return this._collection[t]},t.prototype.add=function(t){var e=new Ke(t,this);return this._collection.push(e),e},t.prototype.remove=function(t){var e=this._collection.indexOf(t);return-1!==e&&(this._collection[e].remove(),this._collection.splice(e,1),!0)},t.prototype.update=function(){for(var t=0,e=this._collection.length;t<e;t++)this._collection[t].update()},t.prototype.removeAll=function(){for(;this._collection.length>0;){this._collection.pop().remove()}},t.prototype.contains=function(t){return Cesium.defined(t)&&t.collection===this},t}();var $e=function(){function t(){}return t.extend=function(){Cesium.HtmlPrimitive=Ke,Cesium.HtmlCollection=We},t}(),Ye=function(){function t(){this._entities=new Map}return t.prototype.has=function(t){return this._entities.has(t)},t.prototype.get=function(t){return this._entities.get(t)},t.prototype.addOrUpdate=function(t,e){this._entities.set(t,e)},t.prototype.remove=function(t){this._entities.delete(t)},t.prototype.forEach=function(t){this._entities.forEach(t)},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[]},t}();var Ze=function(t,e){this.id=t,this.context=e};var qe=function(){function t(t,e,i,n,o){this._templateRef=t,this._viewContainerRef=e,this._changeDetector=i,this._layerService=n,this._acHtmlManager=o,this._views=new Map}return t.prototype.ngOnInit=function(){},t.prototype._handleView=function(t,e,i){if(!this._views.has(t)&&e.show){var n=new Ze(t,{$implicit:i}),o=this._viewContainerRef.createEmbeddedView(this._templateRef,n);this._views.set(t,{viewRef:o,context:n}),this._changeDetector.detectChanges()}else this._views.has(t)&&!e.show?this.remove(t,e):this._views.has(t)&&e.show&&this._changeDetector.detectChanges()},t.prototype.addOrUpdate=function(t,e){var i=this._layerService.context[this._layerService.getEntityName()];this._views.has(t)&&(this._views.get(t).context.context.$implicit=i),this._acHtmlManager.addOrUpdate(t,{entity:i,primitive:e}),this._handleView(t,e,i)},t.prototype.remove=function(t,e){if(this._views.has(t)){var i=this._views.get(t).viewRef;this._viewContainerRef.remove(this._viewContainerRef.indexOf(i)),this._views.delete(t),this._acHtmlManager.remove(t),e.element=null}},t.decorators=[{type:e.Directive,args:[{selector:"[acHtml]"}]}],t.ctorParameters=function(){return[{type:e.TemplateRef},{type:e.ViewContainerRef},{type:e.ChangeDetectorRef},{type:It},{type:Ye}]},t}();var Xe=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.prototype.ngOnInit=function(){if(t.prototype.ngOnInit.call(this),!this.acHtmlCreator)throw new Error("AcHtml desc ERROR: ac html directive not found.");if(!this.acHtmlTemplate)throw new Error("AcHtml desc ERROR: html template not found.")},i.prototype.draw=function(t,e){var i=this._propsEvaluator(t);if(this._cesiumObjectsMap.has(e)){n=this._cesiumObjectsMap.get(e);this._drawer.update(n,i),this.acHtmlCreator.addOrUpdate(e,n)}else{var n=this._drawer.add(i);this._cesiumObjectsMap.set(e,n),this.acHtmlCreator.addOrUpdate(e,n)}},i.prototype.remove=function(t){var e=this._cesiumObjectsMap.get(t);this._drawer.remove(e),this._cesiumObjectsMap.delete(t),this.acHtmlCreator.remove(t,e)},i.prototype.removeAll=function(){var t=this;this._cesiumObjectsMap.forEach(function(e,i){t.acHtmlCreator.remove(i,e)}),this._cesiumObjectsMap.clear(),this._drawer.removeAll()},i.decorators=[{type:e.Component,args:[{selector:"ac-html-desc",providers:[Ye],template:'\n      <div *acHtml="let acHtmlEntityId = id; let acHtmlContext = context">\n          <div [acHtmlContainer]="acHtmlEntityId">\n              <ng-template [ngTemplateOutlet]="acHtmlTemplate"\n                           [ngTemplateOutletContext]="acHtmlContext"></ng-template>\n          </div>\n      </div>'}]}],i.ctorParameters=function(){return[{type:$t},{type:It},{type:Dt},{type:te}]},i.propDecorators={acHtmlCreator:[{type:e.ViewChild,args:[qe,{static:!0}]}],acHtmlTemplate:[{type:e.ContentChild,args:[e.TemplateRef,{static:!0}]}]},i}(Xt);var Je=function(){function t(t,e){this._element=t,this._acHtmlManager=e}return Object.defineProperty(t.prototype,"acHtmlContainer",{set:function(t){this._id=t},enumerable:!0,configurable:!0}),t.prototype.ngOnInit=function(){if(void 0===this._id)throw new Error("AcHtml container ERROR: entity id not defined");this._acHtmlManager.get(this._id).primitive.element=this._element.nativeElement},t.decorators=[{type:e.Directive,args:[{selector:"[acHtmlContainer]"}]}],t.ctorParameters=function(){return[{type:e.ElementRef},{type:Ye}]},t.propDecorators={acHtmlContainer:[{type:e.Input}]},t}();var Qe=function(){function t(t,e,i){this.contextMenuService=t,this.cd=e,this.componentFactoryResolver=i}return t.prototype.ngOnInit=function(){var t=this;this.contextMenuChangeSubscription=this.contextMenuService.contextMenuChangeNotifier.subscribe(function(){return t.cd.detectChanges()}),this.contextMenuOpenSubscription=this.contextMenuService.onOpen.subscribe(function(){var e=t.componentFactoryResolver.resolveComponentFactory(t.contextMenuService.content);t.viewContainerRef.clear(),t.viewContainerRef.createComponent(e).instance.data=t.contextMenuService.options.data,t.cd.detectChanges()})},t.prototype.ngOnDestroy=function(){this.contextMenuChangeSubscription&&this.contextMenuChangeSubscription.unsubscribe(),this.contextMenuOpenSubscription&&this.contextMenuOpenSubscription.unsubscribe()},t.decorators=[{type:e.Component,args:[{selector:"ac-context-menu-wrapper",template:'\n    <ac-html *ngIf="contextMenuService.showContextMenu" [props]="{position: contextMenuService.position}">\n      <div #contextMenuContainer></div>\n    </ac-html>\n  ',changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:z},{type:e.ChangeDetectorRef},{type:e.ComponentFactoryResolver}]},t.propDecorators={viewContainerRef:[{type:e.ViewChild,args:["contextMenuContainer",{static:!1,read:e.ViewContainerRef}]}]},t}();var ti=function(){function t(t,e){this.layerService=t,this.cd=e,this.show=!0,this.entitiesMap=new Map,this.id=0,this.acForRgx=/^let\s+.+\s+of\s+.+$/,this.arrayObservable$=new s.Subject}return t.prototype.ngOnChanges=function(t){if(t.acFor.firstChange){var e=t.acFor.currentValue;if(!this.acForRgx.test(e))throw new Error('ac-layer: Invalid [acFor] syntax. Expected: [acFor]="let item of observable" .Instead received: '+e);var i=t.acFor.currentValue.split(" ");this.arrayPath=i[3],this.entityName=i[1]}},t.prototype.ngOnInit=function(){var t=this;this.layer&&(this.layer.getLayerService().cache=!1),this.layerServiceSubscription=this.layerService.layerUpdates().subscribe(function(){t.cd.detectChanges()})},t.prototype.ngAfterContentInit=function(){var t=this;this.layerService.context.arrayObservable$=this.arrayObservable$,this.layerService.registerDescription(this),this.basicDescs._results.forEach(function(e){e.setLayerService(t.layer.getLayerService())}),this.arrayDescs._results.splice(0,1),this.arrayDescs._results.forEach(function(e){t.layerService.unregisterDescription(e),t.layer.getLayerService().registerDescription(e),e.layerService=t.layer.getLayerService(),e.setLayerService(t.layer.getLayerService())})},t.prototype.ngOnDestroy=function(){this.layerServiceSubscription&&this.layerServiceSubscription.unsubscribe()},t.prototype.setLayerService=function(t){this.layerService=t},t.prototype.draw=function(t,e,i){var n=this,o=l(t,this.arrayPath);if(o){var r=this.entitiesMap.get(e),s=[];if(this.entitiesMap.set(e,s),o.forEach(function(t,o){n.layerService.context[n.entityName]=t;var r=n.generateCombinedId(e,t,o);s.push(r),n.layer.update(i,r)}),r){var a=this.idGetter?r.filter(function(t){return s.indexOf(t)<0}):r;a&&a.forEach(function(t){return n.layer.remove(t)})}}},t.prototype.remove=function(t){var e=this,i=this.entitiesMap.get(t);i&&i.forEach(function(t){return e.layer.remove(t)}),this.entitiesMap.delete(t)},t.prototype.removeAll=function(){this.layer.removeAll(),this.entitiesMap.clear()},t.prototype.getAcForString=function(){return"let "+this.entityName+"___temp of arrayObservable$"},t.prototype.generateCombinedId=function(t,e,i){return t+(this.idGetter?this.idGetter(e,i):this.id++%Number.MAX_SAFE_INTEGER)},t.decorators=[{type:e.Component,args:[{selector:"ac-array-desc",template:'\n    <ac-layer #layer [acFor]="getAcForString()"\n              [context]="layerService.context"\n              [options]="layerService.options"\n              [show]="layerService.show && show"\n              [zIndex]="layerService.zIndex">\n      <ng-content #content></ng-content>\n    </ac-layer>\n  ',changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:It},{type:e.ChangeDetectorRef}]},t.propDecorators={acFor:[{type:e.Input}],idGetter:[{type:e.Input}],show:[{type:e.Input}],layer:[{type:e.ViewChild,args:["layer",{static:!0}]}],basicDescs:[{type:e.ContentChildren,args:[Xt,{descendants:!1}]}],arrayDescs:[{type:e.ContentChildren,args:[t,{descendants:!1}]}]},t}();var ei=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-point-primitive-desc",template:""}]}],i.ctorParameters=function(){return[{type:Wt},{type:It},{type:Dt},{type:te}]},i}(Xt),ii=function(t){function i(e,i){return t.call(this,e,i)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-primitive-polyline",template:""}]}],i.ctorParameters=function(){return[{type:pt},{type:Et}]},i}(Zt),ni=[{pipeName:"pixelOffset",pipeInstance:new oe},{pipeName:"radiansToDegrees",pipeInstance:new re}],oi=function(t){function i(e,i,n,o){return t.call(this,e,i,n,o)||this}return h(i,t),i.decorators=[{type:e.Component,args:[{selector:"ac-czml-desc",template:""}]}],i.ctorParameters=function(){return[{type:et},{type:It},{type:Dt},{type:te}]},i}(Xt),ri=function(){function t(){$e.extend()}return t.forRoot=function(e){return{ngModule:t,providers:[Jt,te,Z,g,Ct,H,{provide:k,useValue:e},{provide:c.PIPES_CONFIG,multi:!0,useValue:e&&e.customPipes||[]},{provide:c.PIPES_CONFIG,multi:!0,useValue:ni}]}},t.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule,c.Angular2ParseModule,ae],declarations:[St,Yt,qt,ee,Ge,se,Ue,ie,ne,ze,oe,re,pe,ce,he,ye,fe,me,ii,ge,ve,qt,Pe,be,Ee,Ce,Se,_e,Re,xe,Ne,je,Fe,ke,He,Ve,Be,Qe,ei,Xe,qe,Je,ti,oi,Te,De,Me,Oe,Le,we,Ae],exports:[St,qt,ee,Ge,se,Ue,ie,ne,ze,Yt,pe,ce,he,ye,fe,me,ii,ge,ve,qt,Pe,be,Ee,Ce,Se,_e,Re,xe,Ne,je,Fe,ke,He,Ve,Be,Qe,ei,Xe,ti,oi,Te,De,Me,Oe,Le,we,Ae]}]}],t.ctorParameters=function(){return[]},t}(),si=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(s.Observable);var ai={ALT:Cesium.KeyboardEventModifier.ALT,CTRL:Cesium.KeyboardEventModifier.CTRL,SHIFT:Cesium.KeyboardEventModifier.SHIFT};var pi=function(){function t(t){this.mapsManager=t,this.selectedEntitiesItems$=new s.BehaviorSubject([]),this.selectedEntitySubject$=new s.Subject}return t.prototype.selectedEntities$=function(){return this.selectedEntitiesItems$.asObservable()},t.prototype.selectedEntities=function(){return this.selectedEntitiesItems$.getValue()},t.prototype.selectedEntity$=function(){return this.selectedEntitySubject$},t.prototype.toggleSelection=function(t,e){-1===this.selectedEntities().indexOf(t)?this.addToSelected(t,e):this.removeSelected(t,e)},t.prototype.addToSelected=function(t,e){e&&(t.selected=!0);var i=this.selectedEntities();this.selectedEntitySubject$.next(t),this.selectedEntitiesItems$.next(m(i,[t]))},t.prototype.removeSelected=function(t,e){e&&(t.selected=!1);var i=this.selectedEntities(),n=i.indexOf(t);-1!==n&&(i.splice(n,1),this.selectedEntitiesItems$.next(i),this.selectedEntitySubject$.next(t))},t.prototype.initSelection=function(t,e,i,n){var o=this;void 0===e&&(e=!0);var s=this.mapsManager.getMap(n);s&&(this.mapEventsManagerService=s.getMapEventsManager(),t||Object.assign(t,{event:G.LEFT_CLICK}),this.mapEventsManagerService.register({event:t.event,pick:U.PICK_ONE,modifier:t.modifier,entityType:t.entityType,priority:i}).pipe(r.map(function(t){return t.entities}),r.filter(function(t){return t&&t.length>0})).subscribe(function(t){var i=t[0];o.toggleSelection(i,e)}))},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:Ct}]},t}();if(!u)throw new Error("must install heatmap.js. please do npm -i heatmap.js ");var ci=function(){function t(){this.heatmapOptionsDefaults={minCanvasSize:700,maxCanvasSize:2e3,radiusFactor:60,spacingFactor:1,maxOpacity:.8,minOpacity:.1,blur:.85,gradient:{".3":"blue",".65":"yellow",".8":"orange",".95":"red"}},this.WMP=new Cesium.WebMercatorProjection,this.wgs84PointToHeatmapPoint=function(t){return this.mercatorPointToHeatmapPoint(this.wgs84ToMercator(t))},this.rad2deg=function(t){return t/(Math.PI/180)}}return t.calcCircleContainingRect=function(e,i){return t.calcEllipseContainingRect(e,i,i)},t.calcEllipseContainingRect=function(t,e,i){var n=[Z.pointByLocationDistanceAndAzimuth(t,i,0,!0),Z.pointByLocationDistanceAndAzimuth(t,e,Math.PI/2,!0),Z.pointByLocationDistanceAndAzimuth(t,e,Math.PI,!0),Z.pointByLocationDistanceAndAzimuth(t,e,1.5*Math.PI,!0)];return Cesium.Rectangle.fromCartesianArray(n)},t.calculateContainingRectFromPoints=function(t){return Cesium.Rectangle.fromCartesianArray(t)},t.prototype.setData=function(t,e,i){return!!(i&&i.length>0&&null!==t&&!1!==t&&null!==e&&!1!==e)&&(this.heatmap.setData({min:t,max:e,data:i}),!0)},t.prototype.setWGS84Data=function(t,e,i){if(i&&i.length>0&&null!==t&&!1!==t&&null!==e&&!1!==e){for(var n=[],o=0;o<i.length;o++){var r=i[o],s=this.wgs84PointToHeatmapPoint(r);(r.value||0===r.value)&&(s.value=r.value),n.push(s)}return this.setData(t,e,n)}return!1},t.prototype.mercatorPointToHeatmapPoint=function(t){var e={};return e.x=Math.round((t.x-this._xoffset)/this._factor+this._spacing),e.y=Math.round((t.y-this._yoffset)/this._factor+this._spacing),e.y=this.height-e.y,e},t.prototype.createContainer=function(e,i){var n="heatmap"+t.containerCanvasCounter++,o=document.createElement("div");return o.setAttribute("id",n),o.setAttribute("style","width: "+i+"px; height: "+e+"px; margin: 0px; display: none;"),document.body.appendChild(o),{container:o,id:n}},t.prototype.wgs84ToMercator=function(t){var e=this.WMP.project(Cesium.Cartographic.fromDegrees(t.x,t.y));return{x:e.x,y:e.y}},t.prototype.wgs84ToMercatorBB=function(t){var e=this.WMP.project(Cesium.Cartographic.fromRadians(t.west,t.south)),i=this.WMP.project(Cesium.Cartographic.fromRadians(t.east,t.north));return{north:i.y,east:i.x,south:e.y,west:e.x}},t.prototype.mercatorToWgs84BB=function(t){var e=this.WMP.unproject(new Cesium.Cartesian3(t.west,t.south)),i=this.WMP.unproject(new Cesium.Cartesian3(t.east,t.north));return{north:this.rad2deg(i.latitude),east:this.rad2deg(i.longitude),south:this.rad2deg(e.latitude),west:this.rad2deg(e.longitude)}},t.prototype.setWidthAndHeight=function(t){this.width=t.east>0&&t.west<0?t.east+Math.abs(t.west):Math.abs(t.east-t.west),this.height=t.north>0&&t.south<0?t.north+Math.abs(t.south):Math.abs(t.north-t.south),this._factor=1,this.width>this.height&&this.width>this.heatmapOptionsDefaults.maxCanvasSize?(this._factor=this.width/this.heatmapOptionsDefaults.maxCanvasSize,this.height/this._factor<this.heatmapOptionsDefaults.minCanvasSize&&(this._factor=this.height/this.heatmapOptionsDefaults.minCanvasSize)):this.height>this.width&&this.height>this.heatmapOptionsDefaults.maxCanvasSize?(this._factor=this.height/this.heatmapOptionsDefaults.maxCanvasSize,this.width/this._factor<this.heatmapOptionsDefaults.minCanvasSize&&(this._factor=this.width/this.heatmapOptionsDefaults.minCanvasSize)):this.width<this.height&&this.width<this.heatmapOptionsDefaults.minCanvasSize?(this._factor=this.width/this.heatmapOptionsDefaults.minCanvasSize,this.height/this._factor>this.heatmapOptionsDefaults.maxCanvasSize&&(this._factor=this.height/this.heatmapOptionsDefaults.maxCanvasSize)):this.height<this.width&&this.height<this.heatmapOptionsDefaults.minCanvasSize&&(this._factor=this.height/this.heatmapOptionsDefaults.minCanvasSize,this.width/this._factor>this.heatmapOptionsDefaults.maxCanvasSize&&(this._factor=this.width/this.heatmapOptionsDefaults.maxCanvasSize)),this.width=this.width/this._factor,this.height=this.height/this._factor},t.prototype.create=function(t,e,i){var n=t,o=e.heatPointsData,r=(e.min,e.max,Object.assign({},this.heatmapOptionsDefaults,i));this._mbounds=this.wgs84ToMercatorBB(n),this.setWidthAndHeight(this._mbounds),r.radius=Math.round(i.radius?i.radius:this.width>this.height?this.width/this.heatmapOptionsDefaults.radiusFactor:this.height/this.heatmapOptionsDefaults.radiusFactor),this._spacing=r.radius*this.heatmapOptionsDefaults.spacingFactor,this._xoffset=this._mbounds.west,this._yoffset=this._mbounds.south,this.width=Math.round(this.width+2*this._spacing),this.height=Math.round(this.height+2*this._spacing),this._mbounds.west-=this._spacing*this._factor,this._mbounds.east+=this._spacing*this._factor,this._mbounds.south-=this._spacing*this._factor,this._mbounds.north+=this._spacing*this._factor,this.bounds=this.mercatorToWgs84BB(this._mbounds),this._rectangle=Cesium.Rectangle.fromDegrees(this.bounds.west,this.bounds.south,this.bounds.east,this.bounds.north);var s=this.createContainer(this.height,this.width),a=s.container,p=s.id;Object.assign(r,{container:a}),this.heatmap=u.create(r),this.setWGS84Data(0,100,o);var c=this.heatmap._renderer.canvas,l=new Cesium.ImageMaterialProperty({image:c,transparent:!0});return this.setClear(l,p),l},t.prototype.setClear=function(t,e){t.clear=function(){var t=document.getElementById(e);return t.parentNode.removeChild(t)}},t.containerCanvasCounter=0,t.decorators=[{type:e.Injectable}],t}();var li={CREATE:0,EDIT:1,CREATE_OR_EDIT:2};li[li.CREATE]="CREATE",li[li.EDIT]="EDIT",li[li.CREATE_OR_EDIT]="CREATE_OR_EDIT";var ui={INIT:0,MOUSE_MOVE:1,ADD_POINT:2,ADD_LAST_POINT:3,CHANGE_TO_EDIT:4,REMOVE_POINT:5,DRAG_POINT:6,DRAG_POINT_FINISH:7,DRAG_SHAPE:8,DRAG_SHAPE_FINISH:9,DONE:10,DISABLE:11,ENABLE:12,DISPOSE:13,SET_EDIT_LABELS_RENDER_CALLBACK:14,UPDATE_EDIT_LABELS:15,SET_MANUALLY:16,TRANSFORM:17};ui[ui.INIT]="INIT",ui[ui.MOUSE_MOVE]="MOUSE_MOVE",ui[ui.ADD_POINT]="ADD_POINT",ui[ui.ADD_LAST_POINT]="ADD_LAST_POINT",ui[ui.CHANGE_TO_EDIT]="CHANGE_TO_EDIT",ui[ui.REMOVE_POINT]="REMOVE_POINT",ui[ui.DRAG_POINT]="DRAG_POINT",ui[ui.DRAG_POINT_FINISH]="DRAG_POINT_FINISH",ui[ui.DRAG_SHAPE]="DRAG_SHAPE",ui[ui.DRAG_SHAPE_FINISH]="DRAG_SHAPE_FINISH",ui[ui.DONE]="DONE",ui[ui.DISABLE]="DISABLE",ui[ui.ENABLE]="ENABLE",ui[ui.DISPOSE]="DISPOSE",ui[ui.SET_EDIT_LABELS_RENDER_CALLBACK]="SET_EDIT_LABELS_RENDER_CALLBACK",ui[ui.UPDATE_EDIT_LABELS]="UPDATE_EDIT_LABELS",ui[ui.SET_MANUALLY]="SET_MANUALLY",ui[ui.TRANSFORM]="TRANSFORM";var di=function(t){function e(e,i,n,o){void 0===o&&(o=!1);var r=t.call(this)||this;return r._show=!0,r.editedEntityId=e,r.position=i,r.id=r.generateId(),r.pointProps=y({},n),r._virtualEditPoint=o,r}return h(e,t),Object.defineProperty(e.prototype,"show",{get:function(){return this._show},set:function(t){this._show=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"props",{get:function(){return this.pointProps},set:function(t){this.pointProps=t},enumerable:!0,configurable:!0}),e.prototype.isVirtualEditPoint=function(){return this._virtualEditPoint},e.prototype.setVirtualEditPoint=function(t){this._virtualEditPoint=t},e.prototype.getEditedEntityId=function(){return this.editedEntityId},e.prototype.getPosition=function(){return this.position.clone()},e.prototype.getPositionCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPosition.bind(this),!1)},e.prototype.setPosition=function(t){this.position.x=t.x,this.position.y=t.y,this.position.z=t.z},e.prototype.getId=function(){return this.id},e.prototype.generateId=function(){return"edit-point-"+e.counter++},e.counter=0,e}(le);var hi=function(t){function e(e,i,n,o){var r=t.call(this)||this;return r.editedEntityId=e,r.id=r.generateId(),r.positions=[i,n],r._polylineProps=y({},o),r}return h(e,t),Object.defineProperty(e.prototype,"props",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!0,configurable:!0}),e.prototype.getEditedEntityId=function(){return this.editedEntityId},e.prototype.getPositions=function(){return this.positions.map(function(t){return t.clone()})},e.prototype.getPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositions.bind(this),!1)},e.prototype.validatePositions=function(){return void 0!==this.positions[0]&&void 0!==this.positions[1]},e.prototype.getStartPosition=function(){return this.positions[0]},e.prototype.getEndPosition=function(){return this.positions[1]},e.prototype.setStartPosition=function(t){this.positions[0]=t},e.prototype.setEndPosition=function(t){this.positions[1]=t},e.prototype.getId=function(){return this.id},e.prototype.generateId=function(){return"edit-polyline-"+e.counter++},e.counter=0,e}(le);var yi={backgroundColor:new Cesium.Color(.165,.165,.165,.7),backgroundPadding:new Cesium.Cartesian2(25,20),distanceDisplayCondition:void 0,fillColor:Cesium.Color.WHITE,font:"30px sans-serif",heightReference:Cesium.HeightReference.NONE,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,outlineColor:Cesium.Color.BLACK,outlineWidth:1,pixelOffset:Cesium.Cartesian2.ZERO,pixelOffsetScaleByDistance:void 0,scale:1,scaleByDistance:void 0,show:!0,showBackground:!1,style:Cesium.LabelStyle.FILL,text:"",translucencyByDistance:void 0,verticalOrigin:Cesium.VerticalOrigin.BASELINE,disableDepthTestDistance:Number.POSITIVE_INFINITY},fi=function(t){function e(e,i,n,o,r,s,a){var p=t.call(this)||this;return p.id=e,p.polygonsLayer=i,p.pointsLayer=n,p.polylinesLayer=o,p.coordinateConverter=r,p.polygonOptions=s,p.positions=[],p.polylines=[],p.doneCreation=!1,p._enableEdit=!0,p._labels=[],p.polygonProps=y({},s.polygonProps),p.defaultPointProps=y({},s.pointProps),p.defaultPolylineProps=y({},s.polylineProps),a&&a.length>=3&&p.createFromExisting(a),p}return h(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map(function(t,i){return t.position||(t.position=e[i]),Object.assign({},yi,t)})}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"defaultPolylineProps",{get:function(){return this._defaultPolylineProps},set:function(t){this._defaultPolylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"polygonProps",{get:function(){return this._polygonProps},set:function(t){this._polygonProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach(function(i){i.show=t,e.updatePointsLayer(!1,i)})},enumerable:!0,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach(function(t){e.addPointFromExisting(t)}),this.addAllVirtualEditPoints(),this.updatePolygonsLayer(),this.doneCreation=!0},e.prototype.setPointsManually=function(t,e){var i=this;if(!this.doneCreation)throw new Error("Update manually only in edit mode, after polygon is created");this.positions.forEach(function(t){return i.pointsLayer.remove(t.getId())});for(var n=[],o=0;o<t.length;o++){var r=t[o],s=null;s=r.pointProps?new di(this.id,r.position,r.pointProps):new di(this.id,r,this.defaultPointProps),n.push(s)}this.positions=n,this.polygonProps=e||this.polygonProps,this.updatePointsLayer.apply(this,m([!0],this.positions)),this.addAllVirtualEditPoints(),this.updatePolygonsLayer()},e.prototype.addAllVirtualEditPoints=function(){var t=this,e=m(this.positions);e.forEach(function(i,n){var o=i,r=(n+1)%e.length,s=e[r],a=t.setMiddleVirtualPoint(o,s);t.updatePointsLayer(!1,a)})},e.prototype.setMiddleVirtualPoint=function(t,e){var i=Cesium.Cartesian3.lerp(t.getPosition(),e.getPosition(),.5,new Cesium.Cartesian3),n=new di(this.id,i,this.defaultPointProps);n.setVirtualEditPoint(!0);var o=this.positions.indexOf(t);return this.positions.splice(o+1,0,n),n},e.prototype.updateMiddleVirtualPoint=function(t,e,i){var n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3);t.setPosition(n)},e.prototype.changeVirtualPointToRealPoint=function(t){t.setVirtualEditPoint(!1);var e=this.positions.length,i=this.positions.indexOf(t),n=(i+1)%e,o=(i-1+e)%e,r=this.positions[n],s=this.positions[o],a=this.setMiddleVirtualPoint(s,t),p=this.setMiddleVirtualPoint(t,r);this.updatePointsLayer(!0,a,p,t),this.updatePolygonsLayer()},e.prototype.renderPolylines=function(){var t=this;this.polylines.forEach(function(e){return t.polylinesLayer.remove(e.getId())}),this.polylines=[];var e=this.positions.filter(function(t){return!t.isVirtualEditPoint()});e.forEach(function(i,n){var o=(n+1)%e.length,r=e[o],s=new hi(t.id,i.getPosition(),r.getPosition(),t.defaultPolylineProps);t.polylines.push(s),t.polylinesLayer.update(s,s.getId())})},e.prototype.addPointFromExisting=function(t){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(!0,e)},e.prototype.addPoint=function(t){if(!this.doneCreation){if(!this.positions.length){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(!0,e)}this.movingPoint=new di(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(!0,this.movingPoint),this.updatePolygonsLayer()}},e.prototype.movePointFinish=function(t){this.polygonOptions.clampHeightTo3D&&(t.props.disableDepthTestDistance=Number.POSITIVE_INFINITY,this.updatePointsLayer(!1,t))},e.prototype.movePoint=function(t,e){if(e.setPosition(t),this.doneCreation){if(e.props.disableDepthTestDistance&&this.polygonOptions.clampHeightTo3D)return void(e.props.disableDepthTestDistance=void 0);e.isVirtualEditPoint()&&this.changeVirtualPointToRealPoint(e);var i=this.positions.length,n=this.positions.indexOf(e),o=this.positions[(n+1)%i],r=this.positions[(n+2)%i],s=this.positions[(n-1+i)%i],a=this.positions[(n-2+i)%i];this.updateMiddleVirtualPoint(o,e,r),this.updateMiddleVirtualPoint(s,e,a)}this.updatePolygonsLayer(),this.updatePointsLayer(!0,e)},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.movePolygon=function(t,e){var i=this;if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var n=Z.getPositionsDelta(this.lastDraggedToPosition,e);this.positions.forEach(function(t){var e=Z.addDeltaToPosition(t.getPosition(),n,!0);t.setPosition(e)}),this.updatePointsLayer(),this.lastDraggedToPosition=e,this.positions.forEach(function(t){return i.updatePointsLayer(!0,t)})}},e.prototype.endMovePolygon=function(){this.lastDraggedToPosition=void 0},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)}),this.addAllVirtualEditPoints(),this.renderPolylines(),this.getPointsCount()>=3&&this.polygonsLayer.update(this,this.id)},e.prototype.addLastPoint=function(t){this.doneCreation=!0,this.removePosition(this.movingPoint),this.movingPoint=null,this.updatePolygonsLayer(),this.addAllVirtualEditPoints()},e.prototype.getRealPositions=function(){return this.getRealPoints().map(function(t){return t.getPosition()})},e.prototype.getRealPoints=function(){var t=this;return this.positions.filter(function(e){return!e.isVirtualEditPoint()&&e!==t.movingPoint})},e.prototype.getPositionsHierarchy=function(){var t=this.positions.filter(function(t){return!t.isVirtualEditPoint()}).map(function(t){return t.getPosition().clone()});return new Cesium.PolygonHierarchy(t)},e.prototype.getPositionsHierarchyCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositionsHierarchy.bind(this),!1)},e.prototype.removePosition=function(t){var e=this.positions.findIndex(function(e){return e===t});e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePolygonsLayer=function(){this.getPointsCount()>=3&&this.polygonsLayer.update(this,this.id)},e.prototype.updatePointsLayer=function(t){var e=this;void 0===t&&(t=!0);for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&this.renderPolylines(),i.forEach(function(t){return e.pointsLayer.update(t,t.getId())})},e.prototype.dispose=function(){var t=this;this.polygonsLayer.remove(this.id),this.positions.forEach(function(e){t.pointsLayer.remove(e.getId())}),this.polylines.forEach(function(e){return t.polylinesLayer.remove(e.getId())}),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(le);var mi=function(){function t(){this.polygons=new Map}return t.prototype.createEditablePolygon=function(t,e,i,n,o,r,s){var a=new fi(t,e,i,n,o,r,s);this.polygons.set(t,a)},t.prototype.dispose=function(t){this.polygons.get(t).dispose(),this.polygons.delete(t)},t.prototype.get=function(t){return this.polygons.get(t)},t.prototype.clear=function(){this.polygons.forEach(function(t){return t.dispose()}),this.polygons.clear()},t.decorators=[{type:e.Injectable}],t}();function gi(t){void 0===t&&(t=12);for(var e="",i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<t;n++)e+=i.charAt(Math.floor(Math.random()*i.length));return e}var vi={addPointEvent:G.LEFT_CLICK,addLastPointEvent:G.LEFT_DOUBLE_CLICK,removePointEvent:G.RIGHT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.8),outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polygonProps:{material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,classificationType:Cesium.ClassificationType.BOTH,zIndex:0},polylineProps:{material:function(){return Cesium.Color.WHITE},width:3,clampToGround:!1,zIndex:0,classificationType:Cesium.ClassificationType.BOTH},clampHeightTo3D:!1,clampHeightTo3DOptions:{clampToTerrain:!1}},Pi=function(){function t(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.polygonsManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.screenToPosition=function(t,e){var i=this.coordinateConverter.screenToCartesian3(t);if(e&&i){var n=this.cesiumScene.pickPosition(t);if(W.cartesian3ToLatLon(n).height<0){var o=this.cameraService.getCamera().getPickRay(t);return this.cesiumScene.globe.pick(o,this.cesiumScene)}return this.cesiumScene.clampToHeight(n)}return i},t.prototype.create=function(t,e){var i=this;void 0===t&&(t=vi),void 0===e&&(e=100);var n=[],o=gi(),r=this.setOptions(t),a=new s.BehaviorSubject({id:o,editAction:null,editMode:li.CREATE}),p=!1;this.updateSubject.next({id:o,positions:n,editMode:li.CREATE,editAction:ui.INIT,polygonOptions:r});var c=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:e}),l=this.mapEventsManager.register({event:r.addPointEvent,pick:U.NO_PICK,priority:e}),u=this.mapEventsManager.register({event:r.addLastPointEvent,pick:U.NO_PICK,priority:e});this.observablesMap.set(o,[c,l,u]);var d=this.createEditorObservable(a,o);return c.subscribe(function(e){var n=e.movement.endPosition,r=i.screenToPosition(n,t.clampHeightTo3D);r&&i.updateSubject.next({id:o,positions:i.getPositions(o),editMode:li.CREATE,updatedPosition:r,editAction:ui.MOUSE_MOVE})}),l.subscribe(function(s){var c=s.movement.endPosition;if(!p){var l=i.screenToPosition(c,t.clampHeightTo3D);if(l){var u=i.getPositions(o);if(!u.find(function(t){return t.equals(l)})){var h={id:o,positions:u,editMode:li.CREATE,updatedPosition:l,editAction:ui.ADD_POINT};i.updateSubject.next(h),a.next(y({},h,{positions:i.getPositions(o),points:i.getPoints(o)})),r.maximumNumberOfPoints&&u.length+1===r.maximumNumberOfPoints&&(p=i.switchToEditMode(o,l,a,n,e,r,d,p))}}}}),u.subscribe(function(s){var c=s.movement.endPosition,l=i.screenToPosition(c,t.clampHeightTo3D);l&&(p=i.switchToEditMode(o,l,a,n,e,r,d,p))}),d},t.prototype.switchToEditMode=function(t,e,i,n,o,r,s,a){var p={id:t,positions:this.getPositions(t),editMode:li.CREATE,updatedPosition:e,editAction:ui.ADD_LAST_POINT};this.updateSubject.next(p),i.next(y({},p,{positions:this.getPositions(t),points:this.getPoints(t)}));var c={id:t,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};return this.updateSubject.next(c),i.next(c),this.observablesMap.has(t)&&this.observablesMap.get(t).forEach(function(t){return t.dispose()}),this.observablesMap.delete(t),this.editPolygon(t,n,o,i,r,s),!0,!0},t.prototype.edit=function(t,e,i){if(void 0===e&&(e=vi),void 0===i&&(i=100),t.length<3)throw new Error("Polygons editor error edit(): polygon should have at least 3 positions");var n=gi(),o=this.setOptions(e),r=new s.BehaviorSubject({id:n,editAction:null,editMode:li.EDIT}),a={id:n,positions:t,editMode:li.EDIT,editAction:ui.INIT,polygonOptions:o};return this.updateSubject.next(a),r.next(y({},a,{positions:this.getPositions(n),points:this.getPoints(n)})),this.editPolygon(n,t,i,r,o)},t.prototype.editPolygon=function(t,e,i,n,o,s){var a,p=this,c=this.mapEventsManager.register({event:o.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:i,pickFilter:function(e){return t===e.editedEntityId}});o.allowDrag&&(a=this.mapEventsManager.register({event:o.dragShapeEvent,entityType:fi,pick:U.PICK_FIRST,priority:i,pickFilter:function(e){return t===e.id}}));var l=this.mapEventsManager.register({event:o.removePointEvent,entityType:di,pick:U.PICK_FIRST,priority:i,pickFilter:function(e){return t===e.editedEntityId}});c.pipe(r.tap(function(t){var e=t.movement.drop;return p.cameraService.enableInputs(e)})).subscribe(function(e){var i=e.movement,r=i.endPosition,s=i.drop,a=e.entities,c=p.screenToPosition(r,o.clampHeightTo3D);if(c){var l=a[0],u={id:t,positions:p.getPositions(t),editMode:li.EDIT,updatedPosition:c,updatedPoint:l,editAction:s?ui.DRAG_POINT_FINISH:ui.DRAG_POINT};p.updateSubject.next(u),n.next(y({},u,{positions:p.getPositions(t),points:p.getPoints(t)}))}}),a&&a.pipe(r.tap(function(t){var e=t.movement.drop;return p.cameraService.enableInputs(e)})).subscribe(function(e){var i=e.movement,o=i.startPosition,r=i.endPosition,s=i.drop,a=(e.entities,p.screenToPosition(r,!1)),c=p.screenToPosition(o,!1);if(a){var l={id:t,positions:p.getPositions(t),editMode:li.EDIT,updatedPosition:a,draggedPosition:c,editAction:s?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};p.updateSubject.next(l),n.next(y({},l,{positions:p.getPositions(t),points:p.getPoints(t)}))}}),l.subscribe(function(e){var i=e.entities[0],o=m(p.getPositions(t));if(!(o.length<4)&&!(o.findIndex(function(t){return i.getPosition().equals(t)})<0)){var r={id:t,positions:o,editMode:li.EDIT,updatedPoint:i,editAction:ui.REMOVE_POINT};p.updateSubject.next(r),n.next(y({},r,{positions:p.getPositions(t),points:p.getPoints(t)}))}});var u=[c,l];return a&&u.push(a),this.observablesMap.set(t,u),s||this.createEditorObservable(n,t)},t.prototype.setOptions=function(t){t.maximumNumberOfPoints&&t.maximumNumberOfPoints<3&&(console.warn("Warn: PolygonEditor invalid option. maximumNumberOfPoints smaller then 3, maximumNumberOfPoints changed to 3"),t.maximumNumberOfPoints=3);var e=JSON.parse(JSON.stringify(vi)),i=Object.assign(e,t);if(i.pointProps=Object.assign({},vi.pointProps,t.pointProps),i.polygonProps=Object.assign({},vi.polygonProps,t.polygonProps),i.polylineProps=Object.assign({},vi.polylineProps,t.polylineProps),t.clampHeightTo3D){if(!this.cesiumScene.pickPositionSupported||!this.cesiumScene.clampToHeightSupported)throw new Error("Cesium pickPosition and clampToHeight must be supported to use clampHeightTo3D");this.cesiumScene.pickTranslucentDepth&&console.warn("Cesium scene.pickTranslucentDepth must be false in order to make the editors work properly on 3D"),1!==i.pointProps.color.alpha&&1!==i.pointProps.outlineColor.alpha||console.warn("Point color and outline color must have alpha in order to make the editor work properly on 3D"),i.allowDrag=!1,i.polylineProps.clampToGround=!0,i.pointProps.heightReference=i.clampHeightTo3DOptions.clampToTerrain?Cesium.HeightReference.CLAMP_TO_GROUND:Cesium.HeightReference.RELATIVE_TO_GROUND,i.pointProps.disableDepthTestDistance=Number.POSITIVE_INFINITY}return i},t.prototype.createEditorObservable=function(t,e){var i=this;return t.dispose=function(){var t=i.observablesMap.get(e);t&&t.forEach(function(t){return t.dispose()}),i.observablesMap.delete(e),i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,n){i.polygonsManager.get(e).setPointsManually(t,n),i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getCurrentPoints=function(){return i.getPoints(e)},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return i.polygonsManager.get(e).labels},t},t.prototype.getPositions=function(t){return this.polygonsManager.get(t).getRealPositions()},t.prototype.getPoints=function(t){return this.polygonsManager.get(t).getRealPoints()},t.decorators=[{type:e.Injectable}],t}();var bi=function(){function t(t,e,i,n,o,r){this.polygonsEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.polygonsManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editPolylines$=new s.Subject,this.editPolygons$=new s.Subject,this.polygonsEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.polygonsManager,this.cesiumService),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var t=this;this.polygonsEditor.onUpdate().subscribe(function(e){e.editMode===li.CREATE||e.editMode===li.CREATE_OR_EDIT?t.handleCreateUpdates(e):e.editMode===li.EDIT&&t.handleEditUpdates(e)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editPolygonsLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editPolygonsLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editPolygonsLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.polygonsManager.createEditablePolygon(t.id,this.editPolygonsLayer,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polygonOptions);break;case ui.MOUSE_MOVE:var e=this.polygonsManager.get(t.id);t.updatedPosition&&(e.moveTempMovingPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.polygonsManager.get(t.id);t.updatedPosition&&(e.addPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.polygonsManager.get(t.id);t.updatedPosition&&(e.addLastPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:(e=this.polygonsManager.get(t.id)).dispose(),this.removeEditLabels(e),this.editLabelsRenderFn=void 0;break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.polygonsManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.polygonsManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:this.polygonsManager.createEditablePolygon(t.id,this.editPolygonsLayer,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polygonOptions,t.positions);break;case ui.DRAG_POINT:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.updatedPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_POINT_FINISH:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.movePointFinish(t.updatedPoint),t.updatedPoint.isVirtualEditPoint()&&(e.changeVirtualPointToRealPoint(t.updatedPoint),this.renderEditLabels(e,t)));break;case ui.REMOVE_POINT:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.removePoint(t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.polygonsManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.movePolygon(t.draggedPosition,t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:(e=this.polygonsManager.get(t.id))&&e.enableEdit&&(e.endMovePolygon(),this.renderEditLabels(e,t));break;case ui.ENABLE:var e;(e=this.polygonsManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.polygonsManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:e.Component,args:[{selector:"polygons-editor",template:'\n    <ac-layer #editPolylinesLayer acFor="let polyline of editPolylines$" [context]="this">\n      <ac-polyline-desc\n        props="{\n        positions: polyline.getPositionsCallbackProperty(),\n        width: polyline.props.width,\n        material: polyline.props.material(),\n        clampToGround: polyline.props.clampToGround,\n        zIndex: polyline.props.zIndex,\n        classificationType: polyline.props.classificationType,\n      }"\n      >\n      </ac-polyline-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPositionCallbackProperty(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point),\n        disableDepthTestDistance: point.props.disableDepthTestDistance,\n        heightReference: point.props.heightReference,\n    }"\n      >\n      </ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #editPolygonsLayer acFor="let polygon of editPolygons$" [context]="this">\n      <ac-polygon-desc\n        props="{\n          hierarchy: polygon.getPositionsHierarchyCallbackProperty(),\n          material: polygon.polygonProps.material,\n          fill: polygon.polygonProps.fill,\n          classificationType: polygon.polygonProps.classificationType,\n          zIndex: polygon.polygonProps.zIndex,\n        }"\n      >\n      </ac-polygon-desc>\n      <ac-array-desc acFor="let label of polygon.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[W,mi],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Pi},{type:W},{type:bt},{type:B},{type:mi},{type:P}]},t.propDecorators={editPolygonsLayer:[{type:e.ViewChild,args:["editPolygonsLayer",{static:!1}]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer",{static:!1}]}],editPolylinesLayer:[{type:e.ViewChild,args:["editPolylinesLayer",{static:!1}]}]},t}();var Ei=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;return a._arcProps=s,a.id=a.generateId(),a.editedEntityId=e,a._center=i,a._radius=n,a._delta=o,a._angle=r,a}return h(e,t),Object.defineProperty(e.prototype,"props",{get:function(){return this._arcProps},set:function(t){this._arcProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"angle",{get:function(){return this._angle},set:function(t){this._angle=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"delta",{get:function(){return this._delta},set:function(t){this._delta=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radius",{get:function(){return this._radius},set:function(t){this._radius=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return this._center},set:function(t){this._center=t},enumerable:!0,configurable:!0}),e.prototype.updateCenter=function(t){this._center.x=t.x,this._center.y=t.y,this._center.z=t.z},e.prototype.getId=function(){return this.id},e.prototype.generateId=function(){return"edit-arc-"+e.counter++},e.counter=0,e}(le);var Ci=function(t){function e(e,i,n,o,r){var s=t.call(this)||this;return s.id=e,s.circlesLayer=i,s.pointsLayer=n,s.arcsLayer=o,s.options=r,s.doneCreation=!1,s._enableEdit=!0,s._labels=[],s._circleProps=y({},r.circleProps),s._pointProps=y({},r.pointProps),s._polylineProps=y({},r.polylineProps),s}return h(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){var e=this;t&&this._center&&this._radiusPoint&&(this._labels=t.map(function(i,n){return i.position||(n!==t.length-1?i.position=e._center.getPosition():i.position=e._radiusPoint.getPosition()),Object.assign({},yi,i)}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"polylineProps",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"circleProps",{get:function(){return this._circleProps},set:function(t){this._circleProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return this._center},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"radiusPoint",{get:function(){return this._radiusPoint},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,this._center.show=t,this._radiusPoint.show=t,this.updatePointsLayer()},enumerable:!0,configurable:!0}),e.prototype.setManually=function(t,e,i,n,o){void 0===i&&(i=this.pointProps),void 0===n&&(n=this.pointProps),void 0===o&&(o=this.circleProps),this._center?this._center.setPosition(t):this._center=new di(this.id,t,i),this._radiusPoint?this._radiusPoint.setPosition(e):this._radiusPoint=new di(this.id,e,n),this._outlineArc?this._outlineArc.radius=this.getRadius():this.createOutlineArc(),this.circleProps=o,this.doneCreation=!0,this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer()},e.prototype.addPoint=function(t){this.doneCreation||(this._center||(this._center=new di(this.id,t,this.pointProps),this._radiusPoint=new di(this.id,t.clone(),this.pointProps),this._outlineArc||this.createOutlineArc()),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer())},e.prototype.addLastPoint=function(t){!this.doneCreation&&this._center&&this._radiusPoint&&(this._radiusPoint.setPosition(t),this.doneCreation=!0,this.updatePointsLayer(),this.updateCirclesLayer())},e.prototype.movePoint=function(t){this._center&&this._radiusPoint&&(this._radiusPoint.setPosition(t),this._outlineArc.radius=this.getRadius(),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer())},e.prototype.moveCircle=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=this.getRadius(),n=Z.getPositionsDelta(this.lastDraggedToPosition,e),o=Z.addDeltaToPosition(this.getCenter(),n,!0);this._center.setPosition(o),this.radiusPoint.setPosition(Z.pointByLocationDistanceAndAzimuth(this.getCenter(),i,Math.PI/2,!0)),this._outlineArc.radius=this.getRadius(),this._outlineArc.center=this._center.getPosition(),this.updateArcsLayer(),this.updatePointsLayer(),this.updateCirclesLayer(),this.lastDraggedToPosition=e}},e.prototype.endMovePolygon=function(){this.lastDraggedToPosition=void 0},e.prototype.getRadius=function(){return this._center&&this._radiusPoint?Z.distance(this._center.getPosition(),this._radiusPoint.getPosition()):0},e.prototype.getRadiusCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRadius.bind(this),!1)},e.prototype.getCenter=function(){return this._center?this._center.getPosition():void 0},e.prototype.getCenterCallbackProperty=function(){return new Cesium.CallbackProperty(this.getCenter.bind(this),!1)},e.prototype.getRadiusPoint=function(){return this._radiusPoint?this._radiusPoint.getPosition():void 0},e.prototype.dispose=function(){this._center&&this.pointsLayer.remove(this._center.getId()),this._radiusPoint&&this.pointsLayer.remove(this._radiusPoint.getId()),this._outlineArc&&this.arcsLayer.remove(this._outlineArc.getId()),this.circlesLayer.remove(this.id)},e.prototype.getId=function(){return this.id},e.prototype.updateCirclesLayer=function(){this.circlesLayer.update(this,this.id)},e.prototype.updatePointsLayer=function(){this._center&&this.pointsLayer.update(this._center,this._center.getId()),this._radiusPoint&&this.pointsLayer.update(this._radiusPoint,this._radiusPoint.getId())},e.prototype.updateArcsLayer=function(){this._outlineArc&&this.arcsLayer.update(this._outlineArc,this._outlineArc.getId())},e.prototype.createOutlineArc=function(){this._center&&this._radiusPoint&&(this._outlineArc=new Ei(this.id,this.getCenter(),this.getRadius(),2*Math.PI,0,this.polylineProps))},e}(le);var _i=function(){function t(){this.circles=new Map}return t.prototype.createEditableCircle=function(t,e,i,n,o){var r=new Ci(t,e,i,n,o);return this.circles.set(t,r),r},t.prototype.dispose=function(t){this.circles.get(t).dispose(),this.circles.delete(t)},t.prototype.get=function(t){return this.circles.get(t)},t.prototype.clear=function(){this.circles.forEach(function(t){return t.dispose()}),this.circles.clear()},t.decorators=[{type:e.Injectable}],t}();var Si={addPointEvent:G.LEFT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,circleProps:{material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,outline:!1,outlineWidth:1,outlineColor:Cesium.Color.WHITE.withAlpha(.8),classificationType:Cesium.ClassificationType.BOTH,zIndex:0,shadows:Cesium.ShadowMode.DISABLED},pointProps:{color:Cesium.Color.WHITE.withAlpha(.95),outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polylineProps:{width:1,material:function(){return Cesium.Color.WHITE.withAlpha(.8)}}},Ii=function(){function t(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.circlesManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,e){var i,n=this;void 0===t&&(t=Si),void 0===e&&(e=100);var o=gi(),r=this.setOptions(t),a=new s.BehaviorSubject({id:o,editAction:null,editMode:li.CREATE}),p=!1;this.updateSubject.next({id:o,editMode:li.CREATE,editAction:ui.INIT,circleOptions:r});var c=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:e}),l=this.mapEventsManager.register({event:G.LEFT_CLICK,pick:U.NO_PICK,priority:e});this.observablesMap.set(o,[c,l]);var u=this.createEditorObservable(a,o);return l.subscribe(function(t){var s=t.movement.endPosition;if(!p){var c=n.coordinateConverter.screenToCartesian3(s);if(c)if(i){d={id:o,center:i,radiusPoint:c,editMode:li.CREATE,editAction:ui.ADD_LAST_POINT};n.updateSubject.next(d),a.next(y({},d,n.getCircleProperties(o)));var l={id:o,center:i,radiusPoint:c,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};n.updateSubject.next(l),a.next(y({},d,n.getCircleProperties(o))),n.observablesMap.has(o)&&n.observablesMap.get(o).forEach(function(t){return t.dispose()}),n.observablesMap.delete(o),n.editCircle(o,e,a,r,u),p=!0}else{var d={id:o,center:c,editMode:li.CREATE,editAction:ui.ADD_POINT};n.updateSubject.next(d),a.next(y({},d,n.getCircleProperties(o))),i=c}}}),c.subscribe(function(t){var e=t.movement.endPosition;if(i){var r=n.coordinateConverter.screenToCartesian3(e);if(r){var s={id:o,center:i,radiusPoint:r,editMode:li.CREATE,editAction:ui.MOUSE_MOVE};n.updateSubject.next(s),a.next(y({},s,n.getCircleProperties(o)))}}}),u},t.prototype.edit=function(t,e,i,n){void 0===i&&(i=Si),void 0===n&&(n=100);var o=gi(),r=this.setOptions(i),a=new s.BehaviorSubject({id:o,editAction:null,editMode:li.EDIT}),p={id:o,center:t,radiusPoint:Z.pointByLocationDistanceAndAzimuth(t,e,Math.PI/2,!0),editMode:li.EDIT,editAction:ui.INIT,circleOptions:r};return this.updateSubject.next(p),a.next(y({},p,this.getCircleProperties(o))),this.editCircle(o,n,a,r)},t.prototype.editCircle=function(t,e,i,n,o){var s,a=this,p=this.mapEventsManager.register({event:G.LEFT_CLICK_DRAG,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.editedEntityId}});n.allowDrag&&(s=this.mapEventsManager.register({event:G.LEFT_CLICK_DRAG,entityType:Ci,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.id}})),p.pipe(r.tap(function(t){var e=t.movement.drop;return a.cameraService.enableInputs(e)})).subscribe(function(e){var o=e.movement,r=o.endPosition,s=o.startPosition,p=o.drop,c=e.entities,l=a.coordinateConverter.screenToCartesian3(s),u=a.coordinateConverter.screenToCartesian3(r);if(u){var d,h=c[0]===a.getCenterPoint(t);if(d=p?h?ui.DRAG_SHAPE_FINISH:ui.DRAG_POINT_FINISH:h?ui.DRAG_SHAPE:ui.DRAG_POINT,n.allowDrag||d!==ui.DRAG_SHAPE&&d!==ui.DRAG_SHAPE_FINISH){var f={id:t,center:a.getCenterPosition(t),radiusPoint:a.getRadiusPosition(t),startDragPosition:l,endDragPosition:u,editMode:li.EDIT,editAction:d};a.updateSubject.next(f),i.next(y({},f,a.getCircleProperties(t)))}else a.cameraService.enableInputs(!0)}}),s&&s.pipe(r.tap(function(t){var e=t.movement.drop;return a.cameraService.enableInputs(e)})).subscribe(function(e){var n=e.movement,o=n.startPosition,r=n.endPosition,s=n.drop,p=a.coordinateConverter.screenToCartesian3(o),c=a.coordinateConverter.screenToCartesian3(r);if(c&&p){var l={id:t,center:a.getCenterPosition(t),radiusPoint:a.getRadiusPosition(t),startDragPosition:p,endDragPosition:c,editMode:li.EDIT,editAction:s?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};a.updateSubject.next(l),i.next(y({},l,a.getCircleProperties(t)))}});var c=[p];return s&&c.push(s),this.observablesMap.set(t,c),o||this.createEditorObservable(i,t)},t.prototype.createEditorObservable=function(t,e){var i=this;return t.dispose=function(){var t=i.observablesMap.get(e);t&&t.forEach(function(t){return t.dispose()}),i.observablesMap.delete(e),i.updateSubject.next({id:e,center:i.getCenterPosition(e),radiusPoint:i.getRadiusPosition(e),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){i.updateSubject.next({id:e,center:i.getCenterPosition(e),radiusPoint:i.getRadiusPosition(e),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){i.updateSubject.next({id:e,center:i.getCenterPosition(e),radiusPoint:i.getRadiusPosition(e),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,n,o,r,s){var a=Z.pointByLocationDistanceAndAzimuth(t,n,Math.PI/2,!0);i.circlesManager.get(e).setManually(t,a,o,r,s),i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return i.circlesManager.get(e).labels},t.getCenter=function(){return i.getCenterPosition(e)},t.getRadius=function(){return i.getRadius(e)},t},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Si)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Si.pointProps,t.pointProps),i.circleProps=Object.assign({},Si.circleProps,t.circleProps),i.polylineProps=Object.assign({},Si.polylineProps,t.polylineProps),i},t.prototype.getCenterPosition=function(t){return this.circlesManager.get(t).getCenter()},t.prototype.getCenterPoint=function(t){return this.circlesManager.get(t).center},t.prototype.getRadiusPosition=function(t){return this.circlesManager.get(t).getRadiusPoint()},t.prototype.getRadius=function(t){return this.circlesManager.get(t).getRadius()},t.prototype.getCircleProperties=function(t){var e=this.circlesManager.get(t);return{center:e.getCenter(),radiusPoint:e.getRadiusPoint(),radius:e.getRadius()}},t.decorators=[{type:e.Injectable}],t}();var Ti=function(){function t(t,e,i,n,o){this.circlesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.circlesManager=o,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editCircles$=new s.Subject,this.editArcs$=new s.Subject,this.circlesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.circlesManager),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var t=this;this.circlesEditor.onUpdate().subscribe(function(e){e.editMode===li.CREATE||e.editMode===li.CREATE_OR_EDIT?t.handleCreateUpdates(e):e.editMode===li.EDIT&&t.handleEditUpdates(e)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.center=t.getCenter(),e.radiusPoint=t.getRadiusPoint(),e.radius=t.getRadius(),i)return t.labels=i,void this.editCirclesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editCirclesLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editCirclesLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.circlesManager.createEditableCircle(t.id,this.editCirclesLayer,this.editPointsLayer,this.editArcsLayer,t.circleOptions);break;case ui.MOUSE_MOVE:var e=this.circlesManager.get(t.id);t.radiusPoint&&(e.movePoint(t.radiusPoint),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.circlesManager.get(t.id);t.center&&(e.addPoint(t.center),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.circlesManager.get(t.id);t.radiusPoint&&(e.addLastPoint(t.radiusPoint),this.renderEditLabels(e,t));break;case ui.DISPOSE:e=this.circlesManager.get(t.id);this.removeEditLabels(e),this.circlesManager.dispose(t.id);break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.circlesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.circlesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:(e=this.circlesManager.createEditableCircle(t.id,this.editCirclesLayer,this.editPointsLayer,this.editArcsLayer,t.circleOptions)).setManually(t.center,t.radiusPoint);break;case ui.DRAG_POINT_FINISH:case ui.DRAG_POINT:(e=this.circlesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.endDragPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.circlesManager.get(t.id))&&e.enableEdit&&(e.moveCircle(t.startDragPosition,t.endDragPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:(e=this.circlesManager.get(t.id))&&e.enableEdit&&(e.endMovePolygon(),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.circlesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:var e;(e=this.circlesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.circlesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:e.Component,args:[{selector:"circles-editor",template:'\n      <ac-layer #editArcsLayer acFor="let arc of editArcs$" [context]="this">\n          <ac-arc-desc\n                  props="{\n        angle: arc.angle,\n        delta: arc.delta,\n        center: arc.center,\n        radius: arc.radius,\n        quality: 30,\n        color: arc.props.material()\n    }"\n          >\n          </ac-arc-desc>\n      </ac-layer>\n\n      <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n          <ac-point-desc\n                  props="{\n                    position: point.getPositionCallbackProperty(),\n                    pixelSize: getPointSize(point),\n                    color: point.props.color,\n                    outlineColor: point.props.outlineColor,\n                    outlineWidth: point.props.outlineWidth,\n                    show: getPointShow(point),\n                    disableDepthTestDistance: point.props.disableDepthTestDistance,\n                    heightReference: point.props.heightReference,\n    }"\n          >\n          </ac-point-desc>\n      </ac-layer>\n\n      <ac-layer #editCirclesLayer acFor="let circle of editCircles$" [context]="this" [zIndex]="0">\n          <ac-ellipse-desc\n                  props="{\n                  position: circle.getCenterCallbackProperty(),\n                  semiMajorAxis: circle.getRadiusCallbackProperty(),\n                  semiMinorAxis: circle.getRadiusCallbackProperty(),\n                  material: circle.circleProps.material,\n                  outline: circle.circleProps.outline,\n                  height: 0\n                  outlineWidth: circle.circleProps.outlineWidth,\n                  outlineColor: circle.circleProps.outlineColor,\n                  fill: circle.circleProps.fill,\n                  classificationType: circle.circleProps.classificationType,\n                  zIndex: circle.circleProps.zIndex,\n                  shadows: circle.circleProps.shadows,\n    }"\n          >\n          </ac-ellipse-desc>\n\n          <ac-array-desc acFor="let label of circle.labels" [idGetter]="getLabelId">\n              <ac-label-primitive-desc\n                      props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n              >\n              </ac-label-primitive-desc>\n          </ac-array-desc>\n      </ac-layer>\n  ',providers:[W,_i],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Ii},{type:W},{type:bt},{type:B},{type:_i}]},t.propDecorators={editCirclesLayer:[{type:e.ViewChild,args:["editCirclesLayer",{static:!1}]}],editArcsLayer:[{type:e.ViewChild,args:["editArcsLayer",{static:!1}]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer",{static:!1}]}]},t}();var Di=function(t){function e(e,i,n,o,r){var s=t.call(this)||this;return s.id=e,s.ellipsesLayer=i,s.pointsLayer=n,s.coordinateConverter=o,s.options=r,s._rotation=0,s.doneCreation=!1,s._enableEdit=!0,s._minorRadiusPoints=[],s._labels=[],s._ellipseProps=y({},r.ellipseProps),s._pointProps=y({},r.pointProps),s}return h(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){var e=this;t&&this._center&&(this._labels=t.map(function(t,i){return t.position||(0===i?t.position=e._center.getPosition():1===i?t.position=e._majorRadiusPoint?Cesium.Cartesian3.midpoint(e.getCenter(),e._majorRadiusPoint.getPosition(),new Cesium.Cartesian3):new Cesium.Cartesian3:2===i&&(t.position=e._minorRadiusPoints.length>0&&e._minorRadius?Cesium.Cartesian3.midpoint(e.getCenter(),e.getMinorRadiusPointPosition(),new Cesium.Cartesian3):new Cesium.Cartesian3)),Object.assign({},yi,t)}))},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"polylineProps",{get:function(){return this._polylineProps},set:function(t){this._polylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ellipseProps",{get:function(){return this._ellipseProps},set:function(t){this._ellipseProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"center",{get:function(){return this._center},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"majorRadiusPoint",{get:function(){return this._majorRadiusPoint},enumerable:!0,configurable:!0}),e.prototype.getMajorRadiusPointPosition=function(){if(this._majorRadiusPoint)return this._majorRadiusPoint.getPosition()},e.prototype.getMinorRadiusPointPosition=function(){if(!(this._minorRadiusPoints.length<1))return this._minorRadiusPoints[0].getPosition()},Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){this._enableEdit=t,this._center.show=t,this._majorRadiusPoint.show=t,this.updatePointsLayer()},enumerable:!0,configurable:!0}),e.prototype.setManually=function(t,e,i,n,o,r,s){if(void 0===i&&(i=Math.PI/2),void 0===o&&(o=this.pointProps),void 0===r&&(r=this.pointProps),void 0===s&&(s=this.ellipseProps),e<n)throw new Error("Major radius muse be equal or greater than minor radius");this._rotation=i,this._majorRadius=e,this._center?this._center.setPosition(t):this._center=new di(this.id,t,o);var a=Z.pointByLocationDistanceAndAzimuth(this.center.getPosition(),e,i);this._majorRadiusPoint?this._majorRadiusPoint.setPosition(a):this._majorRadiusPoint=new di(this.id,a,r),n&&(this._minorRadius=n),this.ellipseProps=s,this.doneCreation=!0,this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()},e.prototype.addPoint=function(t){this.doneCreation||(this._center||(this._center=new di(this.id,t,this.pointProps),this._majorRadiusPoint=new di(this.id,t.clone(),this.pointProps),this._majorRadius=0),this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer())},e.prototype.transformToEllipse=function(){this._minorRadius||(this._minorRadius=this.getMajorRadius(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer())},e.prototype.addLastPoint=function(t){if(!this.doneCreation&&this._center&&this._majorRadiusPoint){var e=Z.distance(this._center.getPosition(),t);this._majorRadiusPoint.setPosition(t),this._majorRadius=e,this.doneCreation=!0,this.options.circleToEllipseTransformation||(this._minorRadius=this._majorRadius),this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()}},e.prototype.movePoint=function(t,e){if(this._center&&this._majorRadiusPoint){var i=Z.distance(this._center.getPosition(),t);this.majorRadiusPoint===e?i<this._minorRadius?(this._majorRadius=this._minorRadius,this._majorRadiusPoint.setPosition(Z.pointByLocationDistanceAndAzimuth(this.getCenter(),this._minorRadius,this._rotation))):(this.majorRadiusPoint.setPosition(t),this._majorRadius=i):i>this._majorRadius?this._minorRadius=this._majorRadius:this._minorRadius=i,this.updateRotation(),this.updateMinorRadiusEditPoints(),this.updatePointsLayer(),this.updateEllipsesLayer()}},e.prototype.moveEllipse=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=this.getMajorRadius(),n=this.getRotation(),o=Z.getPositionsDelta(this.lastDraggedToPosition,e),r=Z.addDeltaToPosition(this.getCenter(),o,!0);this._center.setPosition(r),this.majorRadiusPoint.setPosition(Z.pointByLocationDistanceAndAzimuth(this.getCenter(),i,n)),this.updatePointsLayer(),this.updateMinorRadiusEditPoints(),this.updateEllipsesLayer(),this.lastDraggedToPosition=e}},e.prototype.endMoveEllipse=function(){this.lastDraggedToPosition=void 0},e.prototype.updateMinorRadiusEditPoints=function(){void 0!==this._minorRadius&&(0===this._minorRadiusPoints.length&&(this._minorRadiusPoints.push(new di(this.id,new Cesium.Cartesian3,this.pointProps,!0)),this._minorRadiusPoints.push(new di(this.id,new Cesium.Cartesian3,this.pointProps,!0))),this._minorRadiusPoints[0].setPosition(Z.pointByLocationDistanceAndAzimuth(this._center.getPosition(),this._minorRadius,this.getRotation()-Math.PI/2)),this._minorRadiusPoints[1].setPosition(Z.pointByLocationDistanceAndAzimuth(this._center.getPosition(),this._minorRadius,this.getRotation()+Math.PI/2)))},e.prototype.getMajorRadius=function(){return this._majorRadius||0},e.prototype.getMinorRadius=function(){return void 0===this._minorRadius?this.getMajorRadius():this._minorRadius},e.prototype.getRotation=function(){return this._rotation||0},e.prototype.updateRotation=function(){if(!this._majorRadiusPoint)return 0;var t=this.coordinateConverter.bearingToCartesian(this.getCenter(),this._majorRadiusPoint.getPosition());return this._rotation=Cesium.Math.toRadians(t),this._rotation},e.prototype.getRotationCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return Math.PI/2-t.getRotation()},!1)},e.prototype.getMinorRadiusCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return t.getMinorRadius()},!1)},e.prototype.getMajorRadiusCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return t.getMajorRadius()},!1)},e.prototype.getCenter=function(){return this._center?this._center.getPosition():void 0},e.prototype.getCenterCallbackProperty=function(){var t=this;return new Cesium.CallbackProperty(function(){return t.getCenter()},!1)},e.prototype.dispose=function(){var t=this;this._center&&this.pointsLayer.remove(this._center.getId()),this._majorRadiusPoint&&this.pointsLayer.remove(this._majorRadiusPoint.getId()),this._minorRadiusPoints&&this._minorRadiusPoints.forEach(function(e){return t.pointsLayer.remove(e.getId())}),this.ellipsesLayer.remove(this.id)},e.prototype.getId=function(){return this.id},e.prototype.updateEllipsesLayer=function(){this.ellipsesLayer.update(this,this.id)},e.prototype.updatePointsLayer=function(){this._center&&this.pointsLayer.update(this._center,this._center.getId()),this._majorRadiusPoint&&this.pointsLayer.update(this._majorRadiusPoint,this._majorRadiusPoint.getId()),this._minorRadiusPoints.length>0&&(this.pointsLayer.update(this._minorRadiusPoints[0],this._minorRadiusPoints[0].getId()),this.pointsLayer.update(this._minorRadiusPoints[1],this._minorRadiusPoints[1].getId()))},e}(le);var Mi=function(){function t(){this.ellipses=new Map}return t.prototype.createEditableEllipse=function(t,e,i,n,o){var r=new Di(t,e,i,n,o);return this.ellipses.set(t,r),r},t.prototype.dispose=function(t){this.ellipses.get(t).dispose(),this.ellipses.delete(t)},t.prototype.get=function(t){return this.ellipses.get(t)},t.prototype.clear=function(){this.ellipses.forEach(function(t){return t.dispose()}),this.ellipses.clear()},t.decorators=[{type:e.Injectable}],t}();var Ai={addPointEvent:G.LEFT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,circleToEllipseTransformEvent:G.LEFT_CLICK,circleToEllipseTransformEventModifier:ai.ALT,allowDrag:!0,ellipseProps:{material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),fill:!0,outline:!0,outlineWidth:1,outlineColor:Cesium.Color.WHITE.withAlpha(.8),classificationType:Cesium.ClassificationType.BOTH,zIndex:0,shadows:Cesium.ShadowMode.DISABLED},pointProps:{color:Cesium.Color.WHITE.withAlpha(.95),outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polylineProps:{width:1,material:function(){return Cesium.Color.WHITE}},circleToEllipseTransformation:!1},wi=function(){function t(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.ellipsesManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,e){var i,n=this;void 0===t&&(t=Ai),void 0===e&&(e=100);var o=gi(),r=this.setOptions(t),a=new s.BehaviorSubject({id:o,editAction:null,editMode:li.CREATE}),p=!1;this.updateSubject.next({id:o,editMode:li.CREATE,editAction:ui.INIT,ellipseOptions:r});var c=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:e}),l=this.mapEventsManager.register({event:r.addPointEvent,pick:U.NO_PICK,priority:e});this.observablesMap.set(o,[c,l]);var u=this.createEditorObservable(a,o);return l.subscribe(function(t){var s=t.movement.endPosition;if(!p){var c=n.coordinateConverter.screenToCartesian3(s);if(c)if(i){d={id:o,center:i,updatedPosition:c,editMode:li.CREATE,editAction:ui.ADD_LAST_POINT};n.updateSubject.next(d),a.next(y({},d));var l={id:o,center:i,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};n.updateSubject.next(l),a.next(y({},d)),n.observablesMap.has(o)&&n.observablesMap.get(o).forEach(function(t){return t.dispose()}),n.observablesMap.delete(o),n.editEllipse(o,e,a,r,u),p=!0}else{var d={id:o,center:c,editMode:li.CREATE,editAction:ui.ADD_POINT};n.updateSubject.next(d),a.next(y({},d)),i=c}}}),c.subscribe(function(t){var e=t.movement.endPosition;if(i){var r=n.coordinateConverter.screenToCartesian3(e);if(r){var s={id:o,center:i,updatedPosition:r,editMode:li.CREATE,editAction:ui.MOUSE_MOVE};n.updateSubject.next(s),a.next(y({},s))}}}),u},t.prototype.edit=function(t,e,i,n,o,r){void 0===i&&(i=Math.PI/2),void 0===o&&(o=Ai),void 0===r&&(r=100);var a=gi(),p=this.setOptions(o),c=new s.BehaviorSubject({id:a,editAction:null,editMode:li.EDIT}),l={id:a,center:t,majorRadius:e,rotation:i,minorRadius:n,editMode:li.EDIT,editAction:ui.INIT,ellipseOptions:p};return this.updateSubject.next(l),c.next(y({},l)),this.editEllipse(a,r,c,p)},t.prototype.editEllipse=function(t,e,i,n,o){var s,a,p=this,c=this.mapEventsManager.register({event:n.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.editedEntityId}});n.circleToEllipseTransformation&&(s=this.mapEventsManager.register({event:n.circleToEllipseTransformEvent,modifier:n.circleToEllipseTransformEventModifier,entityType:Di,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.id}})),n.allowDrag&&(a=this.mapEventsManager.register({event:n.dragShapeEvent,entityType:Di,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.id}})),c.pipe(r.tap(function(t){var e=t.movement.drop;return p.cameraService.enableInputs(e)})).subscribe(function(e){var o=e.movement,r=o.endPosition,s=o.startPosition,a=o.drop,c=e.entities,l=p.coordinateConverter.screenToCartesian3(s),u=p.coordinateConverter.screenToCartesian3(r);if(u){var d,h=c[0],f=h===p.getCenterPoint(t);if(d=a?f?ui.DRAG_SHAPE_FINISH:ui.DRAG_POINT_FINISH:f?ui.DRAG_SHAPE:ui.DRAG_POINT,n.allowDrag||d!==ui.DRAG_SHAPE&&d!==ui.DRAG_SHAPE_FINISH){var m=y({id:t,updatedPoint:h,startDragPosition:l,endDragPosition:u,editMode:li.EDIT,editAction:d},p.getEllipseProperties(t));p.updateSubject.next(m),i.next(y({},m))}else p.cameraService.enableInputs(!0)}}),s&&s.subscribe(function(e){var n=e.movement,o=(n.endPosition,n.startPosition,n.drop,e.entities,y({id:t,editMode:li.EDIT,editAction:ui.TRANSFORM},p.getEllipseProperties(t)));p.updateSubject.next(o),i.next(y({},o))}),a&&a.pipe(r.tap(function(t){var e=t.movement.drop;return p.cameraService.enableInputs(e)})).subscribe(function(e){var n=e.movement,o=n.startPosition,r=n.endPosition,s=n.drop,a=p.coordinateConverter.screenToCartesian3(o),c=p.coordinateConverter.screenToCartesian3(r);if(c&&a){var l=y({id:t,startDragPosition:a,endDragPosition:c,editMode:li.EDIT,editAction:s?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE},p.getEllipseProperties(t));p.updateSubject.next(l),i.next(y({},l))}});var l=[c,s];return a&&l.push(a),s&&l.push(s),this.observablesMap.set(t,l),o||this.createEditorObservable(i,t)},t.prototype.createEditorObservable=function(t,e){var i=this;return t.dispose=function(){var t=i.observablesMap.get(e);t&&t.forEach(function(t){return t.dispose()}),i.observablesMap.delete(e),i.updateSubject.next(y({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE},i.getEllipseProperties(e)))},t.enable=function(){i.updateSubject.next(y({id:e,editMode:li.EDIT,editAction:ui.ENABLE},i.getEllipseProperties(e)))},t.disable=function(){i.updateSubject.next(y({id:e,editMode:li.EDIT,editAction:ui.DISABLE},i.getEllipseProperties(e)))},t.setManually=function(t,n,o,r,s,a,p){i.ellipsesManager.get(e).setManually(t,n,o,r,s,a,p),i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return i.ellipsesManager.get(e).labels},t.getCenter=function(){return i.getCenterPosition(e)},t.getMajorRadius=function(){return i.getMajorRadius(e)},t.getMinorRadius=function(){return i.getMinorRadius(e)},t},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Ai)),i=Object.assign(e,t);return i.pointProps=Object.assign({},Ai.pointProps,t.pointProps),i.ellipseProps=Object.assign({},Ai.ellipseProps,t.ellipseProps),i.polylineProps=Object.assign({},Ai.polylineProps,t.polylineProps),i},t.prototype.getCenterPosition=function(t){return this.ellipsesManager.get(t).getCenter()},t.prototype.getCenterPoint=function(t){return this.ellipsesManager.get(t).center},t.prototype.getMajorRadius=function(t){return this.ellipsesManager.get(t).getMajorRadius()},t.prototype.getMinorRadius=function(t){return this.ellipsesManager.get(t).getMinorRadius()},t.prototype.getEllipseProperties=function(t){var e=this.ellipsesManager.get(t);return{center:e.getCenter(),rotation:e.getRotation(),minorRadius:e.getMinorRadius(),majorRadius:e.getMajorRadius(),minorRadiusPointPosition:e.getMinorRadiusPointPosition(),majorRadiusPointPosition:e.getMajorRadiusPointPosition()}},t.decorators=[{type:e.Injectable}],t}();var Li=function(){function t(t,e,i,n,o,r){this.ellipsesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.ellipsesManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editEllipses$=new s.Subject,this.ellipsesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,this.ellipsesManager,this.cesiumService),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var t=this;this.ellipsesEditor.onUpdate().subscribe(function(e){e.editMode===li.CREATE||e.editMode===li.CREATE_OR_EDIT?t.handleCreateUpdates(e):e.editMode===li.EDIT&&t.handleEditUpdates(e)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.center=t.getCenter(),e.majorRadius=t.getMajorRadius(),e.minorRadius=t.getMinorRadius(),e.rotation=t.getRotation(),i)return t.labels=i,void this.editEllipsesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editEllipsesLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editEllipsesLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.ellipsesManager.createEditableEllipse(t.id,this.editEllipsesLayer,this.editPointsLayer,this.coordinateConverter,t.ellipseOptions);break;case ui.MOUSE_MOVE:var e=this.ellipsesManager.get(t.id);t.updatedPosition&&(e.movePoint(t.updatedPosition,e.majorRadiusPoint),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.ellipsesManager.get(t.id);t.center&&(e.addPoint(t.center),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.ellipsesManager.get(t.id);t.updatedPosition&&(e.addLastPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:e=this.ellipsesManager.get(t.id);this.removeEditLabels(e),this.ellipsesManager.dispose(t.id);break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.ellipsesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.ellipsesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:(e=this.ellipsesManager.createEditableEllipse(t.id,this.editEllipsesLayer,this.editPointsLayer,this.coordinateConverter,t.ellipseOptions)).setManually(t.center,t.majorRadius,t.rotation,t.minorRadius,t.ellipseOptions&&t.ellipseOptions.pointProps||void 0,t.ellipseOptions&&t.ellipseOptions.pointProps||void 0,t.ellipseOptions&&t.ellipseOptions.ellipseProps||void 0),this.renderEditLabels(e,t);break;case ui.DRAG_POINT_FINISH:case ui.DRAG_POINT:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.endDragPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.moveEllipse(t.startDragPosition,t.endDragPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.endMoveEllipse(),this.renderEditLabels(e,t));break;case ui.TRANSFORM:(e=this.ellipsesManager.get(t.id))&&e.enableEdit&&(e.transformToEllipse(),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.ellipsesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:var e;(e=this.ellipsesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.ellipsesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:e.Component,args:[{selector:"ellipses-editor",template:'\n      <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n          <ac-point-desc\n                  props="{\n                    position: point.getPositionCallbackProperty(),\n                    pixelSize: getPointSize(point),\n                    color: point.props.color,\n                    outlineColor: point.props.outlineColor,\n                    outlineWidth: point.props.outlineWidth,\n                    show: getPointShow(point),\n                    disableDepthTestDistance: point.props.disableDepthTestDistance,\n                    heightReference: point.props.heightReference,\n    }"\n          >\n          </ac-point-desc>\n      </ac-layer>\n\n      <ac-layer #editEllipsesLayer acFor="let ellipse of editEllipses$" [context]="this" [zIndex]="0">\n          <ac-ellipse-desc\n                  props="{\n                    position: ellipse.getCenterCallbackProperty(),\n                    semiMajorAxis: ellipse.getMajorRadiusCallbackProperty(),\n                    semiMinorAxis: ellipse.getMinorRadiusCallbackProperty(),\n                    rotation: ellipse.getRotationCallbackProperty(),\n                    material: ellipse.ellipseProps.material,\n                    outline: ellipse.ellipseProps.outline,\n                    outlineWidth: ellipse.ellipseProps.outlineWidth,\n                    outlineColor: ellipse.ellipseProps.outlineColor,\n                    height: 0,\n                    fill: ellipse.ellipseProps.fill,\n                    classificationType: ellipse.ellipseProps.classificationType,\n                    zIndex: ellipse.ellipseProps.zIndex,\n                    shadows: ellipse.ellipseProps.shadows,\n    }"\n          >\n          </ac-ellipse-desc>\n\n          <ac-array-desc acFor="let label of ellipse.labels" [idGetter]="getLabelId">\n              <ac-label-primitive-desc\n                      props="{\n                        position: label.position,\n                        text: label.text,\n                        backgroundColor: label.backgroundColor,\n                        backgroundPadding: label.backgroundPadding,\n                        distanceDisplayCondition: label.distanceDisplayCondition,\n                        eyeOffset: label.eyeOffset,\n                        fillColor: label.fillColor,\n                        font: label.font,\n                        heightReference: label.heightReference,\n                        horizontalOrigin: label.horizontalOrigin,\n                        outlineColor: label.outlineColor,\n                        outlineWidth: label.outlineWidth,\n                        pixelOffset: label.pixelOffset,\n                        pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n                        scale: label.scale,\n                        scaleByDistance: label.scaleByDistance,\n                        show: label.show,\n                        showBackground: label.showBackground,\n                        style: label.style,\n                        translucencyByDistance: label.translucencyByDistance,\n                        verticalOrigin: label.verticalOrigin,\n                        disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n              >\n              </ac-label-primitive-desc>\n          </ac-array-desc>\n      </ac-layer>\n  ',providers:[W,Mi],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:wi},{type:W},{type:bt},{type:B},{type:Mi},{type:P}]},t.propDecorators={editEllipsesLayer:[{type:e.ViewChild,args:["editEllipsesLayer",{static:!1}]}],editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer",{static:!1}]}]},t}();var Oi=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;return a.id=e,a.pointsLayer=i,a.polylinesLayer=n,a.coordinateConverter=o,a.editOptions=r,a.positions=[],a.polylines=[],a.doneCreation=!1,a._enableEdit=!0,a._labels=[],a._pointProps=y({},r.pointProps),a.props=y({},r.polylineProps),s&&s.length>=2&&a.createFromExisting(s),a}return h(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map(function(t,i){return t.position||(t.position=e[i]),Object.assign({},yi,t)})}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"props",{get:function(){return this.polylineProps},set:function(t){this.polylineProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"pointProps",{get:function(){return this._pointProps},set:function(t){this._pointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach(function(i){i.show=t,e.updatePointsLayer(!1,i)})},enumerable:!0,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach(function(t){e.addPointFromExisting(t)}),this.addAllVirtualEditPoints(),this.doneCreation=!0},e.prototype.setManually=function(t,e){var i=this;if(!this.doneCreation)throw new Error("Update manually only in edit mode, after polyline is created");this.positions.forEach(function(t){return i.pointsLayer.remove(t.getId())});for(var n=[],o=0;o<t.length;o++){var r=t[o],s=null;s=r.pointProps?new di(this.id,r.position,r.pointProps):new di(this.id,r,this._pointProps),n.push(s)}this.positions=n,this.polylineProps=e||this.polylineProps,this.updatePointsLayer.apply(this,m([!0],this.positions)),this.addAllVirtualEditPoints()},e.prototype.addAllVirtualEditPoints=function(){var t=this,e=m(this.positions);e.forEach(function(i,n){if(n!==e.length-1){var o=i,r=(n+1)%e.length,s=e[r],a=t.setMiddleVirtualPoint(o,s);t.updatePointsLayer(!1,a)}})},e.prototype.setMiddleVirtualPoint=function(t,e){var i=Cesium.Cartesian3.lerp(t.getPosition(),e.getPosition(),.5,new Cesium.Cartesian3),n=new di(this.id,i,this._pointProps);n.setVirtualEditPoint(!0);var o=this.positions.indexOf(t);return this.positions.splice(o+1,0,n),n},e.prototype.updateMiddleVirtualPoint=function(t,e,i){var n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3);t.setPosition(n)},e.prototype.changeVirtualPointToRealPoint=function(t){t.setVirtualEditPoint(!1);var e=this.positions.length,i=this.positions.indexOf(t),n=(i+1)%e,o=(i-1+e)%e,r=this.positions[n],s=this.positions[o],a=this.setMiddleVirtualPoint(s,t),p=this.setMiddleVirtualPoint(t,r);this.updatePointsLayer(!1,a,p,t)},e.prototype.renderPolylines=function(){var t=this;this.polylines.forEach(function(e){return t.polylinesLayer.remove(e.getId())}),this.polylines=[];var e=this.positions.filter(function(t){return!t.isVirtualEditPoint()});e.forEach(function(i,n){if(n!==e.length-1){var o=e[n+1],r=new hi(t.id,i.getPosition(),o.getPosition(),t.polylineProps);t.polylines.push(r),t.polylinesLayer.update(r,r.getId())}})},e.prototype.addPointFromExisting=function(t){var e=new di(this.id,t,this._pointProps);this.positions.push(e),this.updatePointsLayer(!0,e)},e.prototype.addPoint=function(t){if(!this.doneCreation){if(!this.positions.length){var e=new di(this.id,t,this._pointProps);this.positions.push(e),this.updatePointsLayer(!0,e)}this.movingPoint=new di(this.id,t.clone(),this._pointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(!0,this.movingPoint)}},e.prototype.movePointFinish=function(t){this.editOptions.clampHeightTo3D&&(t.props.disableDepthTestDistance=Number.POSITIVE_INFINITY,this.updatePointsLayer(!1,t))},e.prototype.movePoint=function(t,e){if(e.setPosition(t),this.doneCreation){if(e.props.disableDepthTestDistance&&this.editOptions.clampHeightTo3D)return void(e.props.disableDepthTestDistance=void 0);e.isVirtualEditPoint()&&this.changeVirtualPointToRealPoint(e);var i=this.positions.length,n=this.positions.indexOf(e);if(n<this.positions.length-1){var o=this.positions[(n+1)%i],r=this.positions[(n+2)%i];this.updateMiddleVirtualPoint(o,e,r)}if(n>0){var s=this.positions[(n-1+i)%i],a=this.positions[(n-2+i)%i];this.updateMiddleVirtualPoint(s,e,a)}}this.updatePointsLayer(!0,e)},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.moveShape=function(t,e){if(this.doneCreation){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=Z.getPositionsDelta(this.lastDraggedToPosition,e);this.positions.forEach(function(t){var e=Z.addDeltaToPosition(t.getPosition(),i,!0);t.setPosition(e)}),this.updatePointsLayer.apply(this,m([!0],this.positions)),this.lastDraggedToPosition=e}},e.prototype.endMoveShape=function(){this.lastDraggedToPosition=void 0,this.updatePointsLayer.apply(this,m([!0],this.positions))},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)}),this.addAllVirtualEditPoints(),this.renderPolylines()},e.prototype.addLastPoint=function(t){this.doneCreation=!0,this.removePosition(this.movingPoint),this.movingPoint=null,this.addAllVirtualEditPoints()},e.prototype.getRealPositions=function(){return this.getRealPoints().map(function(t){return t.getPosition()})},e.prototype.getRealPoints=function(){var t=this;return this.positions.filter(function(e){return!e.isVirtualEditPoint()&&e!==t.movingPoint})},e.prototype.getPositions=function(){return this.positions.map(function(t){return t.getPosition()})},e.prototype.getPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getPositions.bind(this),!1)},e.prototype.removePosition=function(t){var e=this.positions.findIndex(function(e){return e===t});e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePointsLayer=function(t){var e=this;void 0===t&&(t=!0);for(var i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&this.renderPolylines(),i.forEach(function(t){return e.pointsLayer.update(t,t.getId())})},e.prototype.update=function(){this.updatePointsLayer()},e.prototype.dispose=function(){var t=this;this.positions.forEach(function(e){t.pointsLayer.remove(e.getId())}),this.polylines.forEach(function(e){return t.polylinesLayer.remove(e.getId())}),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(le);var Ri=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(s.Observable);var xi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(Ri);var Ni=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(Ri);var ji=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(Ri);var Fi=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(Ri);var ki=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return h(e,t),e}(Ri);var Hi=function(t){function e(e,i,n,o,r,s){var a=t.call(this)||this;if(a.id=e,a.pointsLayer=i,a.hippodromeLayer=n,a.coordinateConverter=o,a.positions=[],a.done=!1,a._enableEdit=!0,a._labels=[],a.defaultPointProps=y({},r.pointProps),a.hippodromeProps=y({},r.hippodromeProps),s&&2===s.length)a.createFromExisting(s);else if(s)throw new Error("Hippodrome consist of 2 points but provided "+s.length);return a}return h(e,t),Object.defineProperty(e.prototype,"labels",{get:function(){return this._labels},set:function(t){if(t){var e=this.getRealPositions();this._labels=t.map(function(t,i){return t.position||(t.position=e[i]),Object.assign({},yi,t)})}},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"hippodromeProps",{get:function(){return this._hippodromeProps},set:function(t){this._hippodromeProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"defaultPointProps",{get:function(){return this._defaultPointProps},set:function(t){this._defaultPointProps=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"enableEdit",{get:function(){return this._enableEdit},set:function(t){var e=this;this._enableEdit=t,this.positions.forEach(function(i){i.show=t,e.updatePointsLayer(i)})},enumerable:!0,configurable:!0}),e.prototype.createFromExisting=function(t){var e=this;t.forEach(function(t){e.addPointFromExisting(t)}),this.createHeightEditPoints(),this.updateHippdromeLayer(),this.updatePointsLayer.apply(this,m(this.positions)),this.done=!0},e.prototype.setPointsManually=function(t,e){var i=this;if(!this.done)throw new Error("Update manually only in edit mode, after polyline is created");this.hippodromeProps.width=e||this.hippodromeProps.width,this.positions.forEach(function(t){return i.pointsLayer.remove(t.getId())}),this.positions=t,this.createHeightEditPoints(),this.updatePointsLayer.apply(this,m(t)),this.updateHippdromeLayer()},e.prototype.addPointFromExisting=function(t){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.updatePointsLayer(e)},e.prototype.addPoint=function(t){if(!this.done)if(!this.positions.length){var e=new di(this.id,t,this.defaultPointProps);this.positions.push(e),this.movingPoint=new di(this.id,t.clone(),this.defaultPointProps),this.positions.push(this.movingPoint),this.updatePointsLayer(e)}else this.createHeightEditPoints(),this.updatePointsLayer.apply(this,m(this.positions)),this.updateHippdromeLayer(),this.done=!0,this.movingPoint=null},e.prototype.createHeightEditPoints=function(){var t=this;this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(e){return t.removePosition(e)});var e=this.getRealPoints()[0],i=this.getRealPoints()[1],n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3),o=this.coordinateConverter.bearingToCartesian(e.getPosition(),i.getPosition()),r=Cesium.Math.toRadians(o)-Math.PI/2;this.createMiddleEditablePoint(n,r);var s=Cesium.Math.toRadians(o)+Math.PI/2;this.createMiddleEditablePoint(n,s)},e.prototype.createMiddleEditablePoint=function(t,e){var i=Z.pointByLocationDistanceAndAzimuth(t,this.hippodromeProps.width/2,e,!0),n=new di(this.id,i,this.defaultPointProps);n.setVirtualEditPoint(!0),this.positions.push(n)},e.prototype.movePoint=function(t,e){e.isVirtualEditPoint()?this.changeWidthByNewPoint(t):(e.setPosition(t),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,m(this.positions)),this.updateHippdromeLayer())},e.prototype.changeWidthByNewPoint=function(t){var e=this.getRealPoints()[0],i=this.getRealPoints()[1],n=Cesium.Cartesian3.lerp(e.getPosition(),i.getPosition(),.5,new Cesium.Cartesian3),o=this.coordinateConverter.bearingToCartesian(n,t),r=o;o>270?r=o-270:o>180&&(r=o-180);var s=this.coordinateConverter.bearingToCartesian(e.getPosition(),i.getPosition());s>180&&(s=this.coordinateConverter.bearingToCartesian(i.getPosition(),e.getPosition()));var a=s>r?s-r:r-s;o>270&&(a=o-s);var p=Math.abs(Z.distance(n,t)),c=Math.sin(Cesium.Math.toRadians(a))*p;this.hippodromeProps.width=2*Math.abs(c),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,m(this.positions)),this.updateHippdromeLayer()},e.prototype.moveShape=function(t,e){this.lastDraggedToPosition||(this.lastDraggedToPosition=t);var i=Z.getPositionsDelta(this.lastDraggedToPosition,e);this.getRealPoints().forEach(function(t){var e=Z.addDeltaToPosition(t.getPosition(),i,!0);t.setPosition(e)}),this.createHeightEditPoints(),this.updatePointsLayer.apply(this,m(this.positions)),this.updateHippdromeLayer(),this.lastDraggedToPosition=e},e.prototype.endMoveShape=function(){var t=this;this.lastDraggedToPosition=void 0,this.createHeightEditPoints(),this.positions.forEach(function(e){return t.updatePointsLayer(e)}),this.updateHippdromeLayer()},e.prototype.endMovePoint=function(){this.createHeightEditPoints(),this.updatePointsLayer.apply(this,m(this.positions))},e.prototype.moveTempMovingPoint=function(t){this.movingPoint&&this.movePoint(t,this.movingPoint)},e.prototype.removePoint=function(t){var e=this;this.removePosition(t),this.positions.filter(function(t){return t.isVirtualEditPoint()}).forEach(function(t){return e.removePosition(t)})},e.prototype.addLastPoint=function(t){this.done=!0,this.removePosition(this.movingPoint),this.movingPoint=null},e.prototype.getRealPositions=function(){return this.getRealPoints().map(function(t){return t.getPosition()})},e.prototype.getRealPositionsCallbackProperty=function(){return new Cesium.CallbackProperty(this.getRealPositions.bind(this),!1)},e.prototype.getRealPoints=function(){return this.positions.filter(function(t){return!t.isVirtualEditPoint()})},e.prototype.getWidth=function(){return this.hippodromeProps.width},e.prototype.getPositions=function(){return this.positions.map(function(t){return t.getPosition()})},e.prototype.removePosition=function(t){var e=this.positions.findIndex(function(e){return e===t});e<0||(this.positions.splice(e,1),this.pointsLayer.remove(t.getId()))},e.prototype.updatePointsLayer=function(){for(var t=this,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];e.forEach(function(e){return t.pointsLayer.update(e,e.getId())})},e.prototype.updateHippdromeLayer=function(){this.hippodromeLayer.update(this,this.id)},e.prototype.dispose=function(){var t=this;this.hippodromeLayer.remove(this.id),this.positions.forEach(function(e){t.pointsLayer.remove(e.getId())}),this.movingPoint&&(this.pointsLayer.remove(this.movingPoint.getId()),this.movingPoint=void 0),this.positions.length=0},e.prototype.getPointsCount=function(){return this.positions.length},e.prototype.getId=function(){return this.id},e}(le);var Vi={addPointEvent:G.LEFT_CLICK,addLastPointEvent:G.LEFT_DOUBLE_CLICK,removePointEvent:G.RIGHT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,pointProps:{color:Cesium.Color.WHITE.withAlpha(.9),outlineColor:Cesium.Color.BLACK.withAlpha(.5),outlineWidth:1,pixelSize:15,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY},polylineProps:{material:function(){return Cesium.Color.BLACK},width:3,clampToGround:!1,zIndex:0,classificationType:Cesium.ClassificationType.BOTH},clampHeightTo3D:!1,clampHeightTo3DOptions:{clampToTerrain:!1}},Bi=function(){function t(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n,o){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.polylinesManager=n,this.updatePublisher.connect(),this.cesiumScene=o.getScene()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.screenToPosition=function(t,e){var i=this.coordinateConverter.screenToCartesian3(t);if(e&&i){var n=this.cesiumScene.pickPosition(t);if(W.cartesian3ToLatLon(n).height<0){var o=this.cameraService.getCamera().getPickRay(t);return this.cesiumScene.globe.pick(o,this.cesiumScene)}return this.cesiumScene.clampToHeight(n)}return i},t.prototype.create=function(t,e){var i=this;void 0===t&&(t=Vi),void 0===e&&(e=100);var n=[],o=gi(),r=this.setOptions(t),a=new s.BehaviorSubject({id:o,editAction:null,editMode:li.CREATE}),p=!1;this.updateSubject.next({id:o,positions:n,editMode:li.CREATE,editAction:ui.INIT,polylineOptions:r});var c=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:e}),l=this.mapEventsManager.register({event:r.addPointEvent,pick:U.NO_PICK,priority:e}),u=this.mapEventsManager.register({event:r.addLastPointEvent,pick:U.NO_PICK,priority:e});this.observablesMap.set(o,[c,l,u]);var d=this.createEditorObservable(a,o);return c.subscribe(function(e){var n=e.movement.endPosition,r=i.screenToPosition(n,t.clampHeightTo3D);r&&i.updateSubject.next({id:o,positions:i.getPositions(o),editMode:li.CREATE,updatedPosition:r,editAction:ui.MOUSE_MOVE})}),l.subscribe(function(s){var c=s.movement.endPosition;if(!p){var l=i.screenToPosition(c,t.clampHeightTo3D);if(l){var u=i.getPositions(o);if(!u.find(function(t){return t.equals(l)})){var h={id:o,positions:u,editMode:li.CREATE,updatedPosition:l,editAction:ui.ADD_POINT};i.updateSubject.next(h),a.next(y({},h,{positions:i.getPositions(o),points:i.getPoints(o)})),r.maximumNumberOfPoints&&u.length+1===r.maximumNumberOfPoints&&(p=i.switchToEditMode(o,l,a,n,e,r,d,p))}}}}),u.subscribe(function(s){var c=s.movement.endPosition,l=i.screenToPosition(c,t.clampHeightTo3D);l&&(p=i.switchToEditMode(o,l,a,n,e,r,d,p))}),d},t.prototype.switchToEditMode=function(t,e,i,n,o,r,s,a){var p={id:t,positions:this.getPositions(t),editMode:li.CREATE,updatedPosition:e,editAction:ui.ADD_LAST_POINT};this.updateSubject.next(p),i.next(y({},p,{positions:this.getPositions(t),points:this.getPoints(t)}));var c={id:t,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};return this.updateSubject.next(c),i.next(c),this.observablesMap.has(t)&&this.observablesMap.get(t).forEach(function(t){return t.dispose()}),this.observablesMap.delete(t),this.editPolyline(t,n,o,i,r,s),!0,!0},t.prototype.edit=function(t,e,i){if(void 0===e&&(e=Vi),void 0===i&&(i=100),t.length<2)throw new Error("Polylines editor error edit(): polyline should have at least 2 positions");var n=gi(),o=this.setOptions(e),r=new s.BehaviorSubject({id:n,editAction:null,editMode:li.EDIT}),a={id:n,positions:t,editMode:li.EDIT,editAction:ui.INIT,polylineOptions:o};return this.updateSubject.next(a),r.next(y({},a,{positions:this.getPositions(n),points:this.getPoints(n)})),this.editPolyline(n,t,i,r,o)},t.prototype.editPolyline=function(t,e,i,n,o,s){var a,p=this,c=this.mapEventsManager.register({event:o.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:i,pickFilter:function(e){return t===e.editedEntityId}}),l=this.mapEventsManager.register({event:o.removePointEvent,entityType:di,pick:U.PICK_FIRST,priority:i,pickFilter:function(e){return t===e.editedEntityId}});o.allowDrag&&(a=this.mapEventsManager.register({event:o.dragShapeEvent,entityType:hi,pick:U.PICK_FIRST,priority:i,pickFilter:function(e){return t===e.editedEntityId}})),a&&a.pipe(r.tap(function(t){var e=t.movement.drop;return p.cameraService.enableInputs(e)})).subscribe(function(e){var i=e.movement,o=i.startPosition,r=i.endPosition,s=i.drop,a=(e.entities,p.screenToPosition(r,!1)),c=p.screenToPosition(o,!1);if(a){var l={id:t,positions:p.getPositions(t),editMode:li.EDIT,updatedPosition:a,draggedPosition:c,editAction:s?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};p.updateSubject.next(l),n.next(y({},l,{positions:p.getPositions(t),points:p.getPoints(t)}))}}),c.pipe(r.tap(function(t){var e=t.movement.drop;return p.cameraService.enableInputs(e)})).subscribe(function(e){var i=e.movement,r=i.endPosition,s=i.drop,a=e.entities,c=p.screenToPosition(r,o.clampHeightTo3D);if(c){var l=a[0],u={id:t,positions:p.getPositions(t),editMode:li.EDIT,updatedPosition:c,updatedPoint:l,editAction:s?ui.DRAG_POINT_FINISH:ui.DRAG_POINT};p.updateSubject.next(u),n.next(y({},u,{positions:p.getPositions(t),points:p.getPoints(t)}))}}),l.subscribe(function(e){var i=e.entities[0],o=m(p.getPositions(t));if(!(o.length<3)&&!(o.findIndex(function(t){return i.getPosition().equals(t)})<0)){var r={id:t,positions:o,editMode:li.EDIT,updatedPoint:i,editAction:ui.REMOVE_POINT};p.updateSubject.next(r),n.next(y({},r,{positions:p.getPositions(t),points:p.getPoints(t)}))}});var u=[c,l];return a&&u.push(a),this.observablesMap.set(t,u),this.createEditorObservable(n,t)},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Vi)),i=Object.assign(e,t);if(i.pointProps=Object.assign({},Vi.pointProps,t.pointProps),i.polylineProps=Object.assign({},Vi.polylineProps,t.polylineProps),t.clampHeightTo3D){if(!this.cesiumScene.pickPositionSupported||!this.cesiumScene.clampToHeightSupported)throw new Error("Cesium pickPosition and clampToHeight must be supported to use clampHeightTo3D");this.cesiumScene.pickTranslucentDepth&&console.warn("Cesium scene.pickTranslucentDepth must be false in order to make the editors work properly on 3D"),1!==i.pointProps.color.alpha&&1!==i.pointProps.outlineColor.alpha||console.warn("Point color and outline color must have alpha in order to make the editor work properly on 3D"),i.allowDrag=!1,i.polylineProps.clampToGround=!0,i.pointProps.heightReference=i.clampHeightTo3DOptions.clampToTerrain?Cesium.HeightReference.CLAMP_TO_GROUND:Cesium.HeightReference.RELATIVE_TO_GROUND,i.pointProps.disableDepthTestDistance=Number.POSITIVE_INFINITY}return i},t.prototype.createEditorObservable=function(t,e){var i=this;return t.dispose=function(){var t=i.observablesMap.get(e);t&&t.forEach(function(t){return t.dispose()}),i.observablesMap.delete(e),i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,n){i.polylinesManager.get(e).setManually(t,n),i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getCurrentPoints=function(){return i.getPoints(e)},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return i.polylinesManager.get(e).labels},t},t.prototype.getPositions=function(t){return this.polylinesManager.get(t).getRealPositions()},t.prototype.getPoints=function(t){return this.polylinesManager.get(t).getRealPoints()},t.decorators=[{type:e.Injectable}],t}();var Gi=function(){function t(){this.polylines=new Map}return t.prototype.createEditablePolyline=function(t,e,i,n,o,r){var s=new Oi(t,e,i,n,o,r);this.polylines.set(t,s)},t.prototype.get=function(t){return this.polylines.get(t)},t.prototype.clear=function(){this.polylines.forEach(function(t){return t.dispose()}),this.polylines.clear()},t.decorators=[{type:e.Injectable}],t}();var Ui=function(){function t(t,e,i,n,o,r){this.polylinesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.polylinesManager=o,this.cesiumService=r,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editPolylines$=new s.Subject,this.polylineLabels$=new s.Subject,this.polylinesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o,this.cesiumService),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var t=this;this.polylinesEditor.onUpdate().subscribe(function(e){e.editMode===li.CREATE||e.editMode===li.CREATE_OR_EDIT?t.handleCreateUpdates(e):e.editMode===li.EDIT&&t.handleEditUpdates(e)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.polylineLabelsLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.polylineLabelsLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.polylineLabelsLayer.remove(t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.polylinesManager.createEditablePolyline(t.id,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polylineOptions);break;case ui.MOUSE_MOVE:var e=this.polylinesManager.get(t.id);t.updatedPosition&&(e.moveTempMovingPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.polylinesManager.get(t.id);t.updatedPosition&&(e.addPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_LAST_POINT:e=this.polylinesManager.get(t.id);t.updatedPosition&&(e.addLastPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:(e=this.polylinesManager.get(t.id)).dispose(),this.removeEditLabels(e),this.editLabelsRenderFn=void 0;break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.polylinesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.polylinesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:this.polylinesManager.createEditablePolyline(t.id,this.editPointsLayer,this.editPolylinesLayer,this.coordinateConverter,t.polylineOptions,t.positions);break;case ui.DRAG_POINT:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.updatedPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_POINT_FINISH:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.movePointFinish(t.updatedPoint),t.updatedPoint.isVirtualEditPoint()&&(e.changeVirtualPointToRealPoint(t.updatedPoint),this.renderEditLabels(e,t)));break;case ui.REMOVE_POINT:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.removePoint(t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.polylinesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:(e=this.polylinesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.moveShape(t.draggedPosition,t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:var e;(e=this.polylinesManager.get(t.id))&&e.enableEdit&&(e.endMoveShape(),this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.polylinesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:e.Component,args:[{selector:"polylines-editor",template:'\n    <ac-layer #editPolylinesLayer acFor="let polyline of editPolylines$" [context]="this">\n      <ac-polyline-desc\n        props="{\n        positions: polyline.getPositionsCallbackProperty(),\n        width: polyline.props.width,\n        material: polyline.props.material(),\n        clampToGround: polyline.props.clampToGround,\n        zIndex: polyline.props.zIndex,\n        classificationType: polyline.props.classificationType,\n      }"\n      >\n      </ac-polyline-desc>\n    </ac-layer>\n\n    <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n      <ac-point-desc\n        props="{\n        position: point.getPositionCallbackProperty(),\n        pixelSize: getPointSize(point),\n        color: point.props.color,\n        outlineColor: point.props.outlineColor,\n        outlineWidth: point.props.outlineWidth,\n        show: getPointShow(point),\n        disableDepthTestDistance: point.props.disableDepthTestDistance,\n        heightReference: point.props.heightReference,\n    }"\n      ></ac-point-desc>\n    </ac-layer>\n\n    <ac-layer #polylineLabelsLayer acFor="let polylineLabels of polylineLabels$" [context]="this">\n      <ac-array-desc acFor="let label of polylineLabels.labels" [idGetter]="getLabelId">\n        <ac-label-primitive-desc\n          props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }"\n        >\n        </ac-label-primitive-desc>\n      </ac-array-desc>\n    </ac-layer>\n  ',providers:[W,Gi],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Bi},{type:W},{type:bt},{type:B},{type:Gi},{type:P}]},t.propDecorators={editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer",{static:!1}]}],editPolylinesLayer:[{type:e.ViewChild,args:["editPolylinesLayer",{static:!1}]}],polylineLabelsLayer:[{type:e.ViewChild,args:["polylineLabelsLayer",{static:!1}]}]},t}();var zi=function(){function t(){this.hippodromes=new Map}return t.prototype.createEditableHippodrome=function(t,e,i,n,o,r){var s=new Hi(t,e,i,n,o,r);this.hippodromes.set(t,s)},t.prototype.get=function(t){return this.hippodromes.get(t)},t.prototype.clear=function(){this.hippodromes.forEach(function(t){return t.dispose()}),this.hippodromes.clear()},t.decorators=[{type:e.Injectable}],t}();var Ki={addPointEvent:G.LEFT_CLICK,dragPointEvent:G.LEFT_CLICK_DRAG,dragShapeEvent:G.LEFT_CLICK_DRAG,allowDrag:!0,hippodromeProps:{fill:!0,material:Cesium.Color.CORNFLOWERBLUE.withAlpha(.4),outline:!0,width:2e5,outlineWidth:1,outlineColor:Cesium.Color.WHITE.withAlpha(.8),classificationType:Cesium.ClassificationType.BOTH,zIndex:0,shadows:Cesium.ShadowMode.DISABLED},pointProps:{color:Cesium.Color.WHITE.withAlpha(.95),outlineColor:Cesium.Color.BLACK.withAlpha(.2),outlineWidth:1,pixelSize:13,virtualPointPixelSize:8,show:!0,showVirtual:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY}},Wi=function(){function t(){this.updateSubject=new s.Subject,this.updatePublisher=r.publish()(this.updateSubject),this.observablesMap=new Map}return t.prototype.init=function(t,e,i,n){this.mapEventsManager=t,this.coordinateConverter=e,this.cameraService=i,this.hippodromeManager=n,this.updatePublisher.connect()},t.prototype.onUpdate=function(){return this.updatePublisher},t.prototype.create=function(t,e){var i=this;void 0===t&&(t=Ki),void 0===e&&(e=100);var n=gi(),o=this.setOptions(t),r=new s.BehaviorSubject({id:n,editAction:null,editMode:li.CREATE}),a=!1;this.updateSubject.next({id:n,positions:[],editMode:li.CREATE,editAction:ui.INIT,hippodromeOptions:o});var p=this.mapEventsManager.register({event:G.MOUSE_MOVE,pick:U.NO_PICK,priority:e}),c=this.mapEventsManager.register({event:o.addPointEvent,pick:U.NO_PICK,priority:e});this.observablesMap.set(n,[p,c]);var l=this.createEditorObservable(r,n);return p.subscribe(function(t){var e=t.movement.endPosition,o=i.coordinateConverter.screenToCartesian3(e);o&&i.updateSubject.next({id:n,positions:i.getPositions(n),editMode:li.CREATE,updatedPosition:o,editAction:ui.MOUSE_MOVE})}),c.subscribe(function(t){var s=t.movement.endPosition;if(!a){var p=i.coordinateConverter.screenToCartesian3(s);if(p){var c=i.getPositions(n),u=0===i.getPositions(n).length,d={id:n,positions:c,editMode:li.CREATE,updatedPosition:p,editAction:ui.ADD_POINT};if(i.updateSubject.next(d),r.next(y({},d,{positions:i.getPositions(n),points:i.getPoints(n),width:i.getWidth(n)})),!u){var h={id:n,editMode:li.CREATE,editAction:ui.CHANGE_TO_EDIT};i.updateSubject.next(h),r.next(h),i.observablesMap.has(n)&&i.observablesMap.get(n).forEach(function(t){return t.dispose()}),i.observablesMap.delete(n),i.editHippodrome(n,e,r,o,l),a=!0}}}}),l},t.prototype.edit=function(t,e,i){if(void 0===e&&(e=Ki),void 0===i&&(i=100),2!==t.length)throw new Error("Hippodrome editor error edit(): polygon should have 2 positions but received "+t);var n=gi(),o=this.setOptions(e),r=new s.BehaviorSubject({id:n,editAction:null,editMode:li.EDIT}),a={id:n,positions:t,editMode:li.EDIT,editAction:ui.INIT,hippodromeOptions:o};return this.updateSubject.next(a),r.next(y({},a,{positions:this.getPositions(n),points:this.getPoints(n),width:this.getWidth(n)})),this.editHippodrome(n,i,r,o)},t.prototype.editHippodrome=function(t,e,i,n,o){var s,a=this;n.allowDrag&&(s=this.mapEventsManager.register({event:n.dragShapeEvent,entityType:Hi,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.id}}));var p=this.mapEventsManager.register({event:n.dragPointEvent,entityType:di,pick:U.PICK_FIRST,priority:e,pickFilter:function(e){return t===e.editedEntityId}});p.pipe(r.tap(function(t){var e=t.movement.drop;return a.cameraService.enableInputs(e)})).subscribe(function(e){var n=e.movement,o=n.endPosition,r=n.drop,s=e.entities,p=a.coordinateConverter.screenToCartesian3(o);if(p){var c=s[0],l={id:t,positions:a.getPositions(t),editMode:li.EDIT,updatedPosition:p,updatedPoint:c,editAction:r?ui.DRAG_POINT_FINISH:ui.DRAG_POINT};a.updateSubject.next(l),i.next(y({},l,{positions:a.getPositions(t),points:a.getPoints(t),width:a.getWidth(t)}))}}),s&&s.pipe(r.tap(function(t){var e=t.movement.drop;return a.cameraService.enableInputs(e)})).subscribe(function(e){var n=e.movement,o=n.startPosition,r=n.endPosition,s=n.drop,p=(e.entities,a.coordinateConverter.screenToCartesian3(r)),c=a.coordinateConverter.screenToCartesian3(o);if(p){var l={id:t,positions:a.getPositions(t),editMode:li.EDIT,updatedPosition:p,draggedPosition:c,editAction:s?ui.DRAG_SHAPE_FINISH:ui.DRAG_SHAPE};a.updateSubject.next(l),i.next(y({},l,{positions:a.getPositions(t),points:a.getPoints(t),width:a.getWidth(t)}))}});var c=[p];return s&&c.push(s),this.observablesMap.set(t,c),this.createEditorObservable(i,t)},t.prototype.setOptions=function(t){var e=JSON.parse(JSON.stringify(Ki)),i=Object.assign(e,t);return i.hippodromeProps=Object.assign({},Ki.hippodromeProps,t.hippodromeProps),i.pointProps=Object.assign({},Ki.pointProps,t.pointProps),i},t.prototype.createEditorObservable=function(t,e){var i=this;return t.dispose=function(){var t=i.observablesMap.get(e);t&&t.forEach(function(t){return t.dispose()}),i.observablesMap.delete(e),i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.CREATE_OR_EDIT,editAction:ui.DISPOSE})},t.enable=function(){i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.EDIT,editAction:ui.ENABLE})},t.disable=function(){i.updateSubject.next({id:e,positions:i.getPositions(e),editMode:li.EDIT,editAction:ui.DISABLE})},t.setManually=function(t,n,o,r,s){var a=new di(e,t,r||Ki.pointProps),p=new di(e,n,s||Ki.pointProps);i.hippodromeManager.get(e).setPointsManually([a,p],o),i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_MANUALLY})},t.setLabelsRenderFn=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.SET_EDIT_LABELS_RENDER_CALLBACK,labelsRenderFn:t})},t.updateLabels=function(t){i.updateSubject.next({id:e,editMode:li.CREATE_OR_EDIT,editAction:ui.UPDATE_EDIT_LABELS,updateLabels:t})},t.getCurrentPoints=function(){return i.getPoints(e)},t.getEditValue=function(){return t.getValue()},t.getLabels=function(){return i.hippodromeManager.get(e).labels},t.getCurrentWidth=function(){return i.getWidth(e)},t},t.prototype.getPositions=function(t){return this.hippodromeManager.get(t).getRealPositions()},t.prototype.getPoints=function(t){return this.hippodromeManager.get(t).getRealPoints()},t.prototype.getWidth=function(t){return this.hippodromeManager.get(t).getWidth()},t.decorators=[{type:e.Injectable}],t}();var $i=function(){function t(t,e,i,n,o){this.hippodromesEditor=t,this.coordinateConverter=e,this.mapEventsManager=i,this.cameraService=n,this.hippodromesManager=o,this.Cesium=Cesium,this.editPoints$=new s.Subject,this.editHippodromes$=new s.Subject,this.hippodromesEditor.init(this.mapEventsManager,this.coordinateConverter,this.cameraService,o),this.startListeningToEditorUpdates()}return t.prototype.startListeningToEditorUpdates=function(){var t=this;this.hippodromesEditor.onUpdate().subscribe(function(e){e.editMode===li.CREATE||e.editMode===li.CREATE_OR_EDIT?t.handleCreateUpdates(e):e.editMode===li.EDIT&&t.handleEditUpdates(e)})},t.prototype.getLabelId=function(t,e){return e.toString()},t.prototype.renderEditLabels=function(t,e,i){if(e.positions=t.getRealPositions(),e.points=t.getRealPoints(),i)return t.labels=i,void this.editHippodromesLayer.update(t,t.getId());this.editLabelsRenderFn&&(t.labels=this.editLabelsRenderFn(e,t.labels),this.editHippodromesLayer.update(t,t.getId()))},t.prototype.removeEditLabels=function(t){t.labels=[],this.editHippodromesLayer.update(t,t.getId())},t.prototype.handleCreateUpdates=function(t){switch(t.editAction){case ui.INIT:this.hippodromesManager.createEditableHippodrome(t.id,this.editPointsLayer,this.editHippodromesLayer,this.coordinateConverter,t.hippodromeOptions);break;case ui.MOUSE_MOVE:var e=this.hippodromesManager.get(t.id);t.updatedPosition&&(e.moveTempMovingPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.ADD_POINT:e=this.hippodromesManager.get(t.id);t.updatedPosition&&(e.addPoint(t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DISPOSE:(e=this.hippodromesManager.get(t.id)).dispose(),this.removeEditLabels(e);break;case ui.SET_EDIT_LABELS_RENDER_CALLBACK:e=this.hippodromesManager.get(t.id);this.editLabelsRenderFn=t.labelsRenderFn,this.renderEditLabels(e,t);break;case ui.UPDATE_EDIT_LABELS:case ui.SET_MANUALLY:e=this.hippodromesManager.get(t.id);this.renderEditLabels(e,t,t.updateLabels);break;default:return}},t.prototype.handleEditUpdates=function(t){switch(t.editAction){case ui.INIT:this.hippodromesManager.createEditableHippodrome(t.id,this.editPointsLayer,this.editHippodromesLayer,this.coordinateConverter,t.hippodromeOptions,t.positions);break;case ui.DRAG_POINT:(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.movePoint(t.updatedPosition,t.updatedPoint),this.renderEditLabels(e,t));break;case ui.DRAG_POINT_FINISH:(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.endMovePoint(),this.renderEditLabels(e,t));break;case ui.DISABLE:(e=this.hippodromesManager.get(t.id))&&(e.enableEdit=!1,this.renderEditLabels(e,t));break;case ui.ENABLE:(e=this.hippodromesManager.get(t.id))&&(e.enableEdit=!0,this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE:(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.moveShape(t.draggedPosition,t.updatedPosition),this.renderEditLabels(e,t));break;case ui.DRAG_SHAPE_FINISH:var e;(e=this.hippodromesManager.get(t.id))&&e.enableEdit&&(e.endMoveShape(),this.renderEditLabels(e,t));break;default:return}},t.prototype.ngOnDestroy=function(){this.hippodromesManager.clear()},t.prototype.getPointSize=function(t){return t.isVirtualEditPoint()?t.props.virtualPointPixelSize:t.props.pixelSize},t.prototype.getPointShow=function(t){return t.show&&(t.isVirtualEditPoint()?t.props.showVirtual:t.props.show)},t.decorators=[{type:e.Component,args:[{selector:"hippodrome-editor",template:'\n      <ac-layer #editHippodromesLayer acFor="let hippodrome of editHippodromes$" [context]="this">\n          <ac-corridor-desc props="{\n            positions: hippodrome.getRealPositionsCallbackProperty(),\n            cornerType: Cesium.CornerType.ROUNDED,\n            material: hippodrome.hippodromeProps.material,\n            width : hippodrome.hippodromeProps.width,\n            outline: hippodrome.hippodromeProps.outline,\n            outlineColor: hippodrome.hippodromeProps.outlineColor,\n            outlineWidth: hippodrome.hippodromeProps.outlineWidth,\n            height: 0,\n            classificationType: hippodrome.hippodromeProps.classificationType,\n            zIndex: hippodrome.hippodromeProps.zIndex,\n            shadows: hippodrome.hippodromeProps.shadows,\n    }">\n          </ac-corridor-desc>\n\n          <ac-array-desc acFor="let label of hippodrome.labels" [idGetter]="getLabelId">\n              <ac-label-primitive-desc props="{\n            position: label.position,\n            backgroundColor: label.backgroundColor,\n            backgroundPadding: label.backgroundPadding,\n            distanceDisplayCondition: label.distanceDisplayCondition,\n            eyeOffset: label.eyeOffset,\n            fillColor: label.fillColor,\n            font: label.font,\n            heightReference: label.heightReference,\n            horizontalOrigin: label.horizontalOrigin,\n            outlineColor: label.outlineColor,\n            outlineWidth: label.outlineWidth,\n            pixelOffset: label.pixelOffset,\n            pixelOffsetScaleByDistance: label.pixelOffsetScaleByDistance,\n            scale: label.scale,\n            scaleByDistance: label.scaleByDistance,\n            show: label.show,\n            showBackground: label.showBackground,\n            style: label.style,\n            text: label.text,\n            translucencyByDistance: label.translucencyByDistance,\n            verticalOrigin: label.verticalOrigin,\n            disableDepthTestDistance: label.disableDepthTestDistance,\n        }">\n              </ac-label-primitive-desc>\n          </ac-array-desc>\n      </ac-layer>\n\n      <ac-layer #editPointsLayer acFor="let point of editPoints$" [context]="this">\n          <ac-point-desc props="{\n         position: point.getPositionCallbackProperty(),\n         pixelSize: getPointSize(point),\n         color: point.props.color,\n         outlineColor: point.props.outlineColor,\n         outlineWidth: point.props.outlineWidth,\n         show: getPointShow(point),\n         disableDepthTestDistance: point.props.disableDepthTestDistance,\n         heightReference: point.props.heightReference,\n    }">\n          </ac-point-desc>\n      </ac-layer>\n  ',providers:[W,zi],changeDetection:e.ChangeDetectionStrategy.OnPush}]}],t.ctorParameters=function(){return[{type:Wi},{type:W},{type:bt},{type:B},{type:zi}]},t.propDecorators={editPointsLayer:[{type:e.ViewChild,args:["editPointsLayer",{static:!1}]}],editHippodromesLayer:[{type:e.ViewChild,args:["editHippodromesLayer",{static:!1}]}]},t}();var Yi=function(){function t(t,e){this.document=t,this.mapsManager=e,this.mainSubject=new s.Subject}return t.prototype.setCoordinateConverter=function(t){this.coordinateConverter=t},t.prototype.drag=function(t,e){var i=this;if(!this.coordinateConverter){var n=this.mapsManager.getMap();n&&(this.coordinateConverter=n.getCoordinateConverter())}this.cancel();var o=document.createElement("img");o.src=t,o.style.position="fixed",o.style.visibility="hidden",o.style.width="30px",o.style.height="30px",o.style["user-drag"]="none",o.style["user-select"]="none",o.style["-moz-user-select"]="none",o.style["-webkit-user-drag"]="none",o.style["-webkit-user-select"]="none",o.style["-ms-user-select"]="none",Object.assign(o.style,e),document.body.appendChild(o),this.createDragObservable(),this.dragObservable.subscribe(function(t){o.style.visibility="visible",o.style.left=t.screenPosition.x-o.clientWidth/2+"px",o.style.top=t.screenPosition.y-o.clientHeight/2+"px",i.mainSubject.next(t),t.drop&&o.remove()},function(t){o.remove()},function(){o.remove()})},t.prototype.dragUpdates=function(){return this.mainSubject},t.prototype.cancel=function(){this.stopper&&(this.stopper.next(!0),this.stopper=void 0,this.dragObservable=void 0)},t.prototype.createDragObservable=function(){var t,e,i,n=this,o=new s.Subject,a=new s.Subject,p=s.fromEvent(document,"pointerup"),c=s.fromEvent(document,"pointermove").pipe(r.map(function(o){return t=t||o.x,e=e||o.y,i={drop:!1,initialScreenPosition:{x:t,y:e},screenPosition:{x:o.x,y:o.y},mapPosition:n.coordinateConverter?n.coordinateConverter.screenToCartesian3({x:o.x,y:o.y}):void 0}}),r.takeUntil(p),r.tap(void 0,void 0,function(){if(i){var t=Object.assign({},i);t.drop=!0,a.next(t)}}));this.dragObservable=c.pipe(r.merge(a),r.takeUntil(o)),this.stopper=o},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:void 0,decorators:[{type:e.Inject,args:[i.DOCUMENT]}]},{type:Ct}]},t}();var Zi=function(){function t(t,e){this.iconDragService=e,t.nativeElement.style["user-drag"]="none",t.nativeElement.style["user-select"]="none",t.nativeElement.style["-moz-user-select"]="none",t.nativeElement.style["-webkit-user-drag"]="none",t.nativeElement.style["-webkit-user-select"]="none",t.nativeElement.style["-ms-user-select"]="none"}return t.prototype.ngOnInit=function(){"string"==typeof this.draggableToMap?this.src=this.draggableToMap:(this.src=this.draggableToMap.src,this.style=this.draggableToMap.style)},t.prototype.onMouseDown=function(){this.iconDragService.drag(this.src,this.style)},t.decorators=[{type:e.Directive,args:[{selector:"[draggableToMap]"}]}],t.ctorParameters=function(){return[{type:e.ElementRef},{type:Yi}]},t.propDecorators={draggableToMap:[{type:e.Input}],onMouseDown:[{type:e.HostListener,args:["mousedown"]}]},t}();var qi=function(){function t(t,i){this.element=t,this.cesiumService=i,this.allowDrag=!0,this.onDrag=new e.EventEmitter,this.dragStyle={"height.px":20,"width.px":20}}return t.prototype.ngOnInit=function(){this.cesiumService.getMap().getMapContainer().appendChild(this.element.nativeElement),this.allowDrag&&this.listenForDragging()},t.prototype.ngOnChanges=function(t){t.allowDrag&&t.allowDrag.currentValue&&!t.allowDrag.previousValue&&this.listenForDragging(),t.allowDrag&&!t.allowDrag.currentValue&&t.allowDrag.previousValue&&this.dragSubscription.unsubscribe()},t.prototype.ngOnDestroy=function(){this.dragSubscription&&this.dragSubscription.unsubscribe()},t.prototype.listenForDragging=function(){var t=this;this.mouseDown$=this.mouseDown$||s.fromEvent(this.element.nativeElement,"mousedown"),this.mouseMove$=this.mouseMove$||s.fromEvent(document,"mousemove"),this.mouseUp$=this.mouseUp$||s.fromEvent(document,"mouseup"),this.drag$=this.drag$||this.mouseDown$.pipe(r.switchMap(function(){return t.mouseMove$.pipe(r.tap(t.onDrag.emit),r.takeUntil(t.mouseUp$))})),this.dragSubscription=this.drag$.subscribe(function(e){t.element.nativeElement.style.left=e.x+"px",t.element.nativeElement.style.top=e.y+"px"})},t.decorators=[{type:e.Component,args:[{selector:"ac-toolbar",template:'\n        <div class="{{toolbarClass}}">\n            <div *ngIf="allowDrag">\n                <ac-toolbar-button>\n                    <ac-drag-icon></ac-drag-icon>\n                </ac-toolbar-button>\n            </div>\n\n            <ng-content></ng-content>\n        </div>\n    ',changeDetection:e.ChangeDetectionStrategy.OnPush,styles:["\n        :host {\n            position: absolute;\n            top: 20px;\n            left: 20px;\n            width: 20px;\n            height: 20px;\n            z-index: 999;\n            -webkit-user-drag: none;\n        }\n    "]}]}],t.ctorParameters=function(){return[{type:e.ElementRef},{type:P}]},t.propDecorators={toolbarClass:[{type:e.Input}],allowDrag:[{type:e.Input}],onDrag:[{type:e.Output}]},t}();var Xi=function(){function t(){}return t.decorators=[{type:e.Component,args:[{selector:"ac-drag-icon",template:'\n        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"  x="0px" y="0px"  height="25"  width="25"\n\t viewBox="0 0 476.737 476.737" style="enable-background:new 0 0 476.737 476.737;" xml:space="preserve">\n<g>\n\t<g>\n\t\t<path style="fill:#010002;" d="M475.498,232.298l-3.401-5.149l-63.565-63.565c-6.198-6.198-16.304-6.198-22.47,0\n\t\t\tc-6.198,6.198-6.198,16.273,0,22.47l36.423,36.423H254.26V54.253l36.423,36.423c6.166,6.198,16.273,6.198,22.47,0\n\t\t\tc6.166-6.198,6.166-16.273,0-22.47L249.588,4.64l-0.159-0.095l-4.99-3.305L238.369,0h-0.064l-6.007,1.24l-4.99,3.305l-0.191,0.095\n\t\t\tl-63.565,63.565c-6.198,6.198-6.198,16.273,0,22.47s16.273,6.198,22.47,0l36.455-36.423v168.225H54.253l36.423-36.423\n\t\t\tc6.198-6.198,6.198-16.273,0-22.47s-16.273-6.198-22.47,0L4.64,227.149l-0.095,0.159l-3.305,4.99L0,238.369v0.064l1.24,6.007\n\t\t\tl3.305,4.958l0.095,0.191l63.565,63.565c6.198,6.198,16.273,6.198,22.47,0c6.198-6.166,6.198-16.273,0-22.47L54.253,254.26\n\t\t\th168.225v168.225l-36.423-36.423c-6.198-6.166-16.273-6.166-22.47,0c-6.198,6.198-6.198,16.304,0,22.47l63.565,63.565l5.149,3.432\n\t\t\tl6.007,1.208h0.064l6.07-1.24l5.149-3.401l63.565-63.565c6.166-6.198,6.166-16.304,0-22.47c-6.198-6.198-16.304-6.198-22.47,0\n\t\t\tl-36.423,36.423V254.26h168.225l-36.423,36.423c-6.166,6.166-6.166,16.273,0,22.47c6.198,6.166,16.304,6.166,22.47,0\n\t\t\tl63.565-63.565l3.432-5.149l1.208-6.007v-0.064L475.498,232.298z"/>\n\t</g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n<g>\n</g>\n</svg>\n    '}]}],t.ctorParameters=function(){return[]},t}(),Ji=function(){function t(){this.onClick=new e.EventEmitter}return t.prototype.ngOnInit=function(){},t.decorators=[{type:e.Component,args:[{selector:"ac-toolbar-button",template:'\n        <div (click)="onClick.emit()" class="button-container {{buttonClass}}">\n            <img *ngIf="iconUrl" [src]="iconUrl" class="icon {{iconClass}}"/>\n            <ng-content></ng-content>\n        </div>\n    ',changeDetection:e.ChangeDetectionStrategy.OnPush,styles:["\n        .button-container {\n            border-radius: 1px;\n            background-color: rgba(255, 255, 255, 0.8);\n            height: 30px;\n            width: 30px;\n            padding: 5px;\n            transition: all 0.2s;\n            cursor: pointer;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            flex-direction: column;\n        }\n\n        .button-container:hover {\n            background-color: rgba(255, 255, 255, 0.95);\n        }\n\n        .icon {\n            height: 30px;\n            width: 30px;\n        }\n    "]}]}],t.ctorParameters=function(){return[]},t.propDecorators={iconUrl:[{type:e.Input}],buttonClass:[{type:e.Input}],iconClass:[{type:e.Input}],onClick:[{type:e.Output}]},t}();var Qi=function(){function t(t,e){this.polylineEditor=t,this.coordinateConverter=e,this.lineEditOptions={},this.labelsStyle={},this.distanceLabelsStyle={},this.bearingLabelsStyle={}}return t.prototype.create=function(t){var e=this,i=void 0===t?{lineEditOptions:{},labelsStyle:{},distanceLabelsStyle:{},bearingLabelsStyle:{}}:t,n=i.lineEditOptions,o=void 0===n?{}:n,r=i.labelsStyle,s=void 0===r?{}:r,a=i.distanceLabelsStyle,p=void 0===a?{}:a,c=i.bearingLabelsStyle,l=void 0===c?{}:c,u=i.bearingStringFn,d=i.distanceStringFn,h=i.labelsRenderFn,f=this.polylineEditor.create(y({allowDrag:!1,pointProps:{showVirtual:!1,pixelSize:8},polylineProps:{width:2}},this.lineEditOptions,o));return h?f.setLabelsRenderFn(h):this.labelsRenderFn?f.setLabelsRenderFn(this.labelsRenderFn):f.setLabelsRenderFn(function(t){var i=t.positions,n=0;return i&&0!==i.length?(t.editMode===li.CREATE&&t.editAction!==ui.ADD_LAST_POINT?m(i,[t.updatedPosition]):i).reduce(function(t,i,o,r){if(0!==o){var a=r[o-1],c=e.coordinateConverter.bearingToCartesian(a,i),h=Cesium.Cartesian3.distance(a,i)/1e3;t.push(y({text:u&&u(c)||e.bearingStringFn&&e.bearingStringFn(c)||c.toFixed(2)+"",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-20,-8),position:new Cesium.Cartesian3((i.x+a.x)/2,(i.y+a.y)/2,(i.z+a.z)/2),fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},e.labelsStyle,s,e.bearingLabelsStyle,l),y({text:d&&d(n+h)||e.distanceStringFn&&e.distanceStringFn(n+h)||(n+h).toFixed(2)+" Km",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-35,-8),position:i,fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},e.labelsStyle,s,e.distanceLabelsStyle,p)),n+=h}return t},[y({text:d&&d(0)||e.distanceStringFn&&e.distanceStringFn(0)||"0 Km",scale:.2,font:"80px Helvetica",pixelOffset:new Cesium.Cartesian2(-20,-8),position:i[0],fillColor:Cesium.Color.WHITE,outlineColor:Cesium.Color.WHITE,showBackground:!0},e.labelsStyle,s,e.distanceLabelsStyle,p)]):[]}),f},t.decorators=[{type:e.Component,args:[{selector:"range-and-bearing",template:"\n    <polylines-editor></polylines-editor>\n  ",changeDetection:e.ChangeDetectionStrategy.OnPush,providers:[Bi]}]}],t.ctorParameters=function(){return[{type:Bi},{type:W}]},t.propDecorators={lineEditOptions:[{type:e.Input}],labelsStyle:[{type:e.Input}],distanceLabelsStyle:[{type:e.Input}],bearingLabelsStyle:[{type:e.Input}],bearingStringFn:[{type:e.Input}],distanceStringFn:[{type:e.Input}],labelsRenderFn:[{type:e.Input}]},t}();var tn={LEFT:0,MIDDLE:1,RIGHT:2};tn[tn.LEFT]="LEFT",tn[tn.MIDDLE]="MIDDLE",tn[tn.RIGHT]="RIGHT";var en=function(){function t(t,e,i){this.mapsManager=t,this.mapsZoomElements=new Map,this.defaultOptions={animationDurationInSeconds:.5,resetKeyCode:27,borderStyle:"2px solid rgba(0,0,0,0.5)",backgroundColor:"rgba(0,0,0,0.2)",autoDisableOnZoom:!0,threshold:9,keepRotation:!0,mouseButton:tn.LEFT}}return t.prototype.init=function(t,e){this.cameraService=e,this.cesiumService=t},t.prototype.activate=function(t,e){var i=this;if(void 0===t&&(t={}),!(this.cameraService&&this.cesiumService||e))throw new Error("The function must receive a mapId if the service wasn't initialized");var n,o,r=Object.assign({},this.defaultOptions,t),s=this.cameraService;if(this.cesiumService&&(n=this.cesiumService.getViewer().container,o=this.cesiumService.getMap()),e){if(!(o=this.mapsManager.getMap(e)))throw new Error("Map not found with id: "+e);s=o.getCameraService(),n=o.getCesiumViewer().container}if(!s||!n)throw new Error("The function must receive a mapId if the service wasn't initialized");this.disable(e);var a=document.createElement("div");n.style.position="relative",a.style.position="absolute",a.style.width="100%",a.style.height="100%",a.style.top="0",a.style.left="0",n.appendChild(a);var p={container:a};this.mapsZoomElements.set(e||this.cesiumService.getMap().getId(),p);var c,l={endX:0,endY:0,startX:0,startY:0};a.onmousedown=function(e){if(e.button===r.mouseButton&&!c){t&&t.onStart&&t.onStart(o);var i=e.currentTarget.getBoundingClientRect(),n=e.clientX-i.left,s=e.clientY-i.top;l.startX=n,l.startY=s,(c=document.createElement("div")).className="zoom-to-rectangle-border",c.style.position="absolute",c.style.border=r.borderStyle,c.style.backgroundColor=r.backgroundColor,c.style.left=l.startX+"px",c.style.top=l.startY+"px",a.appendChild(c),p.borderElement=c}},a.onmouseup=function(t){if(c){var n=void 0;l&&Math.abs(l.endX-l.startX)*Math.abs(l.endY-l.startY)>r.threshold&&(n=i.zoomCameraToRectangle(s,l,r.animationDurationInSeconds,r)),c.remove(),c=void 0,p.borderElement=void 0,l={endX:0,endY:0,startX:0,startY:0},r.onComplete&&r.onComplete(o),r.autoDisableOnZoom&&n&&i.disable(e)}},a.onmousemove=function(t){if(c){var e=t.currentTarget.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;l.endX=i,l.endY=n,c.style.width=Math.abs(l.endX-l.startX)+"px",c.style.height=Math.abs(l.endY-l.startY)+"px",c.style.left=Math.min(l.startX,l.endX)+"px",c.style.top=Math.min(l.startY,l.endY)+"px"}};var u=function(t){t.keyCode===r.resetKeyCode&&c&&(c.remove(),c=void 0,p.borderElement=void 0,l={endX:0,endY:0,startX:0,startY:0})};document.addEventListener("keydown",u),p.resetOnEscapePressFunc=u},t.prototype.disable=function(t){if(!this.cesiumService&&!t)throw new Error("If the service was not initialized with CesiumService, mapId must be provided");var e=this.mapsZoomElements.get(t||this.cesiumService.getMap().getId());e&&(e.container.remove(),e.borderElement&&e.borderElement.remove(),e.resetOnEscapePressFunc&&document.removeEventListener("keydown",e.resetOnEscapePressFunc)),this.mapsZoomElements.delete(t)},t.prototype.zoomCameraToRectangle=function(t,e,i,n){var o=t.getCamera(),r=o.pickEllipsoid({x:e.startX,y:e.startY}),s=o.pickEllipsoid({x:e.endX,y:e.endY});if(!r||!s)return!1;var a=Cesium.Cartographic.fromCartesian(r),p=Cesium.Cartographic.fromCartesian(s);return t.cameraFlyTo({destination:new Cesium.Rectangle(Math.min(a.longitude,p.longitude),Math.min(a.latitude,p.latitude),Math.max(a.longitude,p.longitude),Math.max(a.latitude,p.latitude)),orientation:n.keepRotation?{heading:o.heading}:void 0,duration:i}),!0},t.decorators=[{type:e.Injectable}],t.ctorParameters=function(){return[{type:Ct},{type:B,decorators:[{type:e.Optional}]},{type:P,decorators:[{type:e.Optional}]}]},t}();var nn=function(){function t(){}return t.decorators=[{type:e.NgModule,args:[{imports:[i.CommonModule,ri],declarations:[$i,bi,Ti,Li,Ui,Zi,Xi,qi,Ji,Qi],exports:[$i,bi,Ti,Li,Ui,Zi,qi,Ji,Qi],providers:[Yi,en]}]}],t}();t.AcArcComponent=Ee,t.AcArcDescComponent=ce,t.AcArrayDescComponent=ti,t.AcBillboardComponent=qt,t.AcBillboardDescComponent=ee,t.AcBillboardPrimitiveDescComponent=Ge,t.AcBoxDescComponent=Ne,t.AcCircleComponent=be,t.AcCircleDescComponent=pe,t.AcCorridorDescComponent=Fe,t.AcCylinderDescComponent=je,t.AcDefaultPlonterComponent=_e,t.AcDynamicCircleDescComponent=Le,t.AcDynamicEllipseDescComponent=De,t.AcDynamicPolylineDescComponent=Me,t.AcEllipseComponent=ge,t.AcEllipseDescComponent=ie,t.AcEllipsoidDescComponent=ke,t.AcEntity=le,t.AcHtmlComponent=Pe,t.AcHtmlDescComponent=Xe,t.AcLabelComponent=fe,t.AcLabelDescComponent=se,t.AcLabelPrimitiveDescComponent=Ue,t.AcLayerComponent=Yt,t.AcMapComponent=St,t.AcMapLayerProviderComponent=he,t.AcNotification=ue,t.AcPointComponent=ve,t.AcPointDescComponent=ye,t.AcPolygonComponent=Se,t.AcPolygonDescComponent=Ce,t.AcPolylineComponent=me,t.AcPolylineDescComponent=ne,t.AcPolylinePrimitiveDescComponent=ze,t.AcPolylineVolumeDescComponent=He,t.AcPrimitivePolylineComponent=ii,t.AcRectangleDescComponent=Be,t.AcStaticCircleDescComponent=we,t.AcStaticEllipseDescComponent=Te,t.AcStaticPolygonDescComponent=Ae,t.AcStaticPolylineDescComponent=Oe,t.AcTileset3dComponent=xe,t.AcToolbarButtonComponent=Ji,t.AcToolbarComponent=qi,t.AcWallDescComponent=Ve,t.ActionType=Tt,t.AngularCesiumModule=ri,t.AngularCesiumWidgetsModule=nn,t.CameraService=B,t.CesiumEvent=G,t.CesiumEventModifier=ai,t.CesiumHeatMapMaterialCreator=ci,t.CesiumService=P,t.CircleEditorObservable=ji,t.CirclesEditorComponent=Ti,t.CirclesEditorService=Ii,t.ContextMenuService=z,t.CoordinateConverter=W,t.DEFAULT_CIRCLE_OPTIONS=Si,t.DEFAULT_ELLIPSE_OPTIONS=Ai,t.DEFAULT_HIPPODROME_OPTIONS=Ki,t.DEFAULT_POLYGON_OPTIONS=vi,t.DEFAULT_POLYLINE_OPTIONS=Vi,t.DisposableObservable=si,t.DraggableToMapDirective=Zi,t.DraggableToMapService=Yi,t.EditActions=ui,t.EditArc=Ei,t.EditModes=li,t.EditPoint=di,t.EditPolyline=hi,t.EditableCircle=Ci,t.EditableEllipse=Di,t.EditableHippodrome=Hi,t.EditablePolygon=fi,t.EditablePolyline=Oi,t.EditorObservable=Ri,t.EllipseEditorObservable=Fi,t.EllipsesEditorComponent=Li,t.EllipsesEditorService=wi,t.GeoUtilsService=Z,t.HippodromeEditorComponent=$i,t.HippodromeEditorObservable=ki,t.HippodromeEditorService=Wi,t.KeyboardAction=ct,t.KeyboardControlService=dt,t.MapEventsManagerService=bt,t.MapLayerProviderOptions=de,t.MapsManagerService=Ct,t.MouseButtons=tn,t.PREDEFINED_KEYBOARD_ACTIONS=lt,t.PickOptions=U,t.PixelOffsetPipe=oe,t.PlonterService=mt,t.PolygonEditorObservable=Ni,t.PolygonsEditorComponent=bi,t.PolygonsEditorService=Pi,t.PolylineEditorObservable=xi,t.PolylinesEditorComponent=Ui,t.PolylinesEditorService=Bi,t.RadiansToDegreesPipe=re,t.RangeAndBearingComponent=Qi,t.SceneMode=V,t.ScreenshotService=_t,t.SelectionManagerService=pi,t.ViewerConfiguration=v,t.ZoomToRectangleService=en,t.defaultLabelProps=yi,t.a=ae,t.b=g,t.ba=Bt,t.bb=Gt,t.bc=Ut,t.bd=zt,t.be=Kt,t.bf=Wt,t.bg=$t,t.bh=At,t.bi=wt,t.bj=Ot,t.bk=Lt,t.bl=Rt,t.bm=xt,t.bn=Nt,t.bo=Zt,t.bp=Xt,t.bq=te,t.br=Jt,t.bs=Re,t.bt=Qe,t.bu=ei,t.bv=Ye,t.bw=Ze,t.bx=qe,t.by=Je,t.bz=oi,t.c=tt,t.ca=Ie,t.cb=zi,t.cc=mi,t.cd=_i,t.ce=Mi,t.cf=Gi,t.cg=Xi,t.d=Q,t.e=$,t.f=X,t.g=ft,t.h=ot,t.i=at,t.j=pt,t.k=Y,t.l=nt,t.m=rt,t.n=q,t.o=et,t.p=st,t.q=Et,t.r=k,t.s=H,t.t=It,t.u=Dt,t.v=jt,t.w=Ft,t.x=kt,t.y=Ht,t.z=Vt,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=angular-cesium.umd.min.js.map